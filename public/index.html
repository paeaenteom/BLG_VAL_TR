<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BLG Tracker">
<meta name="theme-color" content="#07070c">
<meta name="referrer" content="no-referrer">
<meta name="mobile-web-app-capable" content="yes">
<title>BLG VALORANT ‚Äî Ïã§ÏãúÍ∞Ñ ÎåÄÏ†Ñ Í∏∞Î°ù</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2300d4ff'/%3E%3Cstop offset='100%25' stop-color='%230088ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='%230d1117'/%3E%3Crect x='2' y='2' width='60' height='60' rx='12' fill='none' stroke='url(%23g)' stroke-width='2.5'/%3E%3Ctext x='32' y='44' text-anchor='middle' font-family='Arial Black,sans-serif' font-weight='900' font-size='32' fill='url(%23g)'%3EBLG%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Orbitron:wght@400;500;700;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#07070c;--surface:#0f0f18;--s2:#161622;--s3:#1e1e30;--s4:#282840;--blue:#00a1d6;--blue-d:rgba(0,161,214,.15);--pink:#fb7299;--pink-d:rgba(251,114,153,.15);--win:#22c55e;--win-bg:rgba(34,197,94,.08);--win-b:rgba(34,197,94,.25);--loss:#ef4444;--loss-bg:rgba(239,68,68,.08);--loss-b:rgba(239,68,68,.25);--gold:#fbbf24;--gold-bg:rgba(251,191,36,.08);--gold-b:rgba(251,191,36,.25);--cyan:#06b6d4;--cyan-bg:rgba(6,182,212,.08);--cyan-b:rgba(6,182,212,.25);--txt:#e4e4f0;--dim:#8585a8;--dimmer:#4e4e6a;--brd:rgba(255,255,255,.05);--brd2:rgba(255,255,255,.08)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--txt);font-family:'Noto Sans KR',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.025'/%3E%3C/svg%3E");pointer-events:none;z-index:9999}

/* HERO */
.hero{position:relative;padding:48px 24px 28px;text-align:center;overflow:hidden}
.hero::before{content:'';position:absolute;top:-220px;left:50%;transform:translateX(-50%);width:900px;height:600px;background:radial-gradient(ellipse,rgba(0,161,214,.18),transparent 55%),radial-gradient(ellipse at 35% 55%,rgba(251,114,153,.14),transparent 50%);filter:blur(90px);pointer-events:none}
.badge{display:inline-flex;align-items:center;gap:8px;padding:5px 14px;border-radius:100px;background:var(--blue-d);border:1px solid rgba(0,161,214,.25);font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);margin-bottom:16px;animation:fi .5s ease}
.badge .dot{width:6px;height:6px;border-radius:50%;background:var(--blue);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.hero h1{font-family:'Orbitron',sans-serif;font-weight:900;font-size:clamp(28px,5.5vw,50px);letter-spacing:-1px;animation:fi .5s ease .05s both}
.hero h1 .blg{background:linear-gradient(135deg,var(--blue),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-size:13px;color:var(--dim);margin-top:10px;font-weight:300;animation:fi .5s ease .1s both}
.hero-sub strong{color:var(--txt);font-weight:500}
@keyframes fi{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* LIVE BAR */
.live-bar{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px;margin:0 auto 8px;max-width:600px;flex-wrap:wrap;animation:fi .5s ease .15s both}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--win);box-shadow:0 0 8px var(--win);animation:lp 1.5s infinite}
.live-dot.loading{background:var(--blue);box-shadow:0 0 8px var(--blue)}
.live-dot.error{background:var(--loss);box-shadow:0 0 8px var(--loss);animation:none}
.sync-badge{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--dim);display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;background:var(--s2);border:1px solid var(--s3)}
.sync-dot{width:6px;height:6px;border-radius:50%;display:inline-block}.sync-dot.syncing{background:#4d8bff;animation:lp 1s infinite}.sync-dot.done{background:var(--win)}.sync-dot.err{background:var(--loss)}
.sync-export-btn{background:none;border:none;cursor:pointer;font-size:11px;padding:0 2px;margin-left:2px;opacity:.6;transition:opacity .15s}.sync-export-btn:hover{opacity:1}
.export-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;animation:fi .15s}
.export-box{background:var(--bg);border:1px solid var(--accent-b);border-radius:12px;width:90%;max-width:700px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.export-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--s3);font-weight:700;color:var(--bright);font-size:14px}
.export-stats{display:flex;gap:8px;padding:8px 18px;font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.export-code{flex:1;min-height:300px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:10px;background:var(--surface);color:var(--dim);border:none;resize:none;outline:none;overflow:auto}
.export-actions{display:flex;gap:8px;padding:12px 18px;border-top:1px solid var(--s3);flex-wrap:wrap}
.export-btn{padding:8px 16px;border-radius:6px;border:1px solid var(--s3);background:var(--s2);color:var(--bright);font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .15s}
.export-btn:hover{background:var(--s3)}.export-btn.copy{border-color:rgba(0,229,160,.3);color:#00e5a0}.export-btn.dl{border-color:rgba(77,139,255,.3);color:#4d8bff}.export-btn.clear{border-color:rgba(255,77,106,.3);color:#ff4d6a;margin-left:auto}
.export-tabs{display:flex;gap:0;border-bottom:1px solid var(--s3)}.export-tab{flex:1;padding:10px 12px;background:none;border:none;color:var(--dim);font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .15s;border-bottom:2px solid transparent;text-transform:uppercase;letter-spacing:1px}.export-tab:hover{color:var(--bright);background:var(--s2)}.export-tab.active{color:var(--cyan);border-bottom-color:var(--cyan);background:var(--s2)}.export-tab .etcnt{font-size:9px;color:var(--dimmer);margin-left:4px}
@keyframes lp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.live-text{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim)}
.refresh-btn{padding:4px 12px;border-radius:6px;border:1px solid var(--brd2);background:transparent;color:var(--blue);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s}
.refresh-btn:hover{background:var(--blue-d);border-color:var(--blue)}
.refresh-btn:disabled{opacity:.4;cursor:not-allowed}
.spin-i{display:inline-block;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* STATS */
.stats-bar{display:flex;justify-content:center;gap:28px;padding:20px 24px;margin:0 auto 12px;max-width:750px;flex-wrap:wrap;animation:fi .5s ease .2s both}
.si{text-align:center}.sv{font-family:'Orbitron',sans-serif;font-size:26px;font-weight:700}
.sv.wc{color:var(--win)}.sv.lc{color:var(--loss)}.sv.bc{color:var(--blue)}
.sl{font-size:10px;color:var(--dimmer);text-transform:uppercase;letter-spacing:1.5px;margin-top:3px;font-family:'JetBrains Mono',monospace}

/* ===== UPCOMING SECTION ===== */
.upcoming-section{max-width:920px;margin:0 auto 28px;padding:0 24px;animation:fi .5s ease .25s both}
.upcoming-title{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.upcoming-title h2{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;color:var(--cyan)}
.upcoming-title .live-badge{font-size:9px;padding:3px 10px;border-radius:100px;background:var(--cyan-bg);border:1px solid var(--cyan-b);color:var(--cyan);font-family:'JetBrains Mono',monospace;letter-spacing:1px;text-transform:uppercase;animation:pulse 2s infinite}
.upcoming-card{padding:20px;border-radius:12px;background:linear-gradient(135deg,var(--surface),var(--s2));border:1px solid var(--cyan-b);position:relative;overflow:hidden;margin-bottom:8px}
.upcoming-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--cyan),var(--blue),var(--pink));border-radius:2px 2px 0 0}
.upcoming-card .uc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.uc-event{font-size:13px;font-weight:700;color:var(--txt)}
.uc-date{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--cyan)}
.uc-teams{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:14px}
.uc-team{text-align:center;min-width:80px}
.uc-team-name{font-family:'Orbitron',sans-serif;font-weight:700;font-size:16px;margin-bottom:2px}
.uc-team-name.blg{color:var(--blue)}
.uc-team-sub{font-size:10px;color:var(--dimmer);font-family:'JetBrains Mono',monospace}
.uc-vs{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;color:var(--dimmer)}
.uc-info{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
.uc-tag{font-size:10px;padding:3px 10px;border-radius:5px;background:var(--s3);color:var(--dim);font-family:'JetBrains Mono',monospace}
.uc-tag.tbd{background:var(--cyan-bg);color:var(--cyan);border:1px solid var(--cyan-b)}
/* countdown */
.countdown-row{display:flex;justify-content:center;gap:12px;margin-top:14px}
.cd-block{text-align:center;min-width:48px}
.cd-num{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;color:var(--cyan)}
.cd-label{font-size:9px;color:var(--dimmer);font-family:'JetBrains Mono',monospace;letter-spacing:1px;text-transform:uppercase}

/* Group preview */
.group-preview{margin-top:12px;padding:14px;border-radius:8px;background:var(--surface);border:1px solid var(--brd)}
.gp-title{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--dimmer);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.gp-title::before{content:'';width:12px;height:2px;background:var(--cyan);border-radius:1px}
.gp-teams{display:flex;gap:6px;flex-wrap:wrap}
.gp-team{font-size:11px;padding:4px 10px;border-radius:5px;background:var(--s3);color:var(--dim);font-family:'JetBrains Mono',monospace;transition:all .2s}
.gp-team.self{background:var(--blue-d);color:var(--blue);border:1px solid rgba(0,161,214,.3);font-weight:700}

/* YEAR TABS */
.year-tabs{display:flex;justify-content:center;gap:4px;padding:0 24px 24px;flex-wrap:wrap;animation:fi .5s ease .3s both}
.yt{padding:10px 28px;border-radius:10px;border:1px solid var(--brd);background:transparent;color:var(--dim);font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .25s;position:relative}
.yt:hover{border-color:rgba(0,161,214,.3);color:var(--blue)}
.yt.active{background:var(--blue-d);border-color:var(--blue);color:var(--blue)}
.yt .cnt{position:absolute;top:-6px;right:-6px;background:var(--pink);color:#fff;font-size:9px;padding:1px 6px;border-radius:10px;font-family:'JetBrains Mono',monospace}

/* MAIN */
.main{max-width:920px;margin:0 auto;padding:0 24px 60px}
.ys{display:none}.ys.active{display:block;animation:si .3s ease}
@keyframes si{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.yh{display:flex;align-items:center;gap:16px;margin-bottom:20px;padding:0 4px}
.yn{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;background:linear-gradient(180deg,var(--blue),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;opacity:.3;line-height:1}
.ysm{font-size:12px;color:var(--dim);font-family:'JetBrains Mono',monospace}.ysm span{font-weight:700}.ysm .w{color:var(--win)}.ysm .l{color:var(--loss)}
.tg{margin-bottom:28px}
.th{display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:0 2px;flex-wrap:wrap}
.tb{width:3px;height:20px;border-radius:2px;background:linear-gradient(180deg,var(--blue),var(--pink))}.tb.intl{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
.tn{font-size:13px;font-weight:700;letter-spacing:.3px}
.tbg{font-size:9px;padding:2px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;background:var(--s3);color:var(--dim)}.tbg.intl{background:rgba(251,191,36,.1);color:#fbbf24}

/* MATCH CARD */
.mw{margin-bottom:4px}
.mc{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;padding:14px 18px;padding-right:36px;border-radius:10px;background:var(--surface);border:1px solid var(--brd);transition:all .25s;cursor:pointer;position:relative}
.mw.open .mc{border-radius:10px 10px 0 0;border-bottom-color:transparent;background:var(--s2)}
.mc:hover{border-color:rgba(0,161,214,.2);background:var(--s2)}
.mc.win{border-left:3px solid var(--win)}.mc.loss{border-left:3px solid var(--loss)}
.ea{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--dimmer);transition:transform .35s cubic-bezier(.4,0,.2,1);width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--s3)}
.mw.open .ea{transform:translateY(-50%) rotate(180deg);background:var(--blue-d);color:var(--blue)}
.tl{display:flex;align-items:center;gap:10px;min-width:0}.tr{display:flex;align-items:center;gap:10px;justify-content:flex-end;min-width:0}
.tm{font-weight:700;font-size:14px}.tm.blg{color:var(--blue)}
.tt{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dimmer)}
.scc{text-align:center;min-width:76px}
.sc{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;letter-spacing:2px}
.sc .ws{color:var(--win)}.sc .ls{color:var(--loss)}.sc .sp{color:var(--dimmer);margin:0 3px;font-size:14px}
.sm{font-size:9px;color:var(--dimmer);font-family:'JetBrains Mono',monospace;margin-top:2px}
.rb{display:inline-block;padding:1px 8px;border-radius:3px;font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;margin-top:3px}
.rb.win{background:var(--win-bg);color:var(--win);border:1px solid var(--win-b)}.rb.loss{background:var(--loss-bg);color:var(--loss);border:1px solid var(--loss-b)}
.mr{grid-column:1/-1;display:flex;gap:5px;flex-wrap:wrap;margin-top:4px;justify-content:center}
.mp{font-size:9px;padding:2px 7px;border-radius:3px;font-family:'JetBrains Mono',monospace;background:var(--s3);color:var(--dim);cursor:pointer;position:relative;transition:transform .1s}.mp:hover{transform:translateY(-1px);filter:brightness(1.2)}.mp.mw2{color:var(--win);background:var(--win-bg)}.mp.ml2{color:var(--loss);background:var(--loss-bg)}
.map-agents-popup{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--accent-b);border-radius:10px;padding:8px 10px;z-index:100;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,.5);animation:mapPopIn .15s ease-out}
.map-agents-popup::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--accent-b)}
.ma-row{display:flex;align-items:center;gap:5px;padding:3px 0;white-space:nowrap}.ma-side{font-size:8px;font-weight:700;font-family:'Orbitron',sans-serif;padding:2px 5px;border-radius:3px;min-width:28px;text-align:center}
.ma-side.blg{background:rgba(0,229,160,.12);color:#00e5a0}.ma-side.opp{background:rgba(255,77,106,.12);color:#ff4d6a}
.ma-row img{width:24px;height:24px;border-radius:50%;transition:transform .15s}.ma-row img:hover{transform:scale(1.5);z-index:2}
.ma-loading{font-size:10px;color:var(--dim);white-space:nowrap;display:flex;align-items:center;gap:4px}
.ma-loading .dot-load{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink .8s infinite}
.ma-err{font-size:10px;color:var(--dimmer);text-align:center}
@keyframes mapPopIn{from{opacity:0;transform:translateX(-50%) translateY(4px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.sr{grid-column:1/-1;display:flex;justify-content:center;align-items:center;gap:8px;margin-top:2px}
.sb{font-size:10px;color:var(--dim);padding:2px 10px;border-radius:4px;background:var(--s3)}
.liq-tag{background:rgba(77,139,255,.1);color:#4d8bff;font-size:8px;padding:2px 5px}
.vod-btn{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:5px;background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.2);color:#ff6b6b;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600;text-decoration:none;transition:all .2s;letter-spacing:.3px;cursor:pointer}
.vod-btn:hover{background:rgba(255,0,0,.2);border-color:rgba(255,0,0,.35);color:#ff8a8a;transform:translateY(-1px)}

/* VOD MODAL */
.vod-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:10000;display:none;align-items:center;justify-content:center;animation:vodFi .25s ease}
.vod-overlay.active{display:flex}
@keyframes vodFi{from{opacity:0}to{opacity:1}}
.vod-modal{position:relative;width:90vw;max-width:960px;background:var(--s2);border:1px solid var(--brd2);border-radius:16px;overflow:hidden;box-shadow:0 40px 80px rgba(0,0,0,.6)}
.vod-modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--brd);background:var(--surface)}
.vod-modal-title{font-size:13px;font-weight:600;color:var(--txt);display:flex;align-items:center;gap:8px}
.vod-modal-title .vod-icon{font-size:16px}
.vod-close{width:32px;height:32px;border-radius:8px;border:1px solid var(--brd2);background:var(--s3);color:var(--dim);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.vod-close:hover{background:var(--loss-bg);border-color:var(--loss-b);color:var(--loss)}
.vod-body{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden}
.vod-body iframe{width:100%;height:100%;border:none}
.bili-parts{background:var(--s2);padding:10px 14px;border-top:1px solid var(--brd)}
.bili-parts-label{font-size:11px;color:var(--dim);margin-bottom:6px;padding-left:2px}
.bili-parts-list{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;scrollbar-width:thin}
.bili-parts-list::-webkit-scrollbar{height:4px}
.bili-parts-list::-webkit-scrollbar-thumb{background:var(--s4);border-radius:2px}
.bili-part-btn{flex-shrink:0;padding:6px 12px;border-radius:8px;border:1px solid var(--s4);background:var(--s3);color:var(--dim);font-size:11px;cursor:pointer;transition:all .2s;white-space:nowrap}
.bili-part-btn:hover{border-color:var(--cyan);color:var(--txt)}
.bili-part-btn.active{background:rgba(0,212,255,.15);border-color:var(--cyan);color:var(--cyan);font-weight:600}
.vod-loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--dim);font-size:13px}
.vod-spinner{width:36px;height:36px;border:3px solid var(--s4);border-top-color:var(--pink);border-radius:50%;animation:spin .7s linear infinite}
.vod-error{text-align:center;padding:8px 16px}
.vod-error a{color:var(--pink);text-decoration:underline}
.vod-match-info{padding:10px 20px;border-top:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.vod-match-label{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.vod-yt-link{font-size:11px;color:#ff6b6b;text-decoration:none;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:4px;transition:color .2s;padding:4px 10px;border-radius:6px;background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.15)}
.vod-yt-link:hover{color:#ff8a8a;background:rgba(255,0,0,.15)}
.vod-bili-link{font-size:11px;color:#00a1d6;text-decoration:none;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:4px;transition:color .2s;padding:4px 10px;border-radius:6px;background:rgba(0,161,214,.08);border:1px solid rgba(0,161,214,.15)}
.vod-bili-link:hover{color:#23c9ed;background:rgba(0,161,214,.15)}
.vod-links{display:flex;gap:8px;align-items:center}
.vod-platform-tabs{display:flex;gap:0;margin:0 20px;border-bottom:1px solid var(--brd)}
.vod-tab{padding:8px 16px;font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:none;background:none;color:var(--dim);border-bottom:2px solid transparent;transition:all .2s}
.vod-tab:hover{color:var(--txt)}
.vod-tab.active{color:#ff6b6b;border-bottom-color:#ff6b6b}
.vod-tab.bili.active{color:#00a1d6;border-bottom-color:#00a1d6}

/* DETAIL PANEL */
.dp{max-height:0;overflow:hidden;transition:max-height .45s cubic-bezier(.4,0,.2,1),opacity .3s;opacity:0}
.mw.open .dp{max-height:2200px;opacity:1}
.di{padding:20px;background:linear-gradient(180deg,var(--s2),var(--surface));border:1px solid var(--brd);border-top:1px dashed var(--brd2);border-radius:0 0 10px 10px}
/* Map detail */
.dms{margin-bottom:18px}.dmt{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--dimmer);text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.dmt::before{content:'';width:16px;height:2px;background:var(--blue);border-radius:1px}
.md{display:flex;align-items:center;gap:10px;padding:10px 14px;margin-bottom:3px;border-radius:8px;background:var(--surface);border:1px solid var(--brd);transition:background .2s;flex-wrap:wrap}
.md:hover{background:var(--s2)}
.md-n{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--dimmer);width:44px;text-align:center;flex-shrink:0}
.md-m{font-size:12px;font-weight:700;width:68px;flex-shrink:0}
.md-bw{flex:1;min-width:80px}.md-bar{flex:1;height:5px;border-radius:3px;background:var(--s4);overflow:hidden}
.md-bf{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1) .2s}
.md-bf.bw{background:linear-gradient(90deg,var(--win),#4ade80)}.md-bf.bl{background:linear-gradient(90deg,var(--loss),#f87171)}
.md-s{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;min-width:52px;text-align:center}.md-s .mws{color:var(--win)}.md-s .mls{color:var(--loss)}.md-s .msp{color:var(--dimmer);margin:0 2px;font-size:10px}
.md-r{font-size:9px;font-family:'Orbitron',sans-serif;font-weight:700;padding:2px 8px;border-radius:3px;min-width:32px;text-align:center}
.md-r.rw{background:var(--win-bg);color:var(--win);border:1px solid var(--win-b)}.md-r.rl{background:var(--loss-bg);color:var(--loss);border:1px solid var(--loss-b)}
.md-agents{width:100%;grid-column:1/-1;display:flex;gap:8px;margin-top:4px;padding:6px 8px;background:rgba(255,255,255,.02);border-radius:6px;border:1px solid var(--s3)}
.ag-row{display:flex;align-items:center;gap:4px;flex:1}.ag-side{font-size:9px;font-weight:700;font-family:'Orbitron',sans-serif;padding:2px 6px;border-radius:3px;min-width:32px;text-align:center}
.ag-side.blg{background:rgba(0,229,160,.1);color:#00e5a0}.ag-side.opp{background:rgba(255,77,106,.1);color:#ff4d6a}
.ag-row img{transition:transform .15s}.ag-row img:hover{transform:scale(1.4);z-index:2}.ag-name{font-size:9px;padding:2px 4px;background:var(--s3);border-radius:3px;color:var(--dim)}
.liq-veto{padding:8px 12px;margin-top:6px;background:var(--s2);border:1px solid var(--s3);border-radius:8px}
.veto-label{font-size:9px;font-weight:700;color:var(--dim);font-family:'Orbitron',sans-serif;letter-spacing:1px;display:block;margin-bottom:4px}
.veto-flow{display:flex;gap:4px;flex-wrap:wrap}.veto-step{display:flex;align-items:center;gap:3px;font-size:10px;padding:3px 6px;background:var(--s3);border-radius:4px}
.vact{color:#4d8bff;font-weight:600;font-family:'JetBrains Mono',monospace;font-size:9px}.vt1,.vt2{color:var(--dim)}
.liq-load-btn{cursor:pointer;background:rgba(77,139,255,.1)!important;border:1px solid rgba(77,139,255,.25)!important;color:#4d8bff!important;transition:all .15s;font-family:'JetBrains Mono',monospace!important;font-size:10px!important}
.liq-load-btn:hover{background:rgba(77,139,255,.2)!important;transform:translateY(-1px)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
/* Narrative */
.dn{padding:16px 18px;border-radius:8px;background:var(--surface);border:1px solid var(--brd)}
.dnt{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--blue);text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.dnt::before{content:'';display:inline-block;width:8px;height:8px;border-radius:2px;background:linear-gradient(135deg,var(--blue),var(--pink))}
.dtx{font-size:13px;line-height:1.8;color:var(--dim)}.dtx strong{color:var(--txt);font-weight:600}
.dmeta{display:flex;gap:6px;flex-wrap:wrap;margin-top:14px}
.mt{font-size:10px;padding:4px 10px;border-radius:5px;background:var(--s3);color:var(--dim);font-family:'JetBrains Mono',monospace}
.mt.mtwn{background:var(--win-bg);color:var(--win);border:1px solid var(--win-b)}.mt.mtls{background:var(--loss-bg);color:var(--loss);border:1px solid var(--loss-b)}.mt.mtil{background:var(--gold-bg);color:var(--gold);border:1px solid var(--gold-b)}

.loading-state{text-align:center;padding:60px 20px}.loader{width:40px;height:40px;border:3px solid var(--s3);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}.loading-text{color:var(--dimmer);font-size:13px}
.footer{text-align:center;padding:32px 24px;font-size:11px;color:var(--dimmer);border-top:1px solid var(--brd)}.footer a{color:var(--blue);text-decoration:none}

@media(max-width:600px){.mc{grid-template-columns:1fr;gap:6px;text-align:center;padding-right:36px}.tl,.tr{justify-content:center}.stats-bar{gap:16px}.sv{font-size:20px}.yn{font-size:36px}.yt{padding:8px 18px;font-size:12px}.md{flex-wrap:wrap;gap:6px}.md-bw{min-width:100%;order:10}.md-n{width:auto}.md-m{width:auto}.uc-teams{gap:12px}}
/* TEAM LOGOS */
.tlogo{width:24px;height:24px;object-fit:contain;border-radius:4px;flex-shrink:0;vertical-align:middle}
.tlogo.lg{width:32px;height:32px}
.tlogo.big{width:44px;height:44px;border-radius:6px}
.tlogo-ph.big{width:44px;height:44px;font-size:16px;border-radius:6px}
.tlogo.sm{width:18px;height:18px;border-radius:3px}
.tlogo-ph{display:inline-flex;align-items:center;justify-content:center;border-radius:4px;background:var(--s4);color:var(--dimmer);font-weight:700;font-family:'Orbitron',sans-serif;flex-shrink:0;vertical-align:middle}
.tlogo-ph{width:24px;height:24px;font-size:9px}
.tlogo-ph.lg{width:32px;height:32px;font-size:12px}
.tlogo-ph.sm{width:18px;height:18px;font-size:7px}
.gp-team img{vertical-align:middle;margin-right:4px}
/* PAGE NAV */
.page-nav{display:flex;gap:6px;padding:8px 16px;margin:0 auto 6px;max-width:600px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;justify-content:center}
.page-nav::-webkit-scrollbar{display:none}
.pn-btn{padding:8px 14px;border:1px solid var(--brd2);border-radius:10px;background:var(--surface);color:var(--dim);font-family:'Noto Sans KR',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;display:flex;align-items:center;gap:5px;white-space:nowrap;flex-shrink:0}
.pn-btn:hover{background:var(--s2);color:var(--txt)}
.pn-btn.active{background:linear-gradient(135deg,rgba(0,161,214,.15),rgba(251,114,153,.12));border-color:rgba(0,161,214,.35);color:var(--txt);font-weight:700}
.pn-btn .pn-icon{font-size:15px}
.page-view{display:none}.page-view.active{display:block}

/* SKINS SECTION */
.skins-wrap{max-width:900px;margin:0 auto;padding:0 16px 32px}
.skins-title{font-family:'Orbitron',sans-serif;font-size:clamp(18px,3vw,26px);font-weight:900;text-align:center;margin-bottom:6px;background:linear-gradient(135deg,var(--blue),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.skins-sub{text-align:center;font-size:12px;color:var(--dim);margin-bottom:24px}
.skins-sync{text-align:center;padding:6px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dimmer);display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:12px}
.skins-sync .ss-dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.skins-sync .ss-dot.loading{background:var(--blue);animation:pulse 1.5s infinite}
.skins-sync .ss-dot.done{background:var(--win)}
.skins-sync .ss-dot.err{background:var(--loss)}
.skins-grid{display:flex;flex-direction:column;gap:20px}
.skin-card{border-radius:16px;background:var(--surface);border:1px solid var(--brd2);overflow:hidden;transition:all .3s}
.skin-card:hover{border-color:rgba(0,161,214,.3);box-shadow:0 8px 40px rgba(0,161,214,.08)}
.skin-card.latest{border-color:rgba(0,161,214,.35);background:linear-gradient(160deg,var(--surface),rgba(0,161,214,.04))}
.skin-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;cursor:pointer;border-bottom:1px solid var(--brd);user-select:none}
.skin-header:hover{background:rgba(255,255,255,.02)}
.skin-year{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;color:var(--txt)}
.skin-hright{display:flex;align-items:center;gap:10px}
.skin-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 12px;border-radius:100px;text-transform:uppercase;letter-spacing:1.5px}
.skin-badge.current{background:var(--blue-d);color:var(--blue);border:1px solid rgba(0,161,214,.3)}
.skin-badge.past{background:var(--s3);color:var(--dim);border:1px solid var(--brd2)}
.skin-arrow{color:var(--dimmer);font-size:14px;transition:transform .25s}
.skin-card.open .skin-arrow{transform:rotate(180deg)}
/* Skin body: always visible preview */
.skin-preview{display:flex;align-items:center;gap:20px;padding:16px 20px}
.skin-img-wrap{flex:1.2;min-width:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse,rgba(0,161,214,.06),transparent 70%);border-radius:12px;padding:8px;min-height:160px}
.skin-img-wrap img{width:100%;max-height:240px;object-fit:contain;filter:drop-shadow(0 4px 24px rgba(0,161,214,.15));transition:transform .3s}
.skin-card:hover .skin-img-wrap img{transform:scale(1.04)}
.skin-info{flex:0 0 220px;display:flex;flex-direction:column;gap:6px}
.skin-name{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;color:var(--txt)}
.skin-detail{font-size:11px;color:var(--dim);line-height:1.6}
.skin-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px}
.sk-tag{font-size:10px;padding:3px 8px;border-radius:5px;font-family:'JetBrains Mono',monospace}
.sk-tag.price{background:var(--gold-bg);color:var(--gold);border:1px solid var(--gold-b)}
.sk-tag.rank{background:var(--cyan-bg);color:var(--cyan);border:1px solid var(--cyan-b)}
.sk-tag.contents{background:var(--s3);color:var(--dim)}
/* Expanded detail */
.skin-expand{max-height:0;overflow:hidden;transition:max-height .4s ease}
.skin-card.open .skin-expand{max-height:1200px}
.skin-detail-inner{padding:0 20px 20px}
/* Items grid */
.items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:14px}
.item-cell{background:var(--s2);border:1px solid var(--brd2);border-radius:10px;padding:10px;text-align:center;transition:all .25s}
.item-cell:hover{border-color:rgba(0,161,214,.3);background:var(--s3);transform:translateY(-2px)}
.item-img-box{aspect-ratio:1;border-radius:8px;overflow:hidden;background:linear-gradient(135deg,rgba(0,161,214,.06),rgba(255,255,255,.02));display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.item-img-box img{max-width:100%;max-height:100%;object-fit:contain}
.item-name{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.item-placeholder{font-size:11px;color:var(--dimmer);text-align:center;padding:10px}
.item-label{font-size:13px;font-weight:600;color:var(--txt);margin-bottom:10px}
/* Bundle items */
.bundle-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.bundle-item{flex:0 0 auto;display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:var(--s2);border:1px solid var(--brd)}
.bundle-item img{width:36px;height:36px;object-fit:contain;border-radius:4px}
.bundle-item span{font-size:10px;color:var(--dim)}
.skin-link{display:inline-flex;align-items:center;gap:4px;margin-top:10px;font-size:11px;color:var(--blue);text-decoration:none;font-family:'JetBrains Mono',monospace;opacity:.8;transition:opacity .2s}
.skin-link:hover{opacity:1}
@media(max-width:600px){.skin-preview{flex-direction:column}.skin-info{flex:none;width:100%}.skin-img-wrap{min-height:120px}}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--s4);border-radius:3px}
/* ===== NOTIFICATIONS ===== */
.notif-btn{background:var(--s3);border:1px solid var(--s4);border-radius:8px;padding:4px 10px;font-size:14px;cursor:pointer;transition:all .2s;color:var(--dim)}
.notif-btn:hover{border-color:var(--cyan)}
.notif-btn.on{border-color:var(--cyan);background:rgba(0,212,255,.1);color:var(--cyan)}
.notif-toast{position:fixed;top:20px;right:20px;background:var(--s2);border:1px solid var(--cyan);border-radius:12px;padding:14px 18px;z-index:9999;display:flex;align-items:center;gap:10px;box-shadow:0 8px 30px rgba(0,0,0,.5);animation:toastIn .4s ease;max-width:340px}
@keyframes toastIn{0%{transform:translateX(120%);opacity:0}100%{transform:translateX(0);opacity:1}}
.notif-toast.out{animation:toastOut .3s ease forwards}
@keyframes toastOut{0%{transform:translateX(0);opacity:1}100%{transform:translateX(120%);opacity:0}}
.notif-toast .nt-icon{font-size:24px;flex-shrink:0}
.notif-toast .nt-body{flex:1}
.notif-toast .nt-title{font-size:13px;font-weight:700;color:var(--txt)}
.notif-toast .nt-desc{font-size:11px;color:var(--dim);margin-top:2px}
.notif-toast .nt-close{background:none;border:none;color:var(--dim);font-size:16px;cursor:pointer;padding:0 0 0 8px}
/* ===== STATS PAGE ===== */
.stats-section{max-width:700px;margin:0 auto 20px}
.stats-section-title{font-size:15px;font-weight:700;color:var(--cyan);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:16px}
.stat-card{background:var(--s3);border:1px solid var(--s4);border-radius:10px;padding:12px;text-align:center}
.stat-card .sv{font-size:22px;font-weight:800;font-family:'Orbitron',sans-serif}
.stat-card .sl{font-size:10px;color:var(--dim);margin-top:2px;text-transform:uppercase}
.map-bar-wrap{margin-bottom:8px}
.map-bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px}
.map-bar-label .mn{color:var(--txt);font-weight:600}
.map-bar-label .mr{color:var(--dim)}
.map-bar{height:8px;border-radius:4px;background:var(--s4);overflow:hidden}
.map-bar-fill{height:100%;border-radius:4px;transition:width .8s ease}
.h2h-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--s3);border-radius:8px;margin-bottom:6px;border:1px solid var(--s4)}
.h2h-team{display:flex;align-items:center;gap:6px;min-width:90px}
.h2h-team .tm{font-size:13px;font-weight:700}
.h2h-record{flex:1;text-align:center;font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700}
.h2h-bar{flex:2;height:8px;border-radius:4px;background:var(--s4);overflow:hidden;display:flex}
.h2h-bar .hw{background:var(--win);height:100%;transition:width .6s}
.h2h-bar .hl{background:var(--loss);height:100%;transition:width .6s}
/* ===== ROSTER PAGE ===== */
.roster-year-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:0 auto 16px;max-width:700px;justify-content:center}
.roster-year-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--s4);background:var(--s3);color:var(--dim);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.roster-year-btn.active{background:var(--cyan);color:#000;border-color:var(--cyan)}
.roster-card{max-width:700px;margin:0 auto 12px;background:var(--s3);border:1px solid var(--s4);border-radius:12px;overflow:hidden}
.roster-header{padding:12px 16px;background:var(--s2);display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--s4)}
.roster-header .rh-year{font-size:18px;font-weight:800;font-family:'Orbitron',sans-serif;color:var(--cyan)}
.roster-header .rh-event{font-size:12px;color:var(--dim)}
.roster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;padding:14px}
.player-card{background:var(--s2);border:1px solid var(--s4);border-radius:10px;padding:12px 10px;text-align:center;transition:all .2s}
.player-card:hover{border-color:var(--cyan);transform:translateY(-2px)}
.player-card .p-role{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.player-card .p-name{font-size:15px;font-weight:800;color:var(--txt)}
.player-card .p-real{font-size:10px;color:var(--dim);margin-top:2px}
.player-card .p-flag{font-size:14px;margin-bottom:4px}
.player-card.coach{border-style:dashed;opacity:.8}
.player-card.sub{opacity:.7}
.roster-note{font-size:11px;color:var(--dimmer);padding:0 14px 10px;font-style:italic}
/* ===== STANDINGS PAGE ===== */
.standings-wrap{max-width:700px;margin:0 auto}
.standings-card{background:var(--s3);border:1px solid var(--s4);border-radius:12px;overflow:hidden;margin-bottom:14px}
.standings-title{padding:12px 16px;background:var(--s2);font-size:14px;font-weight:700;color:var(--cyan);border-bottom:1px solid var(--s4);display:flex;align-items:center;gap:8px}
.standings-table{width:100%;border-collapse:collapse}
.standings-table th{padding:8px 12px;font-size:10px;color:var(--dim);text-transform:uppercase;text-align:left;border-bottom:1px solid var(--s4)}
.standings-table td{padding:8px 12px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.03)}
.standings-table tr:last-child td{border-bottom:none}
.standings-table tr.blg-row{background:rgba(0,212,255,.06)}
.standings-table tr.blg-row td{font-weight:700;color:var(--cyan)}
.standings-table .rank-num{font-family:'Orbitron',sans-serif;font-weight:700;color:var(--dim);width:30px}
.standings-table .team-cell{display:flex;align-items:center;gap:8px}
.standings-table .record{font-family:'Orbitron',sans-serif}
.standings-note{padding:10px 16px;font-size:11px;color:var(--dimmer);border-top:1px solid var(--s4)}
.standings-updated{text-align:center;font-size:11px;color:var(--dimmer);margin-top:8px}
/* ===== LIVE MATCH BANNER ===== */
#liveBanner{margin:0 auto 16px;max-width:700px;border-radius:14px;overflow:hidden}
.live-match-banner{background:linear-gradient(135deg,#1a0a2e 0%,#2d1b4e 50%,#1a0a2e 100%);border:2px solid #ff4655;border-radius:14px;padding:16px 20px;position:relative;overflow:hidden;animation:livePulse 3s ease-in-out infinite}
@keyframes livePulse{0%,100%{border-color:#ff4655;box-shadow:0 0 20px rgba(255,70,85,.2)}50%{border-color:#ff6b7a;box-shadow:0 0 30px rgba(255,70,85,.35)}}
.live-match-banner::before{content:'';position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,70,85,.06),transparent);animation:liveShimmer 3s infinite}
.live-stream-wrap{margin:12px 0 4px;border-radius:10px;overflow:hidden;background:#000;animation:fi .3s ease}
@keyframes liveShimmer{0%{left:-100%}100%{left:200%}}
.live-top{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.live-dot-big{width:12px;height:12px;background:#ff4655;border-radius:50%;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.live-label{font-size:13px;font-weight:700;color:#ff4655;text-transform:uppercase;letter-spacing:1.5px}
.live-event{font-size:11px;color:var(--dim);margin-left:auto}
.live-teams{display:flex;align-items:center;justify-content:center;gap:16px}
.live-team{display:flex;align-items:center;gap:10px;flex:1}
.live-team.right{flex-direction:row-reverse;text-align:right}
.live-team-name{font-size:18px;font-weight:800;color:var(--txt)}
.live-team-full{font-size:11px;color:var(--dim)}
.live-vs{font-size:14px;font-weight:700;color:var(--dim);padding:0 4px}
.live-score-live{font-size:28px;font-weight:900;color:#ff4655;text-align:center;min-width:60px;letter-spacing:2px}
.live-links{display:flex;gap:8px;margin-top:12px;justify-content:center;flex-wrap:wrap}
.live-link{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;cursor:pointer;transition:all .2s}
.live-link.yt{background:rgba(255,0,0,.15);color:#ff4444;border:1px solid rgba(255,0,0,.25)}
.live-link.yt:hover{background:rgba(255,0,0,.25)}
.live-link.bili{background:rgba(0,161,214,.12);color:#00a1d6;border:1px solid rgba(0,161,214,.25)}
.live-link.bili:hover{background:rgba(0,161,214,.22)}
.live-link.twitch{background:rgba(145,70,255,.12);color:#9146ff;border:1px solid rgba(145,70,255,.25)}
.live-link.twitch:hover{background:rgba(145,70,255,.22)}
.live-link.vlr{background:rgba(255,255,255,.06);color:var(--dim);border:1px solid rgba(255,255,255,.1)}
/* New VOD badge */
.new-vod-badge{display:inline-block;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:rgba(0,161,214,.2);color:#00a1d6;margin-left:4px;vertical-align:middle;animation:newVodPop .5s ease}
@keyframes newVodPop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

/* ===== TRANSFER TIMELINE ===== */
.tf-section{max-width:700px;margin:20px auto 0}
.tf-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.tf-title{font-size:14px;font-weight:700;color:var(--txt);display:flex;align-items:center;gap:8px}
.tf-title::before{content:'';width:3px;height:16px;background:var(--cyan);border-radius:2px}
.tf-badge{font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(6,182,212,.1);color:var(--cyan);font-family:'JetBrains Mono',monospace}
.tf-year-filter{display:flex;gap:4px}
.tf-year-btn{font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--s4);background:var(--s3);color:var(--dim);cursor:pointer;transition:all .2s;font-family:inherit}
.tf-year-btn.active{background:var(--cyan);color:#000;border-color:var(--cyan);font-weight:600}
.tf-timeline{position:relative;padding-left:20px}
.tf-timeline::before{content:'';position:absolute;left:6px;top:0;bottom:0;width:2px;background:var(--s4);border-radius:1px}
.tf-item{position:relative;padding:10px 14px;margin-bottom:8px;background:var(--s3);border:1px solid var(--s4);border-radius:10px;transition:all .2s}
.tf-item:hover{border-color:var(--brd2);background:var(--s2)}
.tf-item::before{content:'';position:absolute;left:-17px;top:16px;width:10px;height:10px;border-radius:50%;border:2px solid var(--s4);background:var(--surface)}
.tf-item.join::before{border-color:var(--win);background:var(--win-bg)}
.tf-item.leave::before{border-color:var(--loss);background:var(--loss-bg)}
.tf-item.role::before{border-color:var(--blue);background:rgba(96,165,250,.15)}
.tf-item.promote::before{border-color:var(--cyan);background:rgba(6,182,212,.15)}
.tf-date{font-size:10px;color:var(--dimmer);font-family:'JetBrains Mono',monospace;margin-bottom:4px}
.tf-content{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.tf-type{font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0}
.tf-type.join{background:var(--win-bg);color:var(--win);border:1px solid var(--win-b)}
.tf-type.leave{background:var(--loss-bg);color:var(--loss);border:1px solid var(--loss-b)}
.tf-type.role{background:rgba(96,165,250,.1);color:var(--blue);border:1px solid rgba(96,165,250,.2)}
.tf-type.promote{background:rgba(6,182,212,.1);color:var(--cyan);border:1px solid rgba(6,182,212,.2)}
.tf-player{font-size:13px;font-weight:700;color:var(--txt)}
.tf-detail{font-size:12px;color:var(--dim)}
.tf-from{font-size:11px;color:var(--dimmer);font-style:italic}
.tf-empty{text-align:center;color:var(--dimmer);padding:30px;font-size:13px}
/* Opponent stats from Liquipedia */
.opp-section{margin-top:16px}
.opp-title{font-size:13px;font-weight:700;color:var(--txt);margin-bottom:8px;display:flex;align-items:center;gap:6px}
</style>
</head>
<body>

<div class="hero">
  <div class="badge"><span class="dot"></span>VALORANT ESPORTS ¬∑ LIVE TRACKER</div>
  <h1><span class="blg">BILIBILI GAMING</span></h1>
  <h1 style="font-size:clamp(16px,2.5vw,24px);margin-top:4px;color:var(--dim)">Ïã§ÏãúÍ∞Ñ ÎåÄÏ†Ñ Í∏∞Î°ù & Í≤∞Í≥º</h1>
  <p class="hero-sub"><strong>VCT China</strong> ¬∑ whz ¬∑ Knight ¬∑ nephh ¬∑ rushia ¬∑ bud</p>
</div>
<div class="live-bar"><span class="live-dot loading" id="liveDot"></span><span class="live-text" id="liveText">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...</span><span class="sync-badge" id="syncBadge"></span><button class="refresh-btn" id="refreshBtn" onclick="fetchLiveData()" disabled><span id="refreshIcon">‚Üª</span> ÏÉàÎ°úÍ≥†Ïπ®</button><button class="refresh-btn" id="vlrSyncBtn" onclick="vlrSync()" title="VLR.ggÏóêÏÑú ÏµúÏã† ÏóêÏù¥Ï†ÑÌä∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî">üì° ÏóêÏù¥Ï†ÑÌä∏ ÎèôÍ∏∞Ìôî</button><button class="notif-btn" id="notifBtn" onclick="toggleNotif()" title="ÏïåÎ¶º ÏÑ§Ï†ï"><span id="notifIcon">üîî</span></button></div>
<div class="stats-bar" id="statsBar"></div>

<!-- PAGE NAV -->
<div class="page-nav">
<button class="pn-btn active" data-page="matches" onclick="switchPage('matches')"><span class="pn-icon">‚öîÔ∏è</span>Í≤ΩÍ∏∞ Í∏∞Î°ù</button>
<button class="pn-btn" data-page="stats" onclick="switchPage('stats')"><span class="pn-icon">üìä</span>ÌÜµÍ≥Ñ</button>
<button class="pn-btn" data-page="roster" onclick="switchPage('roster')"><span class="pn-icon">üë§</span>Î°úÏä§ÌÑ∞</button>
<button class="pn-btn" data-page="standings" onclick="switchPage('standings')"><span class="pn-icon">üèÜ</span>ÏàúÏúÑ</button>

<button class="pn-btn" data-page="skins" onclick="switchPage('skins')"><span class="pn-icon">üî´</span>Ïä§ÌÇ®</button>
</div>

<!-- MATCHES VIEW -->
<div class="page-view active" id="view-matches">
<!-- LIVE BANNER -->
<div id="liveBanner" style="display:none"></div>
<!-- UPCOMING -->
<div class="upcoming-section" id="upcomingSection"></div>

<div class="year-tabs" id="yearTabs"></div>
<div class="main" id="main"><div class="loading-state"><div class="loader"></div><div class="loading-text">ÏµúÏã† Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§...</div></div></div>
</div>

<!-- STATS VIEW -->
<div class="page-view" id="view-stats">
<div id="statsView"></div>
</div>

<!-- ROSTER VIEW -->
<div class="page-view" id="view-roster">
<div id="rosterView"><div class="loading-state"><div class="loader"></div><div class="loading-text">Î°úÏä§ÌÑ∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§...</div></div></div>
</div>

<!-- STANDINGS VIEW -->
<div class="page-view" id="view-standings">
<div id="standingsView"><div class="loading-state"><div class="loader"></div><div class="loading-text">ÏàúÏúÑ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§...</div></div></div>
</div>

<!-- SKINS VIEW -->
<div class="page-view" id="view-skins">
<div class="skins-wrap" id="skinsWrap"></div>
</div>
<div class="footer">Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ¬∑ <a href="https://vlr.gg/team/12498/bilibili-gaming" target="_blank">VLR.gg</a> ¬∑ <a href="https://liquipedia.net/valorant/Bilibili_Gaming" target="_blank">Liquipedia</a> ¬∑ <a href="https://www.youtube.com/@VALORANTEsportsCN" target="_blank">YouTube</a> ¬∑ <a href="https://space.bilibili.com/2071691173" target="_blank">BÁ´ô (Êó†ÁïèÂ•ëÁ∫¶Ëµõ‰∫ã)</a></div>

<script src="vlr-agents.js"></script>
<script>

// ===== UNIVERSAL FETCH (Vercel ÏûêÏ≤¥ ÌîÑÎ°ùÏãú + fallback) =====
const OWN_PROXY=url=>`/api/proxy?url=${encodeURIComponent(url)}`;
const CORS_PROXIES=[
  OWN_PROXY,
  url=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];
async function proxyFetch(url,timeout=8000){
  // Try each proxy (own first, then fallbacks)
  for(const proxy of CORS_PROXIES){
    try{const r=await fetch(proxy(url),{signal:AbortSignal.timeout(timeout)});if(r.ok)return await r.text()}catch(e){}
  }
  // Last resort: direct (works if API has CORS headers)
  try{const r=await fetch(url,{signal:AbortSignal.timeout(timeout)});if(r.ok)return await r.text()}catch(e){}
  return null;
}
async function proxyFetchJSON(url,timeout=8000){
  const t=await proxyFetch(url,timeout);if(!t)return null;
  try{return JSON.parse(t)}catch(e){return null}
}

// ===== TEAM LOGOS (VALORANT Esports / static.lolesports.com) =====
const VE="https://am-a.akamaihd.net/image?resize=96:&f=http%3A%2F%2Fstatic.lolesports.com%2Fteams%2F";
const LOGOS={
  // VCT CN
  BLG:VE+"1707126028220_BLG.png",
  EDG:VE+"1735920597800_edg1.png",
  XLG:VE+"1735920774181_XLGA.PNG",
  DRG:VE+"1707126143797_DRG.png",
  WOL:VE+"1707126969882_WOL.png",
  TE:VE+"1736345448590_TE.png",
  FPX:VE+"1644542485597_download38.png",
  TYL:VE+"1768990500116_TYLLOGO.png",
  NOVA:VE+"1741178535000_NOVA.png",
  NV:VE+"1741178535000_NOVA.png",
  TEC:VE+"1707127134615_TEC.png",
  TITAN:VE+"1707127134615_TEC.png",
  AG:VE+"1707126806655_AG.png",
  JDG:VE+"1707126862498_JDG.png",
  // VCT Americas
  G2:VE+"1675329807714_G2-Esports-Logo1.png",
  SEN:VE+"1739254422982_sent.png",
  NRG:VE+"1731490666442_NRGWHT.png",
  MIBR:VE+"1648844013086_mibr_white-logo.png",
  C9:VE+"1725635348011_C9-Logo.png",
  EG:VE+"1731490673901_VintageEG.png",
  "100T":VE+"1644966311613_100TVAL.png",
  LOUD:VE+"1644060140569_LOUDGreen.png",
  FURIA:VE+"1644059765262_FURIA-LOGO.png",
  LEV:VE+"1644148043034_Leviatncolor.png",
  // VCT EMEA
  TL:VE+"1637252586938_teamliquid.png",
  FNC:VE+"1644542427486_download37.png",
  KC:VE+"1651626649157_download1.png",
  NAVI:VE+"1627386036528_Natus_Vincere_2021_lightmode.png",
  VIT:VE+"1722030793680_VITALITY_YELLOW.png",
  // VCT Pacific
  PRX:VE+"1630018120582_paper-rex-2021.png",
  T1:VE+"1677137430839_T1_infoboximage1.png",
  RRQ:VE+"1707306458590_LOGO_RRQ_orange.png",
  DRX:VE+"1705652820016_DRXwhite.png",
  GEN:VE+"1678453609404_GenG_logo_200407-051.png",
  NS:VE+"1674219422693_NS_.png",
  DFM:VE+"1675669923678_190px-DetonatioN_FocusMe_2022_darkmode1.png",
  // Teams without hardcoded logos (filled by Riot Esports API or SVG fallback)
  KR√ú:VE+"1630017626481_kru.png",
  // Minor/defunct teams ‚Äî VLR.gg owcdn ÌïòÎìúÏΩîÎî©
  LGD:'',
  RNG:'',
  WBG:'',
  NIP:'',
  ASE:'',
  NWG:'',
  ME:'',
  iG:'',
  iNv:'',
  NTER:'',
  TTG:'',
  RA:'',
  '4AM':'',
  NOP:'',
  JJH:'',
  NH:'',
  KZ:'',
  GK:'',
  DYG:'',
  VLG:'',O3O:'',
  TES:'',
};
// Generate SVG text logo for teams without images
function _tsvg(tag,bg='#333',fg='#fff'){
  const sz=tag.length>3?10:12;
  return`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="40" height="40" rx="8" fill="${bg}"/><text x="20" y="24" text-anchor="middle" font-family="Arial" font-weight="bold" font-size="${sz}" fill="${fg}">${tag}</text></svg>`)}`;
}
// Fill empty logos with SVG initially (Riot Esports API will replace with real logos)
const _LOGO_COLORS={KR√ú:'#5b21b6',LGD:'#dc2626',RNG:'#eab308',WBG:'#3b82f6',NIP:'#f59e0b',ASE:'#10b981',NWG:'#6366f1',ME:'#ec4899',Wolves:'#f97316',TBD:'#555',iG:'#b91c1c',iNv:'#059669',NTER:'#0284c7',TTG:'#7c3aed',RA:'#dc2626','4AM':'#eab308',NOP:'#6b7280',JJH:'#f59e0b',NH:'#2563eb',KZ:'#4f46e5',GK:'#14b8a6',DYG:'#f97316',VLG:'#8b5cf6',O3O:'#06b6d4'};
Object.keys(LOGOS).forEach(k=>{if(!LOGOS[k])LOGOS[k]=_tsvg(k,_LOGO_COLORS[k]||'#333')});
// Proxy wikia images via wsrv.nl to avoid hotlink blocking
function pImg(url){if(!url)return'';if(url.includes('wikia.nocookie.net'))return'https://wsrv.nl/?url='+encodeURIComponent(url)+'&default=1';return url}
function L(tag,sz=''){const u=LOGOS[tag]||logoCache[tag];if(u&&u!=='pending'&&u!==false)return`<img src="${u}" class="tlogo ${sz}" alt="${tag}" onerror="this.outerHTML='<span class=\\'tlogo-ph ${sz}\\'>${tag[0]}</span>'">`;if(!LOGOS[tag]&&!logoCache[tag])fetchTeamLogo(tag);return`<span class="tlogo-ph ${sz}">${tag[0]||'?'}</span>`}
const TAG_DISPLAY={NV:'NOVA'};
function DT(tag){return TAG_DISPLAY[tag]||tag}

// ===== RIOT ESPORTS API (valorantesports.com - free, no CORS!) =====
const RIOT_ESPORTS_BASE='https://esports-api.service.valorantesports.com/persisted/val';
const RIOT_ESPORTS_KEY='0TvQnueqKa5mxJntVWt0w4LpLfEkrV1Ta8rQBb9Z';
const VCT_CN_LEAGUE_ID='111691194187846945';
let riotScheduleCache=null;
let riotScheduleTime=0;

async function riotEsportsFetch(endpoint, params={}){
  params.hl=params.hl||'en-US'; params.sport='val';
  const qs=new URLSearchParams(params).toString();
  const url=`${RIOT_ESPORTS_BASE}/${endpoint}?${qs}`;
  // Use own proxy (handles x-api-key server-side)
  for(const proxy of CORS_PROXIES){
    try{const r=await fetch(proxy(url),{signal:AbortSignal.timeout(10000)});if(r.ok)return await r.json()}catch(e){}
  }
  return null;
}

async function getRiotSchedule(forceRefresh=false){
  const now=Date.now();
  if(!forceRefresh && riotScheduleCache && (now-riotScheduleTime)<3*60*1000) return riotScheduleCache;
  const d=await riotEsportsFetch('getSchedule',{leagueId:VCT_CN_LEAGUE_ID});
  if(d&&d.data?.schedule?.events){
    riotScheduleCache=d.data.schedule.events;
    riotScheduleTime=now;
    // Cache official logos from API
    riotScheduleCache.forEach(ev=>{
      (ev.match?.teams||[]).forEach(t=>{
        if(t.code && t.image){
          const aliases=[t.code,{KRU:'KR√ú',Wolves:'WOL',TITAN:'TEC'}[t.code]].filter(Boolean);
          aliases.forEach(c=>{if(!LOGOS[c]||LOGOS[c].startsWith('data:')){LOGOS[c]=t.image;logoCache[c]=t.image}});
        }
      });
    });
  }
  return riotScheduleCache||[];
}

function isBLGTeam(team){return team.code==='BLG'||team.name?.includes('Bilibili')}

// Fetch ALL VCT team logos from Riot Esports API (getSchedule has all teams with images)
async function fetchRiotTeamLogos(){
  // Riot API code ‚Üí our code mapping (handles special chars, aliases)
  const CODE_ALIAS={KRU:'KR√ú',KRUE:'KR√ú',Wolves:'WOL',TITAN:'TEC'};
  function applyLogo(code,image){
    const targets=[code,CODE_ALIAS[code]].filter(Boolean);
    targets.forEach(c=>{
      if(!LOGOS[c]||LOGOS[c].startsWith('data:')){
        LOGOS[c]=image;
        logoCache[c]=image;
        document.querySelectorAll(`img.tlogo[alt="${c}"]`).forEach(el=>{if(el.src.startsWith('data:'))el.src=image});
        document.querySelectorAll('span.tlogo-ph').forEach(el=>{
          if(el.textContent===(c[0]||''))el.outerHTML=`<img src="${image}" class="tlogo" alt="${c}" onerror="this.outerHTML='<span class=\\'tlogo-ph\\'>${c[0]}</span>'">`});
      }
    });
  }
  try{
    // VCT league IDs
    const leagueIds=['111691194187846945','111688766498498302','111688766498498301','111688766498498300']; // CN, Americas, EMEA, Pacific
    // Method 1: getSchedule (most reliable - has match team data)
    for(const lid of leagueIds){
      const d=await riotEsportsFetch('getSchedule',{leagueId:lid});
      if(d?.data?.schedule?.events){
        d.data.schedule.events.forEach(ev=>{
          (ev.match?.teams||[]).forEach(t=>{
            if(t.code&&t.image)applyLogo(t.code,t.image);
          });
        });
      }
      await new Promise(r=>setTimeout(r,500));
    }
    const filled=Object.keys(LOGOS).filter(k=>LOGOS[k]&&!LOGOS[k].startsWith('data:')).length;
    console.log(`üñºÔ∏è Riot Esports API: ${filled}Í∞ú ÌåÄ Î°úÍ≥† Î°úÎìú`);

    // Phase 2: Liquipedia fallback ‚Äî deferred until after autoSync to avoid 429
    // fetchLiquipediaLogos() is called separately via fetchLiquipediaLogosDeferred
  }catch(e){console.log('Team logo fetch failed:',e.message)}
}
function fetchLiquipediaLogosDeferred(){console.log('üñºÔ∏è LP Î°úÍ≥†: Î™®Îì† ÌåÄ ÌïòÎìúÏΩîÎî©Îê® ‚Äî Ïä§ÌÇµ')}

// Liquipedia commons API ‚Üí proxyÎ°ú Ïù¥ÎØ∏ÏßÄ ÏÑúÎπô (403 Ïö∞Ìöå)
async function fetchLiquipediaLogos(){
  let rateLimited=false;
  const lpFetch=async(url)=>{if(rateLimited)return null;const r=await proxyFetchJSON(url);if(!r){rateLimited=true;console.log('üñºÔ∏è LP 429 Í∞êÏßÄ ‚Äî Î°úÍ≥† Î≥¥ÏôÑ Ï§ëÎã®');return null}return r};
  // tag ‚Üí [ÌååÏùºÎ™Ö prefix, ÌéòÏù¥ÏßÄÎ™Ö] (Liquipedia Í∑úÏπô)
  const LP_NAME={
    LGD:'LGD_Gaming',RNG:'Royal_Never_Give_Up',
    WBG:'Weibo_Gaming',NIP:'Ninjas_in_Pyjamas',ASE:'Attacking_Soul_Esports',
    NWG:'Night_Wings_Gaming',ME:'Monarch_Effect',
    BLG:'Bilibili_Gaming',EDG:'EDward_Gaming',FPX:'FunPlus_Phoenix',
    DRG:'Dragon_Ranger_Gaming',WOL:'Wolves_Esports',TE:'Trace_Esports',
    TYL:'TYLOO',NOVA:'Nova_Esports',NV:'Nova_Esports',TEC:'Titan_Esports_Club',
    AG:'AG_Esports',JDG:'JD_Gaming',G2:'G2_Esports',SEN:'Sentinels',
    NRG:'NRG_Esports',MIBR:'MIBR',C9:'Cloud9',EG:'Evil_Geniuses',
    LOUD:'LOUD',FURIA:'FURIA_Esports',LEV:'Leviatan',
    TL:'Team_Liquid',FNC:'Fnatic',KC:'Karmine_Corp',NAVI:'Natus_Vincere',
    VIT:'Team_Vitality',PRX:'Paper_Rex',T1:'T1',DRX:'DRX',GEN:'Gen.G',
    RRQ:'Rex_Regum_Qeon',NS:'Nongshim_RedForce',DFM:'DetonatioN_FocusMe',
    '100T':'100_Thieves',XLG:'XLGA',Wolves:'Wolves_Esports',
    iG:'Invictus_Gaming',RA:'Rare_Atom',
    iNv:'Invincible_Gaming',NTER:'Shenzhen_NTER',TTG:'Totoro_Gaming',
    '4AM':'Four_Angry_Men',NOP:'Number_One_Player',JJH:'JiJieHao',
    NH:'NewHappy',KZ:'Kingzone',GK:'Gank_Gaming',
    DYG:'Douyu_Gaming',VLG:'VLG_Esports',O3O:'Oxyg3niOus'
  };
  // ÌéòÏù¥ÏßÄÎ™ÖÏù¥ ÌååÏùºÎ™ÖÍ≥º Îã§Î•∏ ÌåÄ (ÌäπÏàòÎ¨∏Ïûê Îì±)
  const LP_PAGE={LEV:'Leviat√°n'};
  // Only fetch for teams still using SVG data URIs
  const svgTeams=Object.keys(LOGOS).filter(k=>LOGOS[k].startsWith('data:')&&LP_NAME[k]);
  if(!svgTeams.length){console.log('üñºÔ∏è Liquipedia: Î≥¥ÏôÑ ÌïÑÏöî ÏóÜÏùå');return}
  console.log(`üñºÔ∏è Liquipedia: ${svgTeams.length}Í∞ú ÌåÄ Î°úÍ≥† Î≥¥ÏôÑ ÏãúÎèÑ (${svgTeams.join(', ')})`);

  // valorant wiki API ÏÇ¨Ïö© (commonsÎäî 403 Ï∞®Îã®Îê®, valorantÏùÄ Î°úÏä§ÌÑ∞ÏóêÏÑú Í≤ÄÏ¶ùÎê®)
  const VALWIKI='https://liquipedia.net/valorant/api.php';
  for(const tag of svgTeams){
    if(rateLimited)break;
    const prefix=LP_NAME[tag];
    if(!prefix)continue;
    try{
      // Method 1: imageinfoÎ°ú ÏòàÏÉÅ ÌååÏùºÎ™Ö ÏßÅÏ†ë Ï°∞Ìöå
      const suffixes=['_allmode.png','_darkmode.png','_full_allmode.png','_full_darkmode.png','_lightmode.png'];
      // ÎåÄÏïà prefixÎèÑ ÏãúÎèÑ (KR√ú‚ÜíKRU + KR√ú Îëò Îã§)
      const prefixes=[prefix];
      if(LP_PAGE[tag]){const alt=LP_PAGE[tag].replace(/ /g,'_');if(alt!==prefix)prefixes.push(alt)}
      const titles=prefixes.flatMap(p=>suffixes.map(s=>`File:${p}${s}`)).join('|');
      const d=await lpFetch(`${VALWIKI}?action=query&titles=${encodeURIComponent(titles)}&prop=imageinfo&iiprop=url&iiurlwidth=96&format=json`);
      
      if(d?.query?.pages){
        const pages=Object.values(d.query.pages).filter(p=>p.pageid>0&&p.imageinfo?.length);
        const missing=Object.values(d.query.pages).filter(p=>p.missing!==undefined).map(p=>p.title);
        if(!pages.length)console.log(`üñºÔ∏è LP M1 miss: ${tag} ‚Äî ÏóÜÎäî ÌååÏùº: ${missing.slice(0,3).join(', ')}...`);
        if(pages.length){
          // Ïö∞ÏÑ†ÏàúÏúÑ: allmode > darkmode > full > lightmode
          pages.sort((a,b)=>{
            const score=n=>{
              if(!n)return 9;
              if(n.includes('_allmode'))return 0;
              if(n.includes('_darkmode'))return 1;
              if(n.includes('_full_allmode'))return 2;
              if(n.includes('_full_darkmode'))return 3;
              return 4;
            };
            return score(a.title)-score(b.title);
          });
          const imgUrl=pages[0].imageinfo[0].thumburl||pages[0].imageinfo[0].url;
          const proxiedUrl=OWN_PROXY(imgUrl);
          LOGOS[tag]=proxiedUrl;
          logoCache[tag]=proxiedUrl;
          document.querySelectorAll(`img.tlogo[alt="${tag}"]`).forEach(el=>{if(el.src.startsWith('data:'))el.src=proxiedUrl});
          document.querySelectorAll('span.tlogo-ph').forEach(el=>{
            if(el.textContent===(tag[0]||''))el.outerHTML=`<img src="${proxiedUrl}" class="tlogo" alt="${tag}" onerror="this.outerHTML='<span class=\\'tlogo-ph\\'>${tag[0]}</span>'">`});
          console.log(`üñºÔ∏è Liquipedia Î≥¥ÏôÑ: ${tag} ‚Üê ${pages[0].title}`);
          await new Promise(r=>setTimeout(r,5000));
          continue;
        }
      }

      // Method 2: ÌåÄ Ïù∏Ìè¨Î∞ïÏä§ÏóêÏÑú Ï†ïÌôïÌïú Î°úÍ≥† ÌååÏùºÎ™Ö Ï∂îÏ∂ú (Í∞ÄÏû• Ï†ïÌôï)
      const teamPage=(LP_PAGE[tag]||prefix).replace(/_/g,' ');
      const d2=await lpFetch(`${VALWIKI}?action=parse&page=${encodeURIComponent(teamPage)}&prop=wikitext&section=0&format=json`);
      if(d2?.parse?.wikitext){
        const wt=typeof d2.parse.wikitext==='object'?d2.parse.wikitext['*']:d2.parse.wikitext;
        // |image= ÎòêÎäî |image1= ÏóêÏÑú Î°úÍ≥† ÌååÏùºÎ™Ö Ï∂îÏ∂ú
        const imgMatch=wt.match(/\|\s*image\d?\s*=\s*([^\n|]+)/i);
        if(imgMatch){
          const logoFile=imgMatch[1].trim();
          console.log(`üñºÔ∏è LP M2 Ïù∏Ìè¨Î∞ïÏä§: ${tag} ‚Üí ${logoFile}`);
          const d3=await lpFetch(`${VALWIKI}?action=query&titles=${encodeURIComponent('File:'+logoFile)}&prop=imageinfo&iiprop=url&iiurlwidth=96&format=json`);
          const p3=Object.values(d3?.query?.pages||{}).find(p=>p.imageinfo?.length);
          if(p3){
            const imgUrl=p3.imageinfo[0].thumburl||p3.imageinfo[0].url;
            const proxiedUrl=OWN_PROXY(imgUrl);
            LOGOS[tag]=proxiedUrl;
            logoCache[tag]=proxiedUrl;
            document.querySelectorAll(`img.tlogo[alt="${tag}"]`).forEach(el=>{if(el.src.startsWith('data:'))el.src=proxiedUrl});
            console.log(`üñºÔ∏è Liquipedia Î≥¥ÏôÑ: ${tag} ‚Üê ${logoFile}`);
            await new Promise(r=>setTimeout(r,5000));
            continue;
          }
        }else{
          console.log(`üñºÔ∏è LP M2 miss: ${tag} ‚Äî Ïù∏Ìè¨Î∞ïÏä§Ïóê image= ÏóÜÏùå`);
        }
      }else{
        console.log(`üñºÔ∏è LP M2 miss: ${tag} ‚Äî ÌéòÏù¥ÏßÄ "${teamPage}" ÌååÏã± Ïã§Ìå®`);
      }

      // Method 3: ÌåÄ ÌéòÏù¥ÏßÄ images Î™©Î°ùÏóêÏÑú ÌåÄÎ™Ö Îß§Ïπ≠ (fallback)
      const d4=await lpFetch(`${VALWIKI}?action=query&titles=${encodeURIComponent(teamPage)}&prop=images&imlimit=500&format=json`);
      if(d4?.query?.pages){
        const pg=Object.values(d4.query.pages).find(p=>p.pageid>0);
        if(pg?.images?.length){
          const nameVariants=[
            prefix.toLowerCase().replace(/_/g,' '),
            ...(LP_PAGE[tag]?[LP_PAGE[tag].toLowerCase().replace(/_/g,' ')]:[])
          ];
          const logoImgs=pg.images.filter(im=>{
            const t=(im.title||'').toLowerCase();
            const hasTeamName=nameVariants.some(n=>t.includes(n));
            const isLogo=/allmode|darkmode|logo/i.test(t);
            const notJunk=!/player|banner|map|screenshot|header/i.test(t);
            return hasTeamName&&isLogo&&notJunk;
          });
          logoImgs.sort((a,b)=>{
            const score=n=>{
              if(!n)return 9;n=n.toLowerCase();
              if(n.includes('allmode')&&!n.includes('full'))return 0;
              if(n.includes('darkmode')&&!n.includes('full'))return 1;
              return 4;
            };
            return score(a.title)-score(b.title);
          });
          console.log(`üñºÔ∏è LP M3: ${tag} ÌåÄÎ™Ö Îß§Ïπ≠ ${logoImgs.length}Í∞ú${logoImgs.length?': '+logoImgs[0].title:''}`);
          if(logoImgs.length){
            const d5=await lpFetch(`${VALWIKI}?action=query&titles=${encodeURIComponent(logoImgs[0].title)}&prop=imageinfo&iiprop=url&iiurlwidth=96&format=json`);
            const p5=Object.values(d5?.query?.pages||{}).find(p=>p.imageinfo?.length);
            if(p5){
              const imgUrl=p5.imageinfo[0].thumburl||p5.imageinfo[0].url;
              const proxiedUrl=OWN_PROXY(imgUrl);
              LOGOS[tag]=proxiedUrl;
              logoCache[tag]=proxiedUrl;
              document.querySelectorAll(`img.tlogo[alt="${tag}"]`).forEach(el=>{if(el.src.startsWith('data:'))el.src=proxiedUrl});
              console.log(`üñºÔ∏è Liquipedia Î≥¥ÏôÑ(M3): ${tag} ‚Üê ${logoImgs[0].title}`);
            }
          }
        }
      }
    }catch(e){console.log(`üñºÔ∏è Liquipedia Ïã§Ìå®: ${tag}`,e.message)}
    await new Promise(r=>setTimeout(r,5000));
  }
  const total=Object.keys(LOGOS).filter(k=>LOGOS[k]&&!LOGOS[k].startsWith('data:')).length;
  console.log(`üñºÔ∏è ÏµúÏ¢Ö: ${total}Í∞ú ÌåÄ Î°úÍ≥† Î°úÎìú ÏôÑÎ£å`);
}

// Fetch logos 3s after page load
setTimeout(fetchRiotTeamLogos,3000);

// ===== UPCOMING MATCHES DATA =====
const upcomingData = [
  {
    event: "VCT 2026: China Stage 1",
    stage: "Group Alpha",
    date: "2026-03-31",
    dateLabel: "3Ïõî 31Ïùº ~ 5Ïõî",
    format: "Round Robin",
    opponents: ["All Gamers", "TYLOO", "JDG Esports", "Titan Esports Club", "FunPlus Phoenix"],
    note: "ÏÉÅÏúÑ 3ÌåÄ ‚Üí Masters London ÏßÑÏ∂ú",
    confirmed: true,
    groupTeams: [
      {name:"BLG",self:true},{name:"AG",self:false},{name:"TYL",self:false},
      {name:"JDG",self:false},{name:"TEC",self:false},{name:"FPX",self:false}
    ]
  }
];

function renderUpcoming() {
  const el = document.getElementById('upcomingSection');
  const now = new Date();
  // ÌôïÏ†ïÎêú ÏùºÏ†ïÎßå ÌëúÏãú
  const confirmed = upcomingData.filter(u => u.confirmed || (u.opponents && u.opponents.length > 0));
  if (!confirmed.length) { el.innerHTML = ''; return; }

  let h = `<div class="upcoming-title"><h2>üìÖ Îã§Ïùå Í≤ΩÍ∏∞ ÏùºÏ†ï</h2><span class="live-badge">confirmed</span></div>`;

  confirmed.forEach(u => {
    const target = new Date(u.date + 'T09:00:00+08:00');
    const diff = target - now;
    const days = Math.max(0, Math.floor(diff / 86400000));
    const hrs = Math.max(0, Math.floor((diff % 86400000) / 3600000));
    const mins = Math.max(0, Math.floor((diff % 3600000) / 60000));

    h += `<div class="upcoming-card">
      <div class="uc-top"><span class="uc-event">${u.event}</span><span class="uc-date">${u.dateLabel}</span></div>`;

    if (u.opponents.length > 0) {
      h += `<div class="uc-teams">
        <div class="uc-team">${L('BLG','lg')}<div class="uc-team-name blg" style="margin-top:4px">BLG</div><div class="uc-team-sub">Bilibili Gaming</div></div>
        <div class="uc-vs">VS</div>
        <div class="uc-team"><div class="uc-team-name">${u.opponents.length}ÌåÄ</div><div class="uc-team-sub">${u.stage}</div></div>
      </div>`;
    } else {
      h += `<div class="uc-teams">
        <div class="uc-team">${L('BLG','lg')}<div class="uc-team-name blg" style="margin-top:4px">BLG</div><div class="uc-team-sub">Bilibili Gaming</div></div>
        <div class="uc-vs">‚Üí</div>
        <div class="uc-team"><div class="uc-team-name" style="color:var(--cyan)">TBD</div><div class="uc-team-sub">${u.stage}</div></div>
      </div>`;
    }

    h += `<div class="uc-info">
      <span class="uc-tag">${u.format}</span>
      <span class="uc-tag">${u.note}</span>
      ${diff > 0 ? '<span class="uc-tag tbd">D-' + days + '</span>' : '<span class="uc-tag tbd">ÏùºÏ†ï ÌôïÏù∏ Ï§ë</span>'}
    </div>`;

    if (diff > 0) {
      h += `<div class="countdown-row">
        <div class="cd-block"><div class="cd-num">${days}</div><div class="cd-label">Ïùº</div></div>
        <div class="cd-block"><div class="cd-num">${hrs}</div><div class="cd-label">ÏãúÍ∞Ñ</div></div>
        <div class="cd-block"><div class="cd-num">${mins}</div><div class="cd-label">Î∂Ñ</div></div>
      </div>`;
    }

    if (u.groupTeams.length > 0) {
      h += `<div class="group-preview"><div class="gp-title">Group Alpha Ìé∏ÏÑ±</div><div class="gp-teams">`;
      u.groupTeams.forEach(gt => {
        h += `<span class="gp-team ${gt.self ? 'self' : ''}">${L(gt.name,'sm')} ${gt.name}</span>`;
      });
      h += `</div></div>`;
    }

    h += `</div>`;
  });

  el.innerHTML = h;
}

// Update countdowns every minute
setInterval(renderUpcoming, 60000);

// ===== MATCH DATA =====
const baselineData = {
  "2023":[
  {tournament:"FGC 2023: Act 1 Qualifier",intl:false,matches:[
    {date:"2023-02-23",opp:"Invictus Gaming",tag:"iG",stage:"Ro16",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Haven",b:13,o:5,r:"win"},{n:"Ascent",b:13,o:9,r:"win"}]},
    {date:"2023-02-24",opp:"TYLOO",tag:"TYL",stage:"QF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Icebox",b:13,o:11,r:"win"},{n:"Haven",b:5,o:13,r:"loss"},{n:"Ascent",b:10,o:13,r:"loss"}]},
    {date:"2023-03-02",opp:"Oxyg3niOus",tag:"O3O",stage:"Ro16",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Icebox",b:13,o:6,r:"win"},{n:"Lotus",b:13,o:2,r:"win"}]},
    {date:"2023-03-03",opp:"Royal Never Give Up",tag:"RNG",stage:"QF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Lotus",b:13,o:9,r:"win"},{n:"Haven",b:8,o:13,r:"loss"},{n:"Ascent",b:13,o:11,r:"win"}]},
    {date:"2023-03-04",opp:"Rare Atom",tag:"RA",stage:"UBSF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Lotus",b:12,o:14,r:"loss"},{n:"Icebox",b:13,o:3,r:"win"},{n:"Ascent",b:13,o:10,r:"win"}]},
    {date:"2023-03-05",opp:"Invincible Gaming",tag:"iNv",stage:"UF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:7,r:"win"},{n:"Ascent",b:13,o:11,r:"win"}]}
  ]},
  {tournament:"FGC Invitational 2023: Act 1",intl:false,matches:[
    {date:"2023-03-22",opp:"Shenzhen NTER",tag:"NTER",stage:"D1",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:3,o:13,r:"loss"},{n:"Pearl",b:4,o:13,r:"loss"}]},
    {date:"2023-03-24",opp:"EDward Gaming",tag:"EDG",stage:"D3",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:6,o:13,r:"loss"},{n:"Haven",b:9,o:13,r:"loss"}]},
    {date:"2023-03-26",opp:"Dragon Ranger Gaming",tag:"DRG",stage:"D5",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Ascent",b:7,o:13,r:"loss"},{n:"Lotus",b:13,o:3,r:"win"},{n:"Haven",b:5,o:13,r:"loss"}]},
    {date:"2023-03-30",opp:"Totoro Gaming",tag:"TTG",stage:"D7",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Split",b:3,o:13,r:"loss"},{n:"Lotus",b:13,o:7,r:"win"},{n:"Fracture",b:11,o:13,r:"loss"}]},
    {date:"2023-04-02",opp:"TYLOO",tag:"TYL",stage:"D10",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:10,r:"win"},{n:"Haven",b:13,o:11,r:"win"}]}
  ]},
  {tournament:"FGC 2023: Act 2 Qualifier",intl:false,matches:[
    {date:"2023-04-13",opp:"Four Angry Men",tag:"4AM",stage:"Ro16",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Haven",b:14,o:12,r:"win"},{n:"Fracture",b:13,o:7,r:"win"}]},
    {date:"2023-04-14",opp:"Number One Player",tag:"NOP",stage:"QF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Icebox",b:12,o:14,r:"loss"},{n:"Fracture",b:13,o:4,r:"win"},{n:"Haven",b:13,o:5,r:"win"}]},
    {date:"2023-04-15",opp:"Rare Atom",tag:"RA",stage:"UBSF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Pearl",b:13,o:7,r:"win"},{n:"Icebox",b:7,o:13,r:"loss"},{n:"Haven",b:5,o:13,r:"loss"}]},
    {date:"2023-04-16",opp:"JiJieHao",tag:"JJH",stage:"LR1",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Haven",b:12,o:14,r:"loss"},{n:"Pearl",b:5,o:13,r:"loss"}]},
    {date:"2023-04-18",opp:"NewHappy Esports",tag:"NH",stage:"Ro16",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:4,r:"win"},{n:"Ascent",b:13,o:9,r:"win"}]},
    {date:"2023-04-20",opp:"Kingzone",tag:"KZ",stage:"QF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Fracture",b:11,o:13,r:"loss"},{n:"Pearl",b:13,o:10,r:"win"},{n:"Icebox",b:13,o:5,r:"win"}]},
    {date:"2023-04-22",opp:"Gank Gaming",tag:"GK",stage:"UBSF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Haven",b:15,o:17,r:"loss"},{n:"Fracture",b:13,o:4,r:"win"},{n:"Pearl",b:13,o:8,r:"win"}]},
    {date:"2023-04-23",opp:"Royal Never Give Up",tag:"RNG",stage:"UF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Haven",b:13,o:6,r:"win"},{n:"Pearl",b:13,o:11,r:"win"}]}
  ]},
  {tournament:"FGC Invitational 2023: Act 2",intl:false,matches:[
    {date:"2023-05-03",opp:"Douyu Gaming",tag:"DYG",stage:"Opening (A)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:6,r:"win"},{n:"Bind",b:13,o:11,r:"win"}]},
    {date:"2023-05-11",opp:"Attacking Soul Esports",tag:"ASE",stage:"Winner's (A)",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Split",b:13,o:8,r:"win"},{n:"Fracture",b:3,o:13,r:"loss"},{n:"Bind",b:13,o:4,r:"win"}]},
    {date:"2023-05-17",opp:"Shenzhen NTER",tag:"NTER",stage:"QF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Ascent",b:14,o:16,r:"loss"},{n:"Split",b:13,o:11,r:"win"},{n:"Haven",b:13,o:10,r:"win"}]},
    {date:"2023-05-18",opp:"FunPlus Phoenix",tag:"FPX",stage:"UBSF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Pearl",b:13,o:11,r:"win"},{n:"Ascent",b:13,o:7,r:"win"}]},
    {date:"2023-05-19",opp:"Attacking Soul Esports",tag:"ASE",stage:"UF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Lotus",b:9,o:13,r:"loss"},{n:"Ascent",b:13,o:10,r:"win"},{n:"Pearl",b:13,o:5,r:"win"}]},
    {date:"2023-05-21",opp:"EDward Gaming",tag:"EDG",stage:"GF",fmt:"Bo5",bs:0,os:3,r:"loss",maps:[{n:"Haven",b:5,o:13,r:"loss"},{n:"Bind",b:5,o:13,r:"loss"},{n:"Ascent",b:11,o:13,r:"loss"}]}
  ]},
  {tournament:"VCT 2023: CN Champions Qualifier",intl:false,matches:[
    {date:"2023-07-05",opp:"Monarch Effect",tag:"ME",stage:"UBQF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:10,r:"win"},{n:"Haven",b:13,o:7,r:"win"}]},
    {date:"2023-07-08",opp:"Trace Esports",tag:"TE",stage:"UBSF",fmt:"Bo5",bs:3,os:0,r:"win",maps:[{n:"Haven",b:13,o:10,r:"win"},{n:"Lotus",b:13,o:5,r:"win"},{n:"Split",b:13,o:2,r:"win"}]},
    {date:"2023-07-13",opp:"EDward Gaming",tag:"EDG",stage:"UF",fmt:"Bo5",bs:0,os:3,r:"loss",maps:[{n:"Pearl",b:3,o:13,r:"loss"},{n:"Bind",b:10,o:13,r:"loss"},{n:"Split",b:4,o:13,r:"loss"}]},
    {date:"2023-07-15",opp:"FunPlus Phoenix",tag:"FPX",stage:"LF",fmt:"Bo5",bs:3,os:2,r:"win",maps:[{n:"Lotus",b:11,o:13,r:"loss"},{n:"Bind",b:13,o:9,r:"win"},{n:"Pearl",b:9,o:13,r:"loss"},{n:"Split",b:13,o:6,r:"win"},{n:"Ascent",b:13,o:5,r:"win"}]},
    {date:"2023-07-16",opp:"EDward Gaming",tag:"EDG",stage:"GF",fmt:"Bo5",bs:1,os:3,r:"loss",maps:[{n:"Split",b:6,o:13,r:"loss"},{n:"Fracture",b:4,o:13,r:"loss"},{n:"Bind",b:14,o:12,r:"win"},{n:"Haven",b:12,o:14,r:"loss"}]}
  ]},
  {tournament:"VALORANT Champions 2023 (LA)",intl:true,matches:[
    {date:"2023-08-08",opp:"NRG Esports",tag:"NRG",stage:"Opening (C)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:14,o:12,r:"win"},{n:"Split",b:13,o:8,r:"win"}]},
    {date:"2023-08-09",opp:"FNATIC",tag:"FNC",stage:"Winner's (C)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Haven",b:2,o:13,r:"loss"},{n:"Lotus",b:8,o:13,r:"loss"}]},
    {date:"2023-08-13",opp:"NRG Esports",tag:"NRG",stage:"Decider (C)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Bind",b:13,o:10,r:"win"},{n:"Ascent",b:13,o:5,r:"win"}]},
    {date:"2023-08-17",opp:"DRX",tag:"DRX",stage:"UBQF",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:10,o:13,r:"loss"},{n:"Haven",b:9,o:13,r:"loss"}]},
    {date:"2023-08-18",opp:"EDward Gaming",tag:"EDG",stage:"LR1",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Bind",b:4,o:13,r:"loss"},{n:"Split",b:15,o:13,r:"win"},{n:"Haven",b:10,o:13,r:"loss"}]}
  ]},
  {tournament:"China Evolution Series: Act 1",intl:false,matches:[
    {date:"2023-09-24",opp:"Weibo Gaming",tag:"WBG",stage:"UBQF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Ascent",b:13,o:11,r:"win"},{n:"Bind",b:13,o:4,r:"win"}]},
    {date:"2023-09-26",opp:"FunPlus Phoenix",tag:"FPX",stage:"UBSF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Haven",b:8,o:13,r:"loss"},{n:"Bind",b:13,o:8,r:"win"},{n:"Sunset",b:10,o:13,r:"loss"}]},
    {date:"2023-09-27",opp:"Trace Esports",tag:"TE",stage:"LR2",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:10,o:13,r:"loss"},{n:"Ascent",b:5,o:13,r:"loss"}]}
  ]},
  {tournament:"China Evolution Series: Act 2",intl:false,matches:[
    {date:"2023-10-05",opp:"Xi Lai Gaming",tag:"XLG",stage:"OQ-C R2",fmt:"Bo1",bs:1,os:0,r:"win",maps:[{n:"Lotus",b:13,o:9,r:"win"}]},
    {date:"2023-10-06",opp:"Dragon Ranger Gaming",tag:"DRG",stage:"OQ URo16",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Breeze",b:11,o:13,r:"loss"},{n:"Bind",b:9,o:13,r:"loss"}]},
    {date:"2023-10-07",opp:"All Gamers",tag:"AG",stage:"OQ LR1",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Ascent",b:13,o:4,r:"win"},{n:"Lotus",b:13,o:1,r:"win"}]},
    {date:"2023-10-08",opp:"Top Esports",tag:"TES",stage:"OQ LR2",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Split",b:13,o:6,r:"win"},{n:"Lotus",b:13,o:9,r:"win"}]},
    {date:"2023-10-10",opp:"Ninjas in Pyjamas",tag:"NIP",stage:"Opening (A)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Ascent",b:13,o:8,r:"win"},{n:"Bind",b:13,o:7,r:"win"}]},
    {date:"2023-10-12",opp:"Royal Never Give Up",tag:"RNG",stage:"Winner's (A)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Split",b:13,o:5,r:"win"},{n:"Lotus",b:13,o:11,r:"win"}]},
    {date:"2023-10-20",opp:"Trace Esports",tag:"TE",stage:"Opening (A)",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Lotus",b:13,o:6,r:"win"},{n:"Bind",b:7,o:13,r:"loss"},{n:"Breeze",b:13,o:4,r:"win"}]},
    {date:"2023-10-22",opp:"EDward Gaming",tag:"EDG",stage:"Winner's (A)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Breeze",b:12,o:14,r:"loss"},{n:"Split",b:5,o:13,r:"loss"}]},
    {date:"2023-10-24",opp:"Trace Esports",tag:"TE",stage:"Decider (A)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Ascent",b:12,o:14,r:"loss"},{n:"Split",b:4,o:13,r:"loss"}]}
  ]},
  {tournament:"China Evolution Series: Act 3",intl:false,matches:[
    {date:"2023-11-02",opp:"VLG Esports",tag:"VLG",stage:"OQ-A SF",fmt:"Bo1",bs:1,os:0,r:"win",maps:[{n:"Lotus",b:13,o:2,r:"win"}]},
    {date:"2023-11-03",opp:"Titan Esports Club",tag:"TEC",stage:"OQ-A GF",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Haven",b:9,o:13,r:"loss"}]},
    {date:"2023-11-05",opp:"Night Wings Gaming",tag:"NWG",stage:"Opening (B)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Ascent",b:13,o:10,r:"win"},{n:"Haven",b:13,o:7,r:"win"}]},
    {date:"2023-11-07",opp:"Royal Never Give Up",tag:"RNG",stage:"Winner's (B)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Haven",b:14,o:12,r:"win"},{n:"Ascent",b:13,o:4,r:"win"}]},
    {date:"2023-11-16",opp:"LGD Gaming",tag:"LGD",stage:"UR1",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Haven",b:13,o:5,r:"win"},{n:"Lotus",b:13,o:0,r:"win"}]},
    {date:"2023-11-18",opp:"Attacking Soul Esports",tag:"ASE",stage:"UBQF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Lotus",b:2,o:13,r:"loss"},{n:"Split",b:13,o:10,r:"win"},{n:"Bind",b:10,o:13,r:"loss"}]},
    {date:"2023-11-21",opp:"Titan Esports Club",tag:"TEC",stage:"LR1",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:8,o:13,r:"loss"},{n:"Breeze",b:12,o:14,r:"loss"}]}
  ]}
  ],
  "2024":[
  {tournament:"VCT 2024: China Kickoff",intl:false,matches:[
    {date:"2024-02-23",opp:"Wolves Esports",tag:"WOL",stage:"Opening (C)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Ascent",b:9,o:13,r:"loss"},{n:"Icebox",b:7,o:13,r:"loss"}]},
    {date:"2024-02-26",opp:"Wolves Esports",tag:"WOL",stage:"Decider (C)",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Sunset",b:13,o:9,r:"win"},{n:"Icebox",b:13,o:10,r:"win"}]},
    {date:"2024-02-27",opp:"Titan Esports Club",tag:"TEC",stage:"Round-Robin",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:3,r:"win"},{n:"Ascent",b:13,o:8,r:"win"}]},
    {date:"2024-02-27",opp:"Trace Esports",tag:"TE",stage:"Round-Robin",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Lotus",b:13,o:11,r:"win"},{n:"Sunset",b:13,o:15,r:"loss"},{n:"Bind",b:12,o:14,r:"loss"}]}
  ]},
  {tournament:"VCT 2024: China Stage 1",intl:false,matches:[
    {date:"2024-04-05",opp:"TYLOO",tag:"TYL",stage:"W1",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Bind",b:3,o:13,r:"loss"},{n:"Icebox",b:13,o:6,r:"win"},{n:"Lotus",b:13,o:6,r:"win"}]},
    {date:"2024-04-13",opp:"Trace Esports",tag:"TE",stage:"W2",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Split",b:13,o:11,r:"win"},{n:"Breeze",b:7,o:13,r:"loss"},{n:"Bind",b:7,o:13,r:"loss"}]},
    {date:"2024-04-20",opp:"All Gamers",tag:"AG",stage:"W3",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:11,o:13,r:"loss"},{n:"Bind",b:7,o:13,r:"loss"}]},
    {date:"2024-04-26",opp:"Titan Esports Club",tag:"TEC",stage:"W4",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Sunset",b:11,o:13,r:"loss"},{n:"Bind",b:13,o:8,r:"win"},{n:"Icebox",b:6,o:13,r:"loss"}]},
    {date:"2024-04-28",opp:"JDG Esports",tag:"JDG",stage:"W4",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Icebox",b:13,o:8,r:"win"},{n:"Lotus",b:13,o:10,r:"win"}]},
    {date:"2024-05-04",opp:"FunPlus Phoenix",tag:"FPX",stage:"W5",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Icebox",b:2,o:13,r:"loss"},{n:"Lotus",b:6,o:13,r:"loss"}]}
  ]},
  {tournament:"VCT 2024: China Stage 2",intl:false,matches:[
    {date:"2024-06-16",opp:"Wolves Esports",tag:"WOL",stage:"W1",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Sunset",b:13,o:5,r:"win"},{n:"Bind",b:13,o:7,r:"win"}]},
    {date:"2024-06-23",opp:"Nova Esports",tag:"NV",stage:"W2",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Split",b:14,o:16,r:"loss"},{n:"Bind",b:13,o:9,r:"win"},{n:"Ascent",b:13,o:6,r:"win"}]},
    {date:"2024-06-30",opp:"Dragon Ranger Gaming",tag:"DRG",stage:"W3",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:11,r:"win"},{n:"Ascent",b:13,o:11,r:"win"}]},
    {date:"2024-07-06",opp:"EDward Gaming",tag:"EDG",stage:"W4",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Icebox",b:11,o:13,r:"loss"},{n:"Haven",b:8,o:13,r:"loss"}]},
    {date:"2024-07-16",opp:"JDG Esports",tag:"JDG",stage:"KO",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Sunset",b:13,o:9,r:"win"},{n:"Icebox",b:13,o:7,r:"win"}]},
    {date:"2024-07-17",opp:"EDward Gaming",tag:"EDG",stage:"UBSF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Sunset",b:5,o:13,r:"loss"},{n:"Bind",b:13,o:7,r:"win"},{n:"Lotus",b:10,o:13,r:"loss"}]},
    {date:"2024-07-18",opp:"FunPlus Phoenix",tag:"FPX",stage:"LR1",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Ascent",b:3,o:13,r:"loss"},{n:"Icebox",b:14,o:12,r:"win"},{n:"Lotus",b:10,o:13,r:"loss"}]}
  ]},
  {tournament:"VALORANT Champions 2024 (Seoul)",intl:true,matches:[
    {date:"2024-08-02",opp:"FNATIC",tag:"FNC",stage:"Opening (A)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Bind",b:9,o:13,r:"loss"},{n:"Lotus",b:4,o:13,r:"loss"}]},
    {date:"2024-08-08",opp:"KR√ú Esports",tag:"KR√ú",stage:"Elim (A)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Lotus",b:9,o:13,r:"loss"},{n:"Icebox",b:4,o:13,r:"loss"}]}
  ]},
  {tournament:"FGC Invitational 2024",intl:false,matches:[
    {date:"2024-11-01",opp:"Xi Lai Gaming",tag:"XLG",stage:"UBQF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Ascent",b:10,o:13,r:"loss"},{n:"Pearl",b:13,o:6,r:"win"},{n:"Bind",b:15,o:13,r:"win"}]},
    {date:"2024-11-06",opp:"Nova Esports",tag:"NV",stage:"UBSF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Sunset",b:13,o:10,r:"win"},{n:"Pearl",b:13,o:9,r:"win"}]},
    {date:"2024-11-08",opp:"Wolves Esports",tag:"WOL",stage:"UBF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Split",b:9,o:13,r:"loss"},{n:"Bind",b:13,o:7,r:"win"},{n:"Ascent",b:13,o:6,r:"win"}]},
    {date:"2024-11-10",opp:"Wolves Esports",tag:"WOL",stage:"GF",fmt:"Bo5",bs:3,os:1,r:"win",maps:[{n:"Sunset",b:13,o:5,r:"win"},{n:"Abyss",b:13,o:11,r:"win"},{n:"Bind",b:9,o:13,r:"loss"},{n:"Ascent",b:16,o:14,r:"win"}]}
  ]},
  {tournament:"Radiant Asia Invitational 2024",intl:true,matches:[
    {date:"2024-11-22",opp:"DRX",tag:"DRX",stage:"R1",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Sunset",b:11,o:13,r:"loss"},{n:"Haven",b:2,o:13,r:"loss"}]},
    {date:"2024-11-24",opp:"Trace Esports",tag:"TE",stage:"R2 (0-1)",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Abyss",b:9,o:13,r:"loss"},{n:"Ascent",b:13,o:4,r:"win"},{n:"Sunset",b:6,o:13,r:"loss"}]}
  ]},
  {tournament:"SOOP Valorant League 2024",intl:true,matches:[
    {date:"2024-12-11",opp:"DRX",tag:"DRX",stage:"Opening (B)",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Bind",b:6,o:13,r:"loss"},{n:"Abyss",b:13,o:9,r:"win"},{n:"Pearl",b:9,o:13,r:"loss"}]},
    {date:"2024-12-13",opp:"NRG Esports",tag:"NRG",stage:"Elim (B)",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Split",b:11,o:13,r:"loss"},{n:"Ascent",b:13,o:10,r:"win"},{n:"Abyss",b:7,o:13,r:"loss"}]}
  ]}
  ],
  "2025":[
  {tournament:"VCT 2025: China Kickoff",intl:false,matches:[
    {date:"2025-01-16",opp:"Xi Lai Gaming",tag:"XLG",stage:"UBQF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Haven",b:11,o:13,r:"loss"},{n:"Lotus",b:13,o:11,r:"win"},{n:"Abyss",b:13,o:11,r:"win"}]},
    {date:"2025-01-20",opp:"FunPlus Phoenix",tag:"FPX",stage:"UBSF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Bind",b:13,o:11,r:"win"},{n:"Lotus",b:13,o:9,r:"win"}]},
    {date:"2025-01-23",opp:"Trace Esports",tag:"TE",stage:"UBF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Bind",b:8,o:13,r:"loss"},{n:"Haven",b:13,o:10,r:"win"},{n:"Lotus",b:6,o:13,r:"loss"}]},
    {date:"2025-01-24",opp:"EDward Gaming",tag:"EDG",stage:"LBF",fmt:"Bo5",bs:0,os:3,r:"loss",maps:[{n:"Pearl",b:12,o:14,r:"loss"},{n:"Haven",b:6,o:13,r:"loss"},{n:"Lotus",b:5,o:13,r:"loss"}]}
  ]},
  {tournament:"China Evolution Series: Act 1",intl:false,matches:[
    {date:"2025-02-10",opp:"TYLOO",tag:"TYL",stage:"QF",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Abyss",b:13,o:9,r:"win"},{n:"Pearl",b:19,o:17,r:"win"}]},
    {date:"2025-02-14",opp:"Nova Esports",tag:"NV",stage:"SF",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Split",b:8,o:13,r:"loss"},{n:"Pearl",b:4,o:13,r:"loss"}]},
    {date:"2025-02-15",opp:"JDG Esports",tag:"JDG",stage:"CF",fmt:"Bo5",bs:3,os:0,r:"win",maps:[{n:"Abyss",b:13,o:9,r:"win"},{n:"Pearl",b:13,o:3,r:"win"},{n:"Lotus",b:13,o:11,r:"win"}]}
  ]},
  {tournament:"VCT 2025: China Stage 1",intl:false,matches:[
    {date:"2025-03-13",opp:"Xi Lai Gaming",tag:"XLG",stage:"Regular Season",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Pearl",b:8,o:13,r:"loss"},{n:"Icebox",b:13,o:9,r:"win"},{n:"Fracture",b:13,o:8,r:"win"}]},
    {date:"2025-03-23",opp:"JDG Esports",tag:"JDG",stage:"Regular Season",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Pearl",b:13,o:10,r:"win"},{n:"Icebox",b:5,o:13,r:"loss"},{n:"Fracture",b:13,o:8,r:"win"}]},
    {date:"2025-03-30",opp:"All Gamers",tag:"AG",stage:"Regular Season",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Pearl",b:13,o:4,r:"win"},{n:"Fracture",b:13,o:5,r:"win"}]},
    {date:"2025-04-04",opp:"Wolves Esports",tag:"WOL",stage:"Regular Season",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Haven",b:13,o:5,r:"win"},{n:"Ascent",b:13,o:4,r:"win"},{n:"Lotus",b:10,o:13,r:"loss"}]},
    {date:"2025-04-12",opp:"Trace Esports",tag:"TE",stage:"Regular Season",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Haven",b:4,o:13,r:"loss"},{n:"Ascent",b:13,o:5,r:"win"},{n:"Split",b:1,o:13,r:"loss"}]},
    {date:"2025-04-19",opp:"Wolves Esports",tag:"WOL",stage:"UB Semi",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Split",b:8,o:13,r:"loss"},{n:"Haven",b:8,o:13,r:"loss"}]},
    {date:"2025-04-20",opp:"Trace Esports",tag:"TE",stage:"LR2",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Fracture",b:13,o:8,r:"win"},{n:"Lotus",b:13,o:4,r:"win"}]},
    {date:"2025-05-02",opp:"EDward Gaming",tag:"EDG",stage:"LR3",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Fracture",b:8,o:13,r:"loss"},{n:"Icebox",b:13,o:8,r:"win"},{n:"Pearl",b:13,o:11,r:"win"}]},
    {date:"2025-05-03",opp:"Wolves Esports",tag:"WOL",stage:"LBF",fmt:"Bo5",bs:3,os:0,r:"win",maps:[{n:"Pearl",b:13,o:9,r:"win"},{n:"Lotus",b:13,o:11,r:"win"},{n:"Icebox",b:13,o:7,r:"win"}]},
    {date:"2025-05-04",opp:"Xi Lai Gaming",tag:"XLG",stage:"GF",fmt:"Bo5",bs:1,os:3,r:"loss",maps:[{n:"Fracture",b:13,o:15,r:"loss"},{n:"Lotus",b:10,o:13,r:"loss"},{n:"Pearl",b:13,o:8,r:"win"},{n:"Haven",b:12,o:14,r:"loss"}]}
  ]},
  {tournament:"CN EVO 25: Act 2 X ACL",intl:false,matches:[
    {date:"2025-05-08",opp:"Titan Esports Club",tag:"TEC",stage:"Ro12",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Haven",b:2,o:13,r:"loss"},{n:"Icebox",b:4,o:13,r:"loss"}]}
  ]},
  {tournament:"HERO Asian Champions League 2025",intl:true,matches:[
    {date:"2025-05-14",opp:"DRX",tag:"DRX",stage:"LR2",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Haven",b:1,o:13,r:"loss"},{n:"Icebox",b:12,o:14,r:"loss"}]},
    {date:"2025-05-15",opp:"Trace Esports",tag:"TE",stage:"LR2",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Pearl",b:13,o:9,r:"win"},{n:"Split",b:13,o:4,r:"win"}]},
    {date:"2025-05-16",opp:"DRX",tag:"DRX",stage:"LR3",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Sunset",b:10,o:13,r:"loss"},{n:"Lotus",b:5,o:13,r:"loss"}]}
  ]},
  {tournament:"VCT Masters Toronto 2025",intl:true,matches:[
    {date:"2025-06-07",opp:"Team Liquid",tag:"TL",stage:"R1",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Icebox",b:13,o:10,r:"win"},{n:"Haven",b:14,o:16,r:"loss"},{n:"Sunset",b:13,o:10,r:"win"}]},
    {date:"2025-06-09",opp:"Sentinels",tag:"SEN",stage:"R2 (1-0)",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Icebox",b:13,o:9,r:"win"},{n:"Sunset",b:5,o:13,r:"loss"},{n:"Lotus",b:9,o:13,r:"loss"}]},
    {date:"2025-06-11",opp:"Wolves Esports",tag:"WOL",stage:"R3 (1-1)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Split",b:10,o:13,r:"loss"},{n:"Ascent",b:5,o:13,r:"loss"}]}
  ]},
  {tournament:"Esports World Cup 2025",intl:true,matches:[
    {date:"2025-07-08",opp:"Paper Rex",tag:"PRX",stage:"Opening (A)",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Lotus",b:14,o:16,r:"loss"}]},
    {date:"2025-07-09",opp:"G2 Esports",tag:"G2",stage:"Elim (A)",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Sunset",b:13,o:3,r:"win"},{n:"Pearl",b:4,o:13,r:"loss"},{n:"Icebox",b:13,o:11,r:"win"}]},
    {date:"2025-07-10",opp:"Karmine Corp",tag:"KC",stage:"Decider (A)",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Icebox",b:5,o:13,r:"loss"},{n:"Lotus",b:13,o:11,r:"win"},{n:"Sunset",b:9,o:13,r:"loss"}]}
  ]},
  {tournament:"VCT 2025: China Stage 2",intl:false,matches:[
    {date:"2025-07-04",opp:"TYLOO",tag:"TYL",stage:"W1",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Bind",b:13,o:5,r:"win"},{n:"Lotus",b:13,o:9,r:"win"}]},
    {date:"2025-07-18",opp:"JDG Esports",tag:"JDG",stage:"W2",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Sunset",b:13,o:7,r:"win"},{n:"Ascent",b:13,o:15,r:"loss"},{n:"Icebox",b:13,o:4,r:"win"}]},
    {date:"2025-07-23",opp:"Titan Esports Club",tag:"TEC",stage:"W3",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Bind",b:13,o:9,r:"win"},{n:"Ascent",b:13,o:8,r:"win"}]},
    {date:"2025-07-26",opp:"Trace Esports",tag:"TE",stage:"W3",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Haven",b:13,o:6,r:"win"},{n:"Icebox",b:13,o:15,r:"loss"},{n:"Ascent",b:6,o:13,r:"loss"}]},
    {date:"2025-08-03",opp:"EDward Gaming",tag:"EDG",stage:"W4",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Lotus",b:13,o:6,r:"win"},{n:"Sunset",b:15,o:13,r:"win"}]},
    {date:"2025-08-20",opp:"TYLOO",tag:"TYL",stage:"UBSF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Bind",b:13,o:7,r:"win"},{n:"Icebox",b:9,o:13,r:"loss"},{n:"Lotus",b:13,o:5,r:"win"}]},
    {date:"2025-08-22",opp:"Dragon Ranger Gaming",tag:"DRG",stage:"UBF",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Haven",b:10,o:13,r:"loss"},{n:"Lotus",b:13,o:9,r:"win"},{n:"Sunset",b:11,o:13,r:"loss"}]},
    {date:"2025-08-23",opp:"EDward Gaming",tag:"EDG",stage:"LBF",fmt:"Bo5",bs:3,os:1,r:"win",maps:[{n:"Bind",b:12,o:14,r:"loss"},{n:"Haven",b:13,o:8,r:"win"},{n:"Lotus",b:13,o:10,r:"win"},{n:"Ascent",b:13,o:7,r:"win"}]},
    {date:"2025-08-24",opp:"Dragon Ranger Gaming",tag:"DRG",stage:"GF",fmt:"Bo5",bs:3,os:1,r:"win",maps:[{n:"Sunset",b:2,o:13,r:"loss"},{n:"Haven",b:13,o:8,r:"win"},{n:"Corrode",b:13,o:10,r:"win"},{n:"Lotus",b:13,o:9,r:"win"}]}
  ]},
  {tournament:"CN EVO 25: Act 3",intl:false,matches:[
    {date:"2025-08-29",opp:"Wolves Esports",tag:"WOL",stage:"Ro12",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Abyss",b:13,o:11,r:"win"},{n:"Corrode",b:9,o:13,r:"loss"},{n:"Ascent",b:7,o:13,r:"loss"}]}
  ]},
  {tournament:"VALORANT Champions 2025 (Paris)",intl:true,matches:[
    {date:"2025-09-15",opp:"MIBR",tag:"MIBR",stage:"Opening (B)",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Haven",b:2,o:13,r:"loss"},{n:"Corrode",b:9,o:13,r:"loss"}]},
    {date:"2025-09-20",opp:"Rex Regum Qeon",tag:"RRQ",stage:"Elim (B)",fmt:"Bo3",bs:1,os:2,r:"loss",maps:[{n:"Sunset",b:13,o:7,r:"win"},{n:"Lotus",b:8,o:13,r:"loss"},{n:"Abyss",b:4,o:13,r:"loss"}]}
  ]},
  {tournament:"CEFSCC 2025",intl:true,matches:[
    {date:"2025-11-29",opp:"DRX",tag:"DRX",stage:"(B)",fmt:"Bo1",bs:1,os:0,r:"win",maps:[{n:"Split",b:13,o:11,r:"win"}]},
    {date:"2025-11-29",opp:"Wolves Esports",tag:"WOL",stage:"(B)",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Pearl",b:11,o:13,r:"loss"}]},
    {date:"2025-11-29",opp:"LEVIAT√ÅN",tag:"LEV",stage:"SF",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Split",b:15,o:17,r:"loss"},{n:"Corrode",b:5,o:13,r:"loss"}]},
    {date:"2025-11-30",opp:"EDward Gaming",tag:"EDG",stage:"CF",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Pearl",b:15,o:13,r:"win"},{n:"Split",b:4,o:13,r:"loss"},{n:"Bind",b:15,o:13,r:"win"}]}
  ]},
  {tournament:"Shanghai Esports Masters 2025",intl:false,matches:[
    {date:"2025-12-04",opp:"EDward Gaming",tag:"EDG",stage:"SF",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Pearl",b:7,o:13,r:"loss"},{n:"Haven",b:4,o:13,r:"loss"}]}
  ]},
  {tournament:"Radiant Intl. Invitational 2025",intl:true,matches:[
    {date:"2025-12-18",opp:"Gen.G",tag:"GEN",stage:"D1",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Corrode",b:5,o:13,r:"loss"}]},
    {date:"2025-12-18",opp:"G2 Esports",tag:"G2",stage:"D1",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Corrode",b:3,o:13,r:"loss"}]},
    {date:"2025-12-19",opp:"Paper Rex",tag:"PRX",stage:"D2",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Split",b:9,o:13,r:"loss"}]},
    {date:"2025-12-19",opp:"Nova Esports",tag:"NV",stage:"D2",fmt:"Bo1",bs:0,os:1,r:"loss",maps:[{n:"Pearl",b:11,o:13,r:"loss"}]}
  ]}
  ],
  "2026":[
  {tournament:"VCT 2026: China Kickoff",intl:false,matches:[
    {date:"2026-01-25",opp:"All Gamers",tag:"AG",stage:"UR2",fmt:"Bo3",bs:0,os:2,r:"loss",maps:[{n:"Split",b:10,o:13,r:"loss"},{n:"Abyss",b:3,o:13,r:"loss"}]},
    {date:"2026-01-29",opp:"FunPlus Phoenix",tag:"FPX",stage:"MR1",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Pearl",b:13,o:9,r:"win"},{n:"Bind",b:17,o:15,r:"win"}]},
    {date:"2026-01-30",opp:"Trace Esports",tag:"TE",stage:"MR2",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Abyss",b:13,o:10,r:"win"},{n:"Breeze",b:13,o:11,r:"win"}]},
    {date:"2026-02-04",opp:"EDward Gaming",tag:"EDG",stage:"MR3",fmt:"Bo3",bs:2,os:1,r:"win",maps:[{n:"Abyss",b:13,o:7,r:"win"},{n:"Haven",b:9,o:13,r:"loss"},{n:"Breeze",b:13,o:5,r:"win"}]},
    {date:"2026-02-06",opp:"Dragon Ranger Gaming",tag:"DRG",stage:"MR4",fmt:"Bo3",bs:2,os:0,r:"win",maps:[{n:"Split",b:13,o:6,r:"win"},{n:"Abyss",b:13,o:2,r:"win"}]},
    {date:"2026-02-08",opp:"Xi Lai Gaming",tag:"XLG",stage:"MBF",fmt:"Bo5",bs:2,os:3,r:"loss",maps:[{n:"Abyss",b:16,o:14,r:"win"},{n:"Bind",b:4,o:13,r:"loss"},{n:"Breeze",b:14,o:12,r:"win"},{n:"Pearl",b:11,o:13,r:"loss"},{n:"Split",b:4,o:13,r:"loss"}]},
    {date:"2026-02-09",opp:"EDward Gaming",tag:"EDG",stage:"LBF",fmt:"Bo5",bs:1,os:3,r:"loss",maps:[{n:"Pearl",b:13,o:9,r:"win"},{n:"Haven",b:10,o:13,r:"loss"},{n:"Abyss",b:10,o:13,r:"loss"},{n:"Split",b:6,o:13,r:"loss"}]}
  ]}
  ]
};

let allData=JSON.parse(JSON.stringify(baselineData)),activeYear=String(new Date().getFullYear());

// ===== LOCAL STORAGE PERSISTENCE (ÏûêÎèô ÎèôÍ∏∞Ìôî Îç∞Ïù¥ÌÑ∞ ÏòÅÍµ¨ Ï†ÄÏû•) =====
const LS_KEY='blg_synced_matches';
// Tournament name normalization for localStorage cleanup
const LS_TOURN_NORM={'China Esports Festival Super Champions Cup':'CEFSCC',
  'VALORANT Radiant International Invitational':'Radiant Intl. Invitational',
  'Radiant International Invitational':'Radiant Intl. Invitational',
  'Shanghai Esports Masters':'Shanghai Esports Masters',
  'HERO Asian Champions League':'HERO Asian Champions League'};
function cleanupLocalStorage(){
  try{
    const raw=localStorage.getItem(LS_KEY);if(!raw)return;
    const saved=JSON.parse(raw);let changed=false;
    Object.keys(saved).forEach(yr=>{
      const tourns=saved[yr];if(!tourns)return;
      // Rename tournament names
      tourns.forEach(t=>{
        for(const[pattern,base]of Object.entries(LS_TOURN_NORM)){
          if(t.tournament.includes(pattern)&&!t.tournament.includes(base)){
            t.tournament=base+' '+yr;changed=true;break;
          }
        }
        // Normalize tags
        if(t.matches)t.matches.forEach(m=>{
          const nt=guessTag(m.tag);
          if(nt!==m.tag){m.tag=nt;changed=true}
        });
      });
      // Merge duplicate tournament names
      const merged={};
      tourns.forEach(t=>{
        if(!merged[t.tournament]){merged[t.tournament]=t}
        else{t.matches.forEach(m=>{
          const exists=merged[t.tournament].matches.some(x=>x.date===m.date&&(x.tag===m.tag||x.opp===m.opp));
          if(!exists)merged[t.tournament].matches.push(m);
        });changed=true}
      });
      saved[yr]=Object.values(merged);
    });
    if(changed){localStorage.setItem(LS_KEY,JSON.stringify(saved));console.log('üßπ localStorage ÎåÄÌöåÎ™Ö Ï†ïÎ¶¨ ÏôÑÎ£å')}
  }catch(e){}
}
cleanupLocalStorage();
function loadSyncedMatches(){
  try{
    const raw=localStorage.getItem(LS_KEY);if(!raw)return;
    const saved=JSON.parse(raw);
    let count=0;
    // Cleanup: normalize tags and remove dupes from cached data
    Object.values(saved).forEach(tourns=>tourns.forEach(st=>{
      st.matches=st.matches.filter(sm=>{
        sm.tag=guessTag(sm.tag)||sm.tag; // normalize XE‚ÜíXLG etc
        return true;
      });
    }));
    Object.entries(saved).forEach(([yr,tourns])=>{
      if(!allData[yr])allData[yr]=[];
      tourns.forEach(st=>{
        let tg=allData[yr].find(g=>g.tournament===st.tournament);
        if(!tg){
          const evLc=st.tournament.toLowerCase();
          const TOURN_ALIAS2={'china esports festival super champions cup':'CEFSCC',
            'valorant radiant international invitational':'Radiant Intl. Invitational',
            'radiant international invitational':'Radiant Intl. Invitational',
            'shanghai esports masters':'Shanghai Esports Masters',
            'hero asian champions league':'HERO Asian Champions League'};
          for(const[alias,base]of Object.entries(TOURN_ALIAS2)){
            if(evLc.includes(alias)){tg=allData[yr].find(g=>g.tournament.includes(base));break}
          }
        }
        if(!tg){
          const evLc=st.tournament.toLowerCase();
          tg=allData[yr].find(g=>g.tournament.toLowerCase().includes(evLc.substring(0,15))||evLc.includes(g.tournament.toLowerCase().substring(0,15)));
        }
        if(!tg){tg={tournament:st.tournament,intl:st.intl||false,matches:[]};allData[yr].push(tg)}
        st.matches.forEach(sm=>{
          const exists=tg.matches.some(x=>x.date===sm.date&&(x.tag===sm.tag||x.opp===sm.opp))||
            allData[yr].some(g2=>g2!==tg&&g2.matches.some(x=>x.date===sm.date&&(x.tag===sm.tag||x.opp===sm.opp)));
          if(!exists){tg.matches.push(sm);count++}
        });
      });
    });
    if(count>0)console.log(`üíæ localStorage: ${count}Í∞ú Ï∫êÏãúÎêú Í≤ΩÍ∏∞ Î°úÎìú`);
  }catch(e){console.log('localStorage load fail:',e)}
}
function saveSyncedMatches(newMatches){
  // newMatches = [{yr, tournament, intl, match}]
  try{
    const raw=localStorage.getItem(LS_KEY);
    const saved=raw?JSON.parse(raw):{};
    newMatches.forEach(({yr,tournament,intl,match})=>{
      if(!saved[yr])saved[yr]=[];
      let st=saved[yr].find(t=>t.tournament===tournament);
      if(!st){st={tournament,intl,matches:[]};saved[yr].push(st)}
      const exists=st.matches.some(x=>x.date===match.date&&(x.tag===match.tag||x.opp===match.opp));
      if(!exists)st.matches.push(match);
    });
    localStorage.setItem(LS_KEY,JSON.stringify(saved));
  }catch(e){console.log('localStorage save fail:',e)}
}
function exportBaselineCode(){
  // Generate baselineData-format JS code from ALL matches in allData (baseline + synced)
  let code='const baselineData = {\n';
  Object.keys(allData).sort().forEach(yr=>{
    code+=`  "${yr}":[\n`;
    (allData[yr]||[]).forEach(t=>{
      code+=`  {tournament:${JSON.stringify(t.tournament)},intl:${t.intl},matches:[\n`;
      t.matches.forEach(m=>{
        const mapsStr=m.maps&&m.maps.length?m.maps.map(p=>`{n:${JSON.stringify(p.n)},b:${p.b},o:${p.o},r:"${p.r}"}`).join(','):'';
        code+=`    {date:"${m.date}",opp:${JSON.stringify(m.opp)},tag:"${m.tag}",stage:"${m.stage||''}",fmt:"${m.fmt}",bs:${m.bs},os:${m.os},r:"${m.r}",maps:[${mapsStr}]},\n`;
      });
      code+=`  ]},\n`;
    });
    code+=`  ],\n`;
  });
  code+='};\n';
  return code;
}
function showExportModal(){
  const baseCode=exportBaselineCode();
  const agentCode=exportAgentCode();
  const vodCode=exportVodCode();
  const saved=localStorage.getItem(LS_KEY);
  const savedCount=saved?Object.values(JSON.parse(saved)).reduce((s,ts)=>s+ts.reduce((s2,t)=>s2+t.matches.length,0),0):0;
  const totalCount=Object.values(allData).reduce((s,ya)=>s+ya.reduce((s2,t)=>s2+t.matches.length,0),0);
  const agentStats=_countAgentData();
  const vodStats=_countVodData();
  let h=`<div class="export-modal" onclick="if(event.target===this)this.remove()">
  <div class="export-box">
    <div class="export-header">
      <span>üìã Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
      <button onclick="this.closest('.export-modal').remove()" style="background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer">‚úï</button>
    </div>
    <div class="export-tabs">
      <button class="export-tab active" onclick="_switchExportTab(this,'baseline')">üìä Í≤ΩÍ∏∞<span class="etcnt">${totalCount}</span></button>
      <button class="export-tab" onclick="_switchExportTab(this,'agent')">üéØ ÏóêÏù¥Ï†ÑÌä∏<span class="etcnt">${agentStats.total}Îßµ</span></button>
      <button class="export-tab" onclick="_switchExportTab(this,'vod')">üÖ± VOD<span class="etcnt">${vodStats.total}</span></button>
    </div>
    <div class="export-stats" id="exportStats">
      <span>Ï†ÑÏ≤¥ ${totalCount}Í≤ΩÍ∏∞</span><span>¬∑</span><span style="color:var(--green)">LP Ï∫êÏãú ${savedCount}Í≤ΩÍ∏∞</span>
    </div>
    <textarea class="export-code" id="exportCode" readonly>${baseCode.replace(/</g,'&lt;')}</textarea>
    <div class="export-actions" id="exportActions">
      <button class="export-btn copy" onclick="_copyExport()">üìã ÏΩîÎìú Î≥µÏÇ¨</button>
      <button class="export-btn dl" onclick="_dlExport()">üíæ JS Îã§Ïö¥Î°úÎìú</button>
      <button class="export-btn clear" onclick="localStorage.removeItem('${LS_KEY}');this.textContent='‚úì ÏÇ≠Ï†úÎê®';setTimeout(()=>this.textContent='üóë Ï∫êÏãú ÏÇ≠Ï†ú',1500)">üóë Ï∫êÏãú ÏÇ≠Ï†ú</button>
    </div>
  </div></div>`;
  document.body.insertAdjacentHTML('beforeend',h);
  window._exportData={baseline:baseCode,agent:agentCode,vod:vodCode};
  window._exportTab='baseline';
}
function _switchExportTab(el,tab){
  el.parentElement.querySelectorAll('.export-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  window._exportTab=tab;
  const code=window._exportData[tab]||'';
  document.getElementById('exportCode').value=code;
  const stats=document.getElementById('exportStats');
  const agentStats=_countAgentData();
  const vodStats=_countVodData();
  if(tab==='baseline'){
    const saved=localStorage.getItem(LS_KEY);
    const sc=saved?Object.values(JSON.parse(saved)).reduce((s,ts)=>s+ts.reduce((s2,t)=>s2+t.matches.length,0),0):0;
    const tc=Object.values(allData).reduce((s,ya)=>s+ya.reduce((s2,t)=>s2+t.matches.length,0),0);
    stats.innerHTML=`<span>Ï†ÑÏ≤¥ ${tc}Í≤ΩÍ∏∞</span><span>¬∑</span><span style="color:var(--green)">LP Ï∫êÏãú ${sc}Í≤ΩÍ∏∞</span>`;
  }else if(tab==='agent'){
    stats.innerHTML=`<span>Ï†ÑÏ≤¥ ${agentStats.total}Îßµ</span><span>¬∑</span><span style="color:var(--green)">ÌïòÎìúÏΩîÎî© ${agentStats.hardcoded}Îßµ</span><span>¬∑</span><span style="color:var(--cyan)">Ï∫êÏãú ${agentStats.cached}Îßµ</span>`;
  }else{
    stats.innerHTML=`<span>Ï†ÑÏ≤¥ ${vodStats.total}Í∞ú</span><span>¬∑</span><span style="color:var(--green)">ÌïòÎìúÏΩîÎî© ${vodStats.hardcoded}Í∞ú</span><span>¬∑</span><span style="color:var(--cyan)">ÏûêÎèôÎ∞úÍ≤¨ ${vodStats.auto}Í∞ú</span>`;
  }
}
function _copyExport(){
  const el=document.getElementById('exportCode');
  navigator.clipboard.writeText(el.value);
  const btn=event.target;btn.textContent='‚úì Î≥µÏÇ¨Îê®';setTimeout(()=>btn.textContent='üìã ÏΩîÎìú Î≥µÏÇ¨',1500);
}
function _dlExport(){
  const tab=window._exportTab||'baseline';
  const fnames={baseline:'baselineData.js',agent:'vlr-agents.js',vod:'biliVodMap.js'};
  const code=document.getElementById('exportCode').value;
  const b=new Blob([code],{type:'text/javascript'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fnames[tab]||'export.js';a.click();
}

// ===== ÏóêÏù¥Ï†ÑÌä∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ =====
function exportAgentCode(){
  // Merge: VLR_AGENT_DATA (hardcoded) + liqMatchDetailCache (runtime) + vlr_sync_data (localStorage)
  const merged={};
  // 1) Start with hardcoded
  if(typeof VLR_AGENT_DATA!=='undefined')Object.assign(merged,VLR_AGENT_DATA);
  // 2) Overlay from vlr_sync_data localStorage
  try{const stored=JSON.parse(localStorage.getItem('vlr_sync_data')||'{}');Object.assign(merged,stored)}catch(e){}
  // 3) Overlay from liqMatchDetailCache (runtime LP/VLR data)
  for(const[yr,tgs]of Object.entries(allData)){
    tgs.forEach((tg,ti)=>{
      tg.matches.forEach((m,mi)=>{
        const cacheKey=`${yr}_${ti}_${mi}`;
        const liq=liqMatchDetailCache[cacheKey];
        if(!liq||!liq.maps||!liq.maps.length)return;
        const key=m.date+'_'+m.tag;
        // Only add if has actual agent data (not empty arrays)
        const hasAgents=liq.maps.some(mp=>(mp.t1agents&&mp.t1agents.length>0)||(mp.t2agents&&mp.t2agents.length>0));
        if(!hasAgents)return;
        const blgFirst=liq.blgSide===1;
        merged[key]={p:'',d:liq.maps.map(mp=>({
          m:mp.mapName||'',
          b:blgFirst?(mp.t1agents||[]):(mp.t2agents||[]),
          o:blgFirst?(mp.t2agents||[]):(mp.t1agents||[]),
          bs:blgFirst?(mp.score1||0):(mp.score2||0),
          os:blgFirst?(mp.score2||0):(mp.score1||0)
        }))};
      });
    });
  }
  // Generate code
  const keys=Object.keys(merged).sort();
  let code='const VLR_AGENT_DATA={\n';
  keys.forEach(k=>{
    const v=merged[k];if(!v||!v.d)return;
    code+=JSON.stringify(k)+':'+JSON.stringify(v)+',\n';
  });
  code+='};\n';
  return code;
}
function _countAgentData(){
  let hardcoded=0,total=0;
  if(typeof VLR_AGENT_DATA!=='undefined'){
    Object.values(VLR_AGENT_DATA).forEach(v=>{if(v&&v.d)hardcoded+=v.d.length});
  }
  for(const[yr,tgs]of Object.entries(allData)){
    tgs.forEach((tg,ti)=>{
      tg.matches.forEach((m,mi)=>{
        const ck=`${yr}_${ti}_${mi}`;
        const liq=liqMatchDetailCache[ck];
        if(liq&&liq.maps)total+=liq.maps.filter(mp=>(mp.t1agents&&mp.t1agents.length>0)||(mp.t2agents&&mp.t2agents.length>0)).length;
      });
    });
  }
  return{hardcoded,cached:Math.max(0,total-hardcoded),total};
}

// ===== VOD ÎÇ¥Î≥¥ÎÇ¥Í∏∞ + localStorage =====
const LS_VOD_KEY='blg_vod_cache';
function exportVodCode(){
  // Collect unique BV IDs with their match info
  const entries={};// bvid ‚Üí {tag,date}
  for(const[k,v]of Object.entries(biliVodMap)){
    if(typeof v==='string'&&v.startsWith('BV')){
      // k is "BLG vs TAG DATE" or "TAG vs BLG DATE"
      const m=k.match(/(?:BLG vs (\S+)|(\S+) vs BLG) (\d{4}-\d{2}-\d{2})/);
      if(m){
        const tag=m[1]||m[2],date=m[3];
        if(!entries[v])entries[v]={tag,date};
      }
    }else if(typeof v==='object'&&v.tag){
      entries[k]={tag:v.tag,date:v.date};
    }
  }
  // Sort by date desc
  const sorted=Object.entries(entries).sort(([,a],[,b])=>b.date.localeCompare(a.date));
  let code='const biliVodMap={\n';
  let prevYear='';
  sorted.forEach(([bv,info])=>{
    const yr=info.date.substring(0,4);
    if(yr!==prevYear){code+=`// ${yr}\n`;prevYear=yr}
    code+=`'BLG vs ${info.tag} ${info.date}':'${bv}','${info.tag} vs BLG ${info.date}':'${bv}',\n`;
  });
  code+='};\n';
  return code;
}
function _countVodData(){
  const hardcodedBvs=new Set(),allBvs=new Set();
  // Count hardcoded (entries that existed on page load)
  for(const[k,v]of Object.entries(biliVodMap)){
    if(typeof v==='string'&&v.startsWith('BV'))allBvs.add(v);
  }
  // newVodBvids tracks auto-discovered ones
  const autoCnt=newVodBvids.size;
  const totalUnique=allBvs.size;
  return{hardcoded:totalUnique-autoCnt,auto:autoCnt,total:totalUnique};
}
// VOD localStorage: save auto-found VODs
function saveVodCache(){
  try{
    const toSave={};
    newVodBvids.forEach(bv=>{
      const info=biliVodMap[bv];
      if(info&&info.tag)toSave[bv]={tag:info.tag,date:info.date};
    });
    // Merge with existing cache
    const existing=JSON.parse(localStorage.getItem(LS_VOD_KEY)||'{}');
    Object.assign(existing,toSave);
    localStorage.setItem(LS_VOD_KEY,JSON.stringify(existing));
  }catch(e){}
}
function restoreVodCache(){
  try{
    const cached=JSON.parse(localStorage.getItem(LS_VOD_KEY)||'{}');
    let cnt=0;
    for(const[bv,info]of Object.entries(cached)){
      if(!info.tag||!info.date)continue;
      if(Object.values(biliVodMap).includes(bv))continue;
      const k1=`BLG vs ${info.tag} ${info.date}`,k2=`${info.tag} vs BLG ${info.date}`;
      biliVodMap[k1]=bv;biliVodMap[k2]=bv;biliVodMap[bv]=info;
      cnt++;
    }
    if(cnt)console.log(`üÖ± VOD Ï∫êÏãú Î≥µÏõê: ${cnt}Í∞ú`);
  }catch(e){}
}
loadSyncedMatches();

// Ensure current year exists
if(!allData[activeYear])allData[activeYear]=[];
// If current year has no data yet, also show latest year with data
const _latestWithData=Object.keys(allData).sort((a,b)=>b-a).find(y=>(allData[y]||[]).some(t=>t.matches.length>0));
if(_latestWithData&&(!allData[activeYear]||!allData[activeYear].some(t=>t.matches.length>0)))activeYear=_latestWithData;

function cs(yf){let w=0,l=0,mw=0,ml=0;(yf==='all'?Object.keys(allData):[yf]).forEach(y=>(allData[y]||[]).forEach(t=>t.matches.forEach(m=>{m.r==='win'?w++:l++;mw+=m.bs;ml+=m.os})));const t=w+l;return{w,l,mw,ml,total:t,wr:t?Math.round(w/t*100):0}}
function cys(y){let w=0,l=0;(allData[y]||[]).forEach(t=>t.matches.forEach(m=>m.r==='win'?w++:l++));return{w,l,total:w+l}}

function renderStats(){const s=cs(activeYear);document.getElementById('statsBar').innerHTML=`<div class="si"><div class="sv bc">${s.total}</div><div class="sl">Ï¥ù Í≤ΩÍ∏∞</div></div><div class="si"><div class="sv wc">${s.w}</div><div class="sl">ÏäπÎ¶¨</div></div><div class="si"><div class="sv lc">${s.l}</div><div class="sl">Ìå®Î∞∞</div></div><div class="si"><div class="sv bc">${s.wr}%</div><div class="sl">ÏäπÎ•†</div></div><div class="si"><div class="sv" style="color:var(--txt)">${s.mw}<span style="color:var(--dimmer)">:</span>${s.ml}</div><div class="sl">Îßµ Ïä§ÏΩîÏñ¥</div></div>`}

function renderYearTabs(){const yrs=Object.keys(allData).sort((a,b)=>b-a);let h='';yrs.forEach(y=>{const s=cys(y);h+=`<button class="yt ${y===activeYear?'active':''}" data-year="${y}">${y}<span class="cnt">${s.total}</span></button>`});document.getElementById('yearTabs').innerHTML=h;document.querySelectorAll('.yt').forEach(b=>{b.onclick=()=>{activeYear=b.dataset.year;renderAll()}})}

function mapHTML(maps){if(!maps||!maps.length)return'<div style="padding:12px;text-align:center;color:var(--dimmer);font-size:12px">Îßµ ÏÉÅÏÑ∏ Ïä§ÏΩîÏñ¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>';let h=`<div class="dms"><div class="dmt">ÎßµÎ≥Ñ ÏÉÅÏÑ∏ Í≤∞Í≥º</div>`;maps.forEach((mp,i)=>{const w=mp.r==='win',t=(mp.b||0)+(mp.o||0)||1,p=Math.round(((mp.b||0)/t)*100);h+=`<div class="md"><div class="md-n">MAP ${i+1}</div><div class="md-m">${mp.n}</div><div class="md-bw"><div class="md-bar"><div class="md-bf ${w?'bw':'bl'}" style="width:${p}%"></div></div></div><div class="md-s"><span class="${w?'mws':'mls'}">${mp.b}</span><span class="msp">:</span><span class="${w?'mls':'mws'}">${mp.o}</span></div><div class="md-r ${w?'rw':'rl'}">${w?'W':'L'}</div></div>`});return h+'</div>'}

function detHTML(m,tn,il){const narr=fbNarr(m,tn);
// Check LP detail cache
const key=Object.keys(liqMatchDetailCache).find(k=>{const[y2,ti2,mi2]=k.split('_');const t2=allData[y2]?.[ti2];return t2&&t2.matches[mi2]===m});
const liq=key?liqMatchDetailCache[key]:null;
// Find key for this match (for button id)
let btnKey='';
for(const y of Object.keys(allData)){const ts=allData[y];for(let ti=0;ti<ts.length;ti++){const t=ts[ti];for(let mi=0;mi<t.matches.length;mi++){if(t.matches[mi]===m){btnKey=`${y}_${ti}_${mi}`;break}}}}

let h=mapHTMLEx(m.maps,liq,m);
if(liq?.veto?.length)h+=`<div class="liq-veto"><span class="veto-label">MAP VETO</span><div class="veto-flow">${liq.veto.map(v=>`<span class="veto-step"><span class="vt1">${v.t1||''}</span><span class="vact">${v.action}</span><span class="vt2">${v.t2||''}</span></span>`).join('')}</div></div>`;
h+=`<div class="dn"><div class="dnt">Í≤ΩÍ∏∞ Î∂ÑÏÑù</div><div class="dtx">${narr}</div></div>`;
h+=`<div class="dmeta"><span class="mt">${tn}</span><span class="mt">${m.fmt}</span><span class="mt">${m.stage}</span><span class="mt ${m.r==='win'?'mtwn':'mtls'}">${m.r==='win'?'‚úì ÏäπÎ¶¨':'‚úó Ìå®Î∞∞'}</span>${il?'<span class="mt mtil">üåç Íµ≠Ï†ú ÎåÄÌöå</span>':''}<span class="mt">${m.date}</span>`;
if(!liq&&LP_TOURN_MAP[tn]){h+=`<button class="mt liq-load-btn" id="liq-btn-${btnKey}" onclick="event.stopPropagation();loadLiqDetail(${btnKey.replace(/_/g,',')})">üì° ÏóêÏù¥Ï†ÑÌä∏ Î∂àÎü¨Ïò§Í∏∞</button>`}
else if(liq){h+=`<span class="mt" style="background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.2);color:#00e5a0">üì° Liquipedia ‚úì</span>`}
h+=`</div>`;return h}

function mapHTMLEx(maps,liq,match){if(!maps||!maps.length)return'<div style="padding:12px;text-align:center;color:var(--dimmer);font-size:12px">Îßµ ÏÉÅÏÑ∏ Ïä§ÏΩîÏñ¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
const blgSide=liq?.blgSide||1;
let h=`<div class="dms"><div class="dmt">ÎßµÎ≥Ñ ÏÉÅÏÑ∏ Í≤∞Í≥º</div>`;
maps.forEach((mp,i)=>{const w=mp.r==='win',t=(mp.b||0)+(mp.o||0)||1,p=Math.round(((mp.b||0)/t)*100);
// Find matching agent map by NAME first, index fallback
let lm=null;
if(liq?.maps){lm=liq.maps.find(g=>g.mapName&&(g.mapName===mp.n||g.mapName.includes(mp.n)))||liq.maps[i]||null}
const blgAgents=lm?(blgSide===1?lm.t1agents:lm.t2agents):[];
const oppAgents=lm?(blgSide===1?lm.t2agents:lm.t1agents):[];
h+=`<div class="md"><div class="md-n">MAP ${i+1}</div><div class="md-m">${mp.n}</div><div class="md-bw"><div class="md-bar"><div class="md-bf ${w?'bw':'bl'}" style="width:${p}%"></div></div></div><div class="md-s"><span class="${w?'mws':'mls'}">${mp.b}</span><span class="msp">:</span><span class="${w?'mls':'mws'}">${mp.o}</span></div><div class="md-r ${w?'rw':'rl'}">${w?'W':'L'}</div>`;
if(blgAgents.length||oppAgents.length){
  h+=`<div class="md-agents"><div class="ag-row"><span class="ag-side blg">BLG</span>${blgAgents.map(a=>agentImg(a,22)).join(' ')}</div>`;
  h+=`<div class="ag-row"><span class="ag-side opp">${DT(match.tag)}</span>${oppAgents.map(a=>agentImg(a,22)).join(' ')}</div>`;
  h+=`</div>`;
}
h+=`</div>`});return h+'</div>'}

function fbNarr(m,tn){const w=m.r==='win',mt=m.maps&&m.maps.length?m.maps.map((p,i)=>`<strong>Map ${i+1} (${p.n})</strong> ${p.b}-${p.o} ${p.r==='win'?'ÏäπÎ¶¨':'Ìå®Î∞∞'}`).join(', ')+'.':'';return w?`<strong>BLG</strong>Í∞Ä <strong>${tn} ${m.stage}</strong>ÏóêÏÑú <strong>${m.opp}</strong>Î•º <strong>${m.bs}:${m.os}</strong>ÏúºÎ°ú Í∫æÏóàÏäµÎãàÎã§. ${mt} ÌåÄ Ï†ÑÏ≤¥Ï†ÅÏúºÎ°ú ÏïàÏ†ïÏ†ÅÏù∏ Ìï©ÏùÑ Î≥¥Ïó¨Ï£ºÎ©∞ ÏäπÎ¶¨Î•º Í∞ÄÏ†∏Í∞îÏäµÎãàÎã§.`:`<strong>BLG</strong>Í∞Ä <strong>${tn} ${m.stage}</strong>ÏóêÏÑú <strong>${m.opp}</strong>ÏóêÍ≤å <strong>${m.bs}:${m.os}</strong>ÏúºÎ°ú Ìå®Î∞∞ÌñàÏäµÎãàÎã§. ${mt} ÏïÑÏâ¨Ïö¥ Í≤∞Í≥ºÏßÄÎßå Îã§Ïùå Í≤ΩÍ∏∞ÏóêÏÑúÏùò Î∞òÎì±Ïù¥ Í∏∞ÎåÄÎê©ÎãàÎã§.`}

function toggleDetail(wid,y,ti,mi){const wrap=document.getElementById(wid);const open=wrap.classList.contains('open');document.querySelectorAll('.mw.open').forEach(el=>{if(el.id!==wid)el.classList.remove('open')});if(open){wrap.classList.remove('open');return}
wrap.classList.add('open');const panel=wrap.querySelector('.di'),t=allData[String(y)][ti],m=t.matches[mi];
panel.innerHTML=detHTML(m,t.tournament,t.intl);setTimeout(()=>{wrap.querySelectorAll('.md-bf').forEach(el=>{const w=el.style.width;el.style.width='0%';requestAnimationFrame(()=>el.style.width=w)})},50)}

// ===== BILIBILI VOD MAP (Í≥µÏãù Ï±ÑÎÑê: Êó†ÁïèÂ•ëÁ∫¶Ëµõ‰∫ã, UID:2071691173) =====
const biliVodMap={
// 2026 VCT CN Kickoff
'BLG vs EDG 2026-02-09':'BV1rTcMzCEUv','EDG vs BLG 2026-02-09':'BV1rTcMzCEUv',
'XLG vs BLG 2026-02-08':'BV1xxcFzbEA7','BLG vs XLG 2026-02-08':'BV1xxcFzbEA7',
'DRG vs BLG 2026-02-06':'BV1hBF6zUEXm','BLG vs DRG 2026-02-06':'BV1hBF6zUEXm',
'EDG vs BLG 2026-02-04':'BV1PLfoB1ENV','BLG vs EDG 2026-02-04':'BV1PLfoB1ENV',
'TE vs BLG 2026-01-30':'BV1sT6qByExf','BLG vs TE 2026-01-30':'BV1sT6qByExf',
'FPX vs BLG 2026-01-29':'BV1Vm6wB8Em4','BLG vs FPX 2026-01-29':'BV1Vm6wB8Em4',
'BLG vs AG 2026-01-25':'BV14wzQBnEWW','AG vs BLG 2026-01-25':'BV14wzQBnEWW',
// 2025 Radiant Intl. Invitational
'NOVA vs BLG 2025-12-19':'BV1LABcB9EQC','BLG vs NOVA 2025-12-19':'BV1LABcB9EQC',
'PRX vs BLG 2025-12-19':'BV1B3qZBDE1y','BLG vs PRX 2025-12-19':'BV1B3qZBDE1y',
'BLG vs G2 2025-12-18':'BV15oqHBLEvM','G2 vs BLG 2025-12-18':'BV15oqHBLEvM',
'BLG vs GEN 2025-12-18':'BV1HpqpB4Efs','GEN vs BLG 2025-12-18':'BV1HpqpB4Efs',
// 2025 Champions (Paris)
'BLG vs RRQ 2025-09-20':'BV1NHpRzTEQQ','RRQ vs BLG 2025-09-20':'BV1NHpRzTEQQ',
'BLG vs MIBR 2025-09-15':'BV1eVpBzqEqM','MIBR vs BLG 2025-09-15':'BV1eVpBzqEqM',
// 2025 Evolution Series Act 3
'WOL vs BLG 2025-08-29':'BV1K8hdzFEKe','BLG vs WOL 2025-08-29':'BV1K8hdzFEKe',
// 2025 VCT CN Stage 2
'DRG vs BLG 2025-08-24':'BV1uneJzgEaZ','BLG vs DRG 2025-08-24':'BV1uneJzgEaZ',
'BLG vs EDG 2025-08-23':'BV1neeBzVEVw','EDG vs BLG 2025-08-23':'BV1neeBzVEVw',
'BLG vs DRG 2025-08-22':'BV1r8e4zjE9V','DRG vs BLG 2025-08-22':'BV1r8e4zjE9V',
'BLG vs TYL 2025-08-20':'BV1MKe3zmEQD','TYL vs BLG 2025-08-20':'BV1MKe3zmEQD',
'BLG vs EDG 2025-08-03':'BV1knhVzNEwH','EDG vs BLG 2025-08-03':'BV1knhVzNEwH',
'BLG vs TE 2025-07-26':'BV1sL88zmEA6','TE vs BLG 2025-07-26':'BV1sL88zmEA6',
'TEC vs BLG 2025-07-23':'BV14c8Az5E2i','BLG vs TEC 2025-07-23':'BV14c8Az5E2i',
'JDG vs BLG 2025-07-18':'BV1PFu2zGE1x','BLG vs JDG 2025-07-18':'BV1PFu2zGE1x',
'BLG vs TYL 2025-07-04':'BV1er3jzUEQv','TYL vs BLG 2025-07-04':'BV1er3jzUEQv',
// 2025 EWC
'KC vs BLG 2025-07-10':'BV177GGzCEaP','BLG vs KC 2025-07-10':'BV177GGzCEaP',
'BLG vs G2 2025-07-09':'BV1RHGczgEC5','G2 vs BLG 2025-07-09':'BV1RHGczgEC5',
'PRX vs BLG 2025-07-08':'BV1ckGJzzExu','BLG vs PRX 2025-07-08':'BV1ckGJzzExu',
// 2025 Masters Toronto
'BLG vs WOL 2025-06-12':'BV1FVMHzYEZ3','WOL vs BLG 2025-06-12':'BV1FVMHzYEZ3',
'BLG vs SEN 2025-06-10':'BV1nLTBzGEDP','SEN vs BLG 2025-06-10':'BV1nLTBzGEDP',
'BLG vs TL 2025-06-08':'BV1VTTUztEoq','TL vs BLG 2025-06-08':'BV1VTTUztEoq',
// 2025 HERO ACL
'BLG vs DRX 2025-05-16':'BV1zhEtz6EBw','DRX vs BLG 2025-05-16':'BV1zhEtz6EBw',
'TE vs BLG 2025-05-15':'BV1PLE2zeE7d','BLG vs TE 2025-05-15':'BV1PLE2zeE7d',
'BLG vs DRX 2025-05-14':'BV1SbEBzQEMF','DRX vs BLG 2025-05-14':'BV1SbEBzQEMF',
// 2025 Evolution Series
'TEC vs BLG 2025-05-08':'BV1xk5Pz3Ern','BLG vs TEC 2025-05-08':'BV1xk5Pz3Ern',
// 2025 VCT CN Stage 1
'XLG vs BLG 2025-05-04':'BV1W5VwzZEEk','BLG vs XLG 2025-05-04':'BV1W5VwzZEEk',
'WOL vs BLG 2025-05-03':'BV1YgVHzAEVP','BLG vs WOL 2025-05-03':'BV1YgVHzAEVP',
'BLG vs EDG 2025-05-02':'BV16fV3zUEwh','EDG vs BLG 2025-05-02':'BV16fV3zUEwh',
'BLG vs TE 2025-04-20':'BV139LFz3EBH','TE vs BLG 2025-04-20':'BV139LFz3EBH',
'BLG vs WOL 2025-04-19':'BV1sr5szaERQ','WOL vs BLG 2025-04-19':'BV1sr5szaERQ',
'BLG vs TE 2025-04-12':'BV1wbdaYzE5h','TE vs BLG 2025-04-12':'BV1wbdaYzE5h',
'BLG vs WOL 2025-04-04':'BV1ooZRYvEqQ','WOL vs BLG 2025-04-04':'BV1ooZRYvEqQ',
'AG vs BLG 2025-03-30':'BV1koZBYhEuv','BLG vs AG 2025-03-30':'BV1koZBYhEuv',
'BLG vs JDG 2025-03-23':'BV1jeXaYsEjN','JDG vs BLG 2025-03-23':'BV1jeXaYsEjN',
'XLG vs BLG 2025-03-13':'BV1nyQwYGEus','BLG vs XLG 2025-03-13':'BV1nyQwYGEus',
// 2025 Evolution Act 1
'BLG vs JDG 2025-02-15':'BV1wjANeEEbx','JDG vs BLG 2025-02-15':'BV1wjANeEEbx',
'BLG vs NOVA 2025-02-14':'BV1utKKe6Ek3','NOVA vs BLG 2025-02-14':'BV1utKKe6Ek3',
'BLG vs TYL 2025-02-10':'BV1KHNZekEWn','TYL vs BLG 2025-02-10':'BV1KHNZekEWn',
// 2025 VCT CN Kickoff
'BLG vs EDG 2025-01-24':'BV1fHfHY5Ext','EDG vs BLG 2025-01-24':'BV1fHfHY5Ext',
'BLG vs TE 2025-01-23':'BV1QEfVY5ECE','TE vs BLG 2025-01-23':'BV1QEfVY5ECE',
'FPX vs BLG 2025-01-20':'BV1PowHewExj','BLG vs FPX 2025-01-20':'BV1PowHewExj',
'BLG vs XLG 2025-01-16':'BV1YMwje8EYq','XLG vs BLG 2025-01-16':'BV1YMwje8EYq',
// 2024 Asian Invitational
'TE vs BLG 2024-11-24':'BV1biBxYZEXq','BLG vs TE 2024-11-24':'BV1biBxYZEXq',
'DRX vs BLG 2024-11-22':'BV1zjBqY3ESQ','BLG vs DRX 2024-11-22':'BV1zjBqY3ESQ',
// 2024 FGC
'BLG vs WOL 2024-11-10':'BV154m6YeEBz','WOL vs BLG 2024-11-10':'BV154m6YeEBz',
'WOL vs BLG 2024-11-08':'BV1vADZY9EYS','BLG vs WOL 2024-11-08':'BV1vADZY9EYS',
'BLG vs NOVA 2024-11-06':'BV1KkDVYJEBk','NOVA vs BLG 2024-11-06':'BV1KkDVYJEBk',
'BLG vs XLG 2024-11-01':'BV1mQSoYMENM','XLG vs BLG 2024-11-01':'BV1mQSoYMENM',
// 2024 Champions (Seoul)
'BLG vs KR√ú 2024-08-08':'BV12f421q7GV','KR√ú vs BLG 2024-08-08':'BV12f421q7GV',
'FNC vs BLG 2024-08-02':'BV1Cz421i7XG','BLG vs FNC 2024-08-02':'BV1Cz421i7XG',
// 2024 VCT CN Stage 2
'FPX vs BLG 2024-07-18':'BV1KS421d7Nz','BLG vs FPX 2024-07-18':'BV1KS421d7Nz',
'EDG vs BLG 2024-07-17':'BV1nz421q7DL','BLG vs EDG 2024-07-17':'BV1nz421q7DL',
'JDG vs BLG 2024-07-16':'BV1yr421T76t','BLG vs JDG 2024-07-16':'BV1yr421T76t',
'EDG vs BLG 2024-07-06':'BV1TT421k73r','BLG vs EDG 2024-07-06':'BV1TT421k73r',
'BLG vs DRG 2024-06-30':'BV1ey411q775','DRG vs BLG 2024-06-30':'BV1ey411q775',
'NOVA vs BLG 2024-06-23':'BV11r421F7du','BLG vs NOVA 2024-06-23':'BV11r421F7du',
'BLG vs WOL 2024-06-16':'BV1ES421d7KH','WOL vs BLG 2024-06-16':'BV1ES421d7KH',
// 2024 VCT CN Stage 1
'BLG vs FPX 2024-05-04':'BV1Mm411y7XQ','FPX vs BLG 2024-05-04':'BV1Mm411y7XQ',
'BLG vs JDG 2024-04-28':'BV1T142197mu','JDG vs BLG 2024-04-28':'BV1T142197mu',
'TEC vs BLG 2024-04-26':'BV1im421s7xu','BLG vs TEC 2024-04-26':'BV1im421s7xu',
'BLG vs AG 2024-04-20':'BV1WD421H7B9','AG vs BLG 2024-04-20':'BV1WD421H7B9',
'TE vs BLG 2024-04-13':'BV1kJ4m1V7Wv','BLG vs TE 2024-04-13':'BV1kJ4m1V7Wv',
'BLG vs TYL 2024-04-05':'BV18J4m1j7JE','TYL vs BLG 2024-04-05':'BV18J4m1j7JE',
// 2024 VCT CN Kickoff
'BLG vs TE 2024-02-27':'BV1Az421X7jZ','TE vs BLG 2024-02-27':'BV1Az421X7jZ',
'BLG vs TEC 2024-02-27':'BV1XC411W7n8','TEC vs BLG 2024-02-27':'BV1XC411W7n8',
'WOL vs BLG 2024-02-26':'BV1xK421t7ER','BLG vs WOL 2024-02-26':'BV1xK421t7ER',
'WOL vs BLG 2024-02-23':'BV1oj421D7RY','BLG vs WOL 2024-02-23':'BV1oj421D7RY',
// 2025 CEFSCC + Shanghai Esports Masters
'BLG vs DRX 2025-11-29':'BV1pBSFBcE4e','DRX vs BLG 2025-11-29':'BV1pBSFBcE4e',
'BLG vs WOL 2025-11-29':'BV1rwSwBYER8','WOL vs BLG 2025-11-29':'BV1rwSwBYER8',
'BLG vs LEV 2025-11-29':'BV13VSTBhEgT','LEV vs BLG 2025-11-29':'BV13VSTBhEgT',
'BLG vs EDG 2025-11-30':'BV1GwSvBkEKh','EDG vs BLG 2025-11-30':'BV1GwSvBkEKh',
'BLG vs EDG 2025-12-04':'BV1X72iBzE3j','EDG vs BLG 2025-12-04':'BV1X72iBzE3j',
// 2023 FGC Qualifier Act 1 (Î©ÄÌã∞ÌååÌä∏ ÏòÅÏÉÅ)
'BLG vs iG 2023-02-23':'BV1P54y1w73Q','iG vs BLG 2023-02-23':'BV1P54y1w73Q',
'BLG vs TYL 2023-02-24':'BV1Nj411F7Ue','TYL vs BLG 2023-02-24':'BV1Nj411F7Ue',
'BLG vs O3O 2023-03-02':'BV1W84y1P7Um','O3O vs BLG 2023-03-02':'BV1W84y1P7Um',
'BLG vs RNG 2023-03-03':'BV17Y41167uS','RNG vs BLG 2023-03-03':'BV17Y41167uS',
'BLG vs RA 2023-03-04':'BV1V24y1G7E3','RA vs BLG 2023-03-04':'BV1V24y1G7E3',
'BLG vs iNv 2023-03-05':'BV1Ls4y157GX','iNv vs BLG 2023-03-05':'BV1Ls4y157GX',
// 2023 FGC Invitational Act 1
'BLG vs NTER 2023-03-22':'BV12m4y1k7eY','NTER vs BLG 2023-03-22':'BV12m4y1k7eY',
'BLG vs EDG 2023-03-24':'BV12L411Q78Z','EDG vs BLG 2023-03-24':'BV12L411Q78Z',
'BLG vs DRG 2023-03-26':'BV1Fh411V7us','DRG vs BLG 2023-03-26':'BV1Fh411V7us',
'BLG vs TTG 2023-03-30':'BV1HM4y1U71q','TTG vs BLG 2023-03-30':'BV1HM4y1U71q',
'BLG vs TYL 2023-04-02':'BV1eo4y1H73b','TYL vs BLG 2023-04-02':'BV1eo4y1H73b',
// 2023 FGC Qualifier Act 2 (Î©ÄÌã∞ÌååÌä∏ ÏòÅÏÉÅ)
'BLG vs 4AM 2023-04-13':'BV14c411n7fr','4AM vs BLG 2023-04-13':'BV14c411n7fr',
'BLG vs NOP 2023-04-14':'BV1yo4y187re','NOP vs BLG 2023-04-14':'BV1yo4y187re',
'BLG vs RA 2023-04-15':'BV1xP411S7dc','RA vs BLG 2023-04-15':'BV1xP411S7dc',
'BLG vs JJH 2023-04-16':'BV1Ph4y1s7xE','JJH vs BLG 2023-04-16':'BV1Ph4y1s7xE',
'BLG vs NH 2023-04-18':'BV16M411L7b2','NH vs BLG 2023-04-18':'BV16M411L7b2',
'BLG vs KZ 2023-04-20':'BV1xs4y1d7X4','KZ vs BLG 2023-04-20':'BV1xs4y1d7X4',
'BLG vs GK 2023-04-22':'BV1Yo4y1b7nC','GK vs BLG 2023-04-22':'BV1Yo4y1b7nC',
'BLG vs RNG 2023-04-23':'BV19s4y1d7Nm','RNG vs BLG 2023-04-23':'BV19s4y1d7Nm',
// 2023 FGC Invitational Act 2
'BLG vs DYG 2023-05-03':'BV1414y1Z7Rp','DYG vs BLG 2023-05-03':'BV1414y1Z7Rp',
'BLG vs ASE 2023-05-11':'BV1Kh4y1871v','ASE vs BLG 2023-05-11':'BV1Kh4y1871v',
'BLG vs NTER 2023-05-17':'BV13V4y1k7j2','NTER vs BLG 2023-05-17':'BV13V4y1k7j2',
'BLG vs FPX 2023-05-18':'BV17o4y1G7Nb','FPX vs BLG 2023-05-18':'BV17o4y1G7Nb',
'BLG vs ASE 2023-05-19':'BV1rg4y1F7sU','ASE vs BLG 2023-05-19':'BV1rg4y1F7sU',
'BLG vs EDG 2023-05-21':'BV14o4y1G7v4','EDG vs BLG 2023-05-21':'BV14o4y1G7v4',
// 2023 Evolution Series Act 2 OQ
'BLG vs XLG 2023-10-05':'BV1Xw411C7Fd','XLG vs BLG 2023-10-05':'BV1Xw411C7Fd',
'BLG vs DRG 2023-10-06':'BV1T34y137Rr','DRG vs BLG 2023-10-06':'BV1T34y137Rr',
'BLG vs AG 2023-10-07':'BV1uw411r7PJ','AG vs BLG 2023-10-07':'BV1uw411r7PJ',
'BLG vs TES 2023-10-08':'BV1M84y1U7sM','TES vs BLG 2023-10-08':'BV1M84y1U7sM',
// 2023 Evolution Series Act 3 OQ
'BLG vs VLG 2023-11-02':'BV16a4y1X72G','VLG vs BLG 2023-11-02':'BV16a4y1X72G',
'BLG vs TEC 2023-11-03':'BV1cw411B7Q6','TEC vs BLG 2023-11-03':'BV1cw411B7Q6',
// 2023 Evolution Series Act 3
'TEC vs BLG 2023-11-21':'BV1EC4y117gz','BLG vs TEC 2023-11-21':'BV1EC4y117gz',
'ASE vs BLG 2023-11-19':'BV14g4y1X7o8','BLG vs ASE 2023-11-19':'BV14g4y1X7o8',
'BLG vs LGD 2023-11-16':'BV1Mz4y1c7Mj','LGD vs BLG 2023-11-16':'BV1Mz4y1c7Mj',
'BLG vs RNG 2023-11-07':'BV1DQ4y1n7nw','RNG vs BLG 2023-11-07':'BV1DQ4y1n7nw',
'NWG vs BLG 2023-11-06':'BV1Ge411X7XE','BLG vs NWG 2023-11-06':'BV1Ge411X7XE',
// 2023 Evolution Series Act 2
'BLG vs TE 2023-10-24':'BV1Vu4y1n7FL','TE vs BLG 2023-10-24':'BV1Vu4y1n7FL',
'BLG vs EDG 2023-10-22':'BV1Kp4y1M7Z5','EDG vs BLG 2023-10-22':'BV1Kp4y1M7Z5',
'BLG vs TE 2023-10-21':'BV1B34y1M7aj','TE vs BLG 2023-10-21':'BV1B34y1M7aj',
'RNG vs BLG 2023-10-12':'BV1mG411m7rh','BLG vs RNG 2023-10-12':'BV1mG411m7rh',
'NIP vs BLG 2023-10-10':'BV1PH4y1R7g3','BLG vs NIP 2023-10-10':'BV1PH4y1R7g3',
// 2023 Evolution Series Act 1
'BLG vs TE 2023-09-28':'BV1ZH4y1o792','TE vs BLG 2023-09-28':'BV1ZH4y1o792',
'FPX vs BLG 2023-09-26':'BV1MC4y1f7C1','BLG vs FPX 2023-09-26':'BV1MC4y1f7C1',
'BLG vs WBG 2023-09-24':'BV1Ww411m7tp','WBG vs BLG 2023-09-24':'BV1Ww411m7tp',
// 2023 Champions (LA) + CQ
'BLG vs EDG 2023-08-19':'BV1cz4y1u77g','EDG vs BLG 2023-08-19':'BV1cz4y1u77g',
'DRX vs BLG 2023-08-18':'BV1m8411972F','BLG vs DRX 2023-08-18':'BV1m8411972F',
'BLG vs NRG 2023-08-14':'BV1au411E71o','NRG vs BLG 2023-08-14':'BV1au411E71o',
'FNC vs BLG 2023-08-10':'BV1aj411z7pH','BLG vs FNC 2023-08-10':'BV1aj411z7pH',
'NRG vs BLG 2023-08-09':'BV1w8411R7Y7','BLG vs NRG 2023-08-09':'BV1w8411R7Y7',
'EDG vs BLG 2023-07-16':'BV118411U7fD','BLG vs EDG 2023-07-16':'BV118411U7fD',
'BLG vs FPX 2023-07-15':'BV1hx4y1o7PL','FPX vs BLG 2023-07-15':'BV1hx4y1o7PL',
'BLG vs EDG 2023-07-13':'BV1tz4y177SS','EDG vs BLG 2023-07-13':'BV1tz4y177SS',
'BLG vs TE 2023-07-08':'BV1cP411y7KL','TE vs BLG 2023-07-08':'BV1cP411y7KL',
'BLG vs ME 2023-07-05':'BV1wu41187NT','ME vs BLG 2023-07-05':'BV1wu41187NT',
};
// SOOP VOD map (sooplive.co.kr platform)
const soopVodMap={
  '2024-12-11_DRX':{maps:[
    {label:'Map 1',url:'https://vod.sooplive.co.kr/player/144861407'},
    {label:'Map 2',url:'https://vod.sooplive.co.kr/player/144868909'}
  ]},
  '2024-12-13_NRG':{url:'https://vod.sooplive.co.kr/player/145035379',note:'Ï†ÑÏ≤¥ Í≤ΩÍ∏∞ (ÌÉÄÏûÑÎùºÏù∏ Ï∞∏Í≥†)'}
};
function findSoopVod(tag,date){return soopVodMap[date+'_'+tag]||null}
// Multi-part Bilibili videos (FGC ÏòàÏÑ† ‚Äî Ïó¨Îü¨ Í≤ΩÍ∏∞Í∞Ä Ìïú ÏòÅÏÉÅÏóê ÏûàÏùå, BLG ÌååÌä∏Îßå ÌïÑÌÑ∞)
const multiPartBvids=new Set([
  'BV1P54y1w73Q','BV1Nj411F7Ue','BV1W84y1P7Um','BV17Y41167uS','BV1V24y1G7E3','BV1Ls4y157GX',
  'BV14c411n7fr','BV1yo4y187re','BV1xP411S7dc','BV1Ph4y1s7xE','BV16M411L7b2','BV1xs4y1d7X4','BV1Yo4y1b7nC','BV19s4y1d7Nm'
]);
const cnTeamNames={
  'All Gamers':'AG','AG':'AG','FunPlus Phoenix':'FPX','FPX':'FPX',
  'Trace Esports':'TE','TE':'TE','EDward Gaming':'EDG','EDG':'EDG',
  'Dragon Ranger Gaming':'DRG','DRG':'DRG','Xi Lai Gaming':'XLG','XLG':'XLG',
  'TYLOO':'TYL','TYL':'TYL','JDG Esports':'JDG','JDG':'JDG',
  'Wolves Esports':'WOL','WOL':'WOL','Nova Esports':'NV','NOVA':'NV','NV':'NV',
  'Titan Esports Club':'TEC','TEC':'TEC',
  'Paper Rex':'PRX','PRX':'PRX','G2 Esports':'G2','G2':'G2',
  'Gen.G':'GEN','GEN':'GEN','Sentinels':'SEN','SEN':'SEN',
  'Team Liquid':'TL','TL':'TL','Karmine Corp':'KC','KC':'KC',
  'MIBR':'MIBR','RRQ':'RRQ','Fnatic':'FNC','FNC':'FNC',
  'NRG Esports':'NRG','NRG':'NRG','DRX':'DRX','KR√ú Esports':'KR√ú','KR√ú':'KR√ú',
  'Rex Regum Qeon':'RRQ','Leviat√°n':'LEV','LEV':'LEV',
  'Nongshim RedForce':'NS','NS':'NS',
  'LGD Gaming':'LGD','LGD':'LGD','Royal Never Give Up':'RNG','RNG':'RNG',
  'Ninjas in Pyjamas':'NIP','NIP':'NIP','Weibo Gaming':'WBG','WBG':'WBG',
  'Made in Brazil':'MIBR','Attacking Soul Esports':'ASE','ASE':'ASE',
  'Nongshim Wolves Gaming':'NWG','NWG':'NWG','Mysterious Esports':'ME','ME':'ME',
  'Top Esports':'TES','TES':'TES',
};
function findBiliVod(opp, date){
  const tag=cnTeamNames[opp]||opp;
  const dt=DT(tag);
  // Try exact date + date¬±1 (VLR/bilibili timezone offset)
  const dates=[date];
  try{const d=new Date(date+'T12:00:00Z');const d1=new Date(d);d1.setDate(d1.getDate()+1);dates.push(d1.toISOString().substring(0,10));const d2=new Date(d);d2.setDate(d2.getDate()-1);dates.push(d2.toISOString().substring(0,10));}catch(e){}
  for(const dd of dates){
    const keys=[`BLG vs ${opp} ${dd}`,`${opp} vs BLG ${dd}`,`BLG vs ${tag} ${dd}`,`${tag} vs BLG ${dd}`];
    if(dt!==tag){keys.push(`BLG vs ${dt} ${dd}`,`${dt} vs BLG ${dd}`);}
    for(const k of keys){if(biliVodMap[k])return biliVodMap[k];}
  }
  return null;
}
function getBiliSearchUrl(opp, date, tournament){
  const tag=cnTeamNames[opp]||opp;
  const d=new Date(date);const m=d.getMonth()+1;const day=d.getDate();const yr=d.getFullYear();
  // Map tournament names to Chinese search terms
  const tnMap={
    'VCT 2026: China Kickoff':`${yr}VCTCNÂêØÁÇπËµõ`,
    'VCT 2025: China Kickoff':`${yr}VCTCNÂêØÁÇπËµõ`,
    'VCT 2024: China Kickoff':'VCTCNÂêØÁÇπËµõ',
    'VCT 2025: China Stage 1':`${yr}VCTCNÁ¨¨‰∏ÄËµõÊÆµ`,
    'VCT 2025: China Stage 2':`${yr}VCTCNÁ¨¨‰∫åËµõÊÆµ`,
    'VCT 2024: China Stage 1':'VCT CN Á¨¨‰∏ÄËµõÊÆµ',
    'VCT 2024: China Stage 2':'VCT CN Á¨¨‰∫åËµõÊÆµ',
    'China Evolution Series: Act 1':'ËøõÂåñËÄÖÁ≥ªÂàóÂÖ¨ÂºÄËµõ',
    'China Evolution Series: Act 2':'ËøõÂåñËÄÖÁ≥ªÂàóÂÖ¨ÂºÄËµõ Á¨¨‰∫åÂπï',
    'China Evolution Series: Act 3':'ËøõÂåñËÄÖÁ≥ªÂàóÂÖ¨ÂºÄËµõ Á¨¨‰∏âÂπï',
    'China Evolution Series 2025: Act 1':'2025ËøõÂåñËÄÖÊùØÁ¨¨‰∏ÄÂπï',
    'China Evolution Series 2025: Act 2':'2025ËøõÂåñËÄÖÊùØÁ≥ªÂàóËµõ',
    'China Evolution Series 2025: Act 3':'2025ËøõÂåñËÄÖÊùØÁ¨¨‰∏âÂπï',
    'FGC Invitational 2024':'2024FGC',
    'VALORANT Champions 2024 (Seoul)':'2024ÂÖ®ÁêÉÂÜ†ÂÜõËµõ',
    'VALORANT Champions 2023 (LA)':'ÂÖ®ÁêÉÂÜ†ÂÜõËµõ',
    'Champions Tour 2023: Champions CQ':'ÂÖ®ÁêÉÂÜ†ÂÜõËµõCQ',
    'VALORANT Champions 2025 (Paris)':'Êó†ÁïèÂ•ëÁ∫¶Â∑¥ÈªéÂÖ®ÁêÉÂÜ†ÂÜõËµõ',
    'VCT Masters Toronto 2025':'2025Â§ö‰º¶Â§öÂ§ßÂ∏àËµõ',
    'Esports World Cup 2025':'2025EWCÊó†ÁïèÂ•ëÁ∫¶',
    'Super Champions Cup 2025':'Ë∂ÖÁ∫ßÂÜ†ÂÜõÊùØ2025',
    'Shanghai Esports Masters 2025':'‰∏äÊµ∑ÁîµÁ´ûÂ§ßÂ∏àËµõ2025',
    'Radiant Asia Invitational 2024':'2024‰∫öÊ¥≤ÈÇÄËØ∑Ëµõ',
    'SOOP Valorant League 2024':'SOOPÊó†ÁïèÂ•ëÁ∫¶ËÅîËµõ2024',
    'HERO Asian Champions League 2025':'Ëã±ÈõÑ‰∫öÂÜ†ACL',
    'Radiant Intl. Invitational 2025':'Êó†ÁïèÂ•ëÁ∫¶Ê∫êËÉΩÂõΩÈôÖÈÇÄËØ∑Ëµõ',
  };
  const cnTn=tnMap[tournament]||tournament||'Êó†ÁïèÂ•ëÁ∫¶';
  const q=`${cnTn} ${m}Êúà${day}Êó• BLG ${tag}`;
  return `https://search.bilibili.com/all?keyword=${encodeURIComponent(q)}&from_source=webtop_search`;
}

async function toggleMapAgents(el,y,ti,mi,mapIdx,mapName){
  // Close any existing popup
  const existing=document.querySelector('.map-agents-popup');
  if(existing){const same=existing._src===el;existing.remove();if(same)return}
  // Create popup
  const pop=document.createElement('div');pop.className='map-agents-popup';pop._src=el;
  pop.innerHTML='<div class="ma-loading"><span class="dot-load"></span> ÏóêÏù¥Ï†ÑÌä∏ Î°úÎî© Ï§ë...</div>';
  el.style.position='relative';el.appendChild(pop);
  // Fetch LP data
  const t=allData[String(y)][ti],m=t.matches[mi];
  const lpPage=LP_TOURN_MAP[t.tournament];
  if(!lpPage){pop.innerHTML='<div class="ma-err">LP ÌéòÏù¥ÏßÄ Îß§Ìïë ÏóÜÏùå</div>';return}
  const key=`${y}_${ti}_${mi}`;
  let liq=liqMatchDetailCache[key];
  if(!liq){
    const blgMatches=await liqFetchTournDetail(lpPage);
    if(blgMatches){liq=liqMatchLookup(blgMatches,m);liqMatchDetailCache[key]=liq}
  }
  if(!liq||!liq.maps){pop.innerHTML='<div class="ma-err">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';setTimeout(()=>pop.remove(),1500);return}
  const lm=liq.maps.find(g=>g.mapName&&(g.mapName===mapName||g.mapName.includes(mapName)))||liq.maps[mapIdx];
  if(!lm){pop.innerHTML='<div class="ma-err">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';setTimeout(()=>pop.remove(),1500);return}
  const side=liq.blgSide||1;
  const ba=side===1?lm.t1agents:lm.t2agents;
  const oa=side===1?lm.t2agents:lm.t1agents;
  let h='';
  if(ba.length){h+=`<div class="ma-row"><span class="ma-side blg">BLG</span>${ba.map(a=>agentImg(a,24)).join('')}</div>`}
  if(oa.length){h+=`<div class="ma-row"><span class="ma-side opp">${DT(m.tag)}</span>${oa.map(a=>agentImg(a,24)).join('')}</div>`}
  pop.innerHTML=h||'<div class="ma-err">ÏóêÏù¥Ï†ÑÌä∏ ÏóÜÏùå</div>';
}

function renderMatches(){const main=document.getElementById('main');const yrs=Object.keys(allData).sort((a,b)=>b-a);let h='';
yrs.forEach(y=>{const a=y===activeYear,s=cys(y);
// Sort tournaments by latest match date (newest first)
const sorted=[...(allData[y]||[])].map((t,oi)=>({...t,_oi:oi}));
sorted.forEach(t=>t.matches.sort((a,b)=>b.date.localeCompare(a.date)));
sorted.sort((a,b)=>{const ad=a.matches[0]?.date||'';const bd=b.matches[0]?.date||'';return bd.localeCompare(ad)});
h+=`<div class="ys ${a?'active':''}" data-year="${y}"><div class="yh"><div class="yn">${y}</div><div class="ysm"><span class="w">${s.w}W</span> / <span class="l">${s.l}L</span> ¬∑ ${s.total}Í≤ΩÍ∏∞</div></div>`;
sorted.forEach((t)=>{const ti=t._oi;
const TOURN_DISPLAY={'CEFSCC 2025':'China Esports Festival Super Champions Cup 2025','EWC 2025':'Esports World Cup 2025'};
const tnDisp=TOURN_DISPLAY[t.tournament]||t.tournament;
h+=`<div class="tg"><div class="th"><div class="tb ${t.intl?'intl':''}"></div><span class="tn">${tnDisp}</span><span class="tbg ${t.intl?'intl':''}">${t.intl?'üåç Íµ≠Ï†ú':'üá®üá≥ Ï§ëÍµ≠'}</span></div>`;
t.matches.forEach((m,mi)=>{const w=m.r==='win',id=`w_${y}_${ti}_${mi}`;
const vodQ=`BLG vs ${m.opp} ${t.tournament} VALORANT ${m.date}`;
const vodQEnc=encodeURIComponent(vodQ);
const vodLabel=('BLG vs '+DT(m.tag)+' ¬∑ '+m.date+' ¬∑ '+m.stage).replace(/'/g,"\\'");
const directBvid=findBiliVod(m.opp, m.date)||findBiliVod(m.tag, m.date)||'';
const soopVod=findSoopVod(m.tag, m.date);
const biliSearchUrl=getBiliSearchUrl(m.opp, m.date, t.tournament);
h+=`<div class="mw" id="${id}"><div class="mc ${m.r}" onclick="toggleDetail('${id}',${y},${ti},${mi})">
<div class="tl">${L('BLG')}<div><div class="tm blg">BLG</div><div class="tt">Bilibili Gaming</div></div></div>
<div class="scc"><div class="sc"><span class="${w?'ws':'ls'}">${m.bs}</span><span class="sp">:</span><span class="${w?'ls':'ws'}">${m.os}</span></div><div class="sm">${m.fmt} ¬∑ ${m.date}</div><span class="rb ${m.r}">${w?'WIN':'LOSS'}</span></div>
<div class="tr"><div><div class="tm">${DT(m.tag)}</div><div class="tt">${m.opp}</div></div>${L(m.tag)}</div>
${m.maps&&m.maps.length?'<div class="mr">'+m.maps.map((p,mi2)=>`<span class="mp ${p.r==='win'?'mw2':'ml2'}" onclick="event.stopPropagation();toggleMapAgents(this,${y},${ti},${mi},${mi2},'${p.n}')">${p.n} ${p.b}-${p.o}</span>`).join('')+'</div>':''}
<div class="sr"><span class="sb">${m.stage}</span>${m._liq?'<span class="sb liq-tag" title="Liquipedia ÏûêÎèô ÎèôÍ∏∞Ìôî">üì°</span>':''}<span class="vod-btn" onclick="event.stopPropagation();openVod('${vodQEnc}','${vodLabel}','${directBvid}')" title="VOD ÏßÅÏ†ë Î≥¥Í∏∞">üì∫ VOD</span>${directBvid?`<a class="vod-btn" href="https://www.bilibili.com/video/${directBvid}" target="_blank" onclick="event.stopPropagation()" style="background:rgba(0,161,214,.1);border-color:rgba(0,161,214,.2);color:#00a1d6" title="BilibiliÏóêÏÑú Î≥¥Í∏∞">üÖ± BÁ´ô</a>`:`<a class="vod-btn" href="${biliSearchUrl}" target="_blank" onclick="event.stopPropagation()" style="background:rgba(0,161,214,.1);border-color:rgba(0,161,214,.2);color:#00a1d6" title="Bilibili Í≤ÄÏÉâ">üÖ± BÁ´ô</a>`}${soopVod?`<span class="vod-btn" onclick="event.stopPropagation();openSoopVod('${m.date}','${m.tag}')" style="background:rgba(148,103,255,.1);border-color:rgba(148,103,255,.2);color:#9467ff" title="SOOP VOD">üü£ SOOP</span>`:''}</div>
<span class="ea">‚ñº</span></div><div class="dp"><div class="di"></div></div></div>`});h+=`</div>`});h+=`</div>`});
main.innerHTML=h}

function renderAll(){renderStats();renderYearTabs();renderUpcoming();renderLiveBanner();renderMatches();renderStatsView();renderRosterView()}

// ===== NOTIFICATION SYSTEM (ÏÜåÎ¶¨ + Î∏åÎùºÏö∞Ï†Ä Ìë∏Ïãú + ÌÜ†Ïä§Ìä∏) =====
let notifEnabled=localStorage.getItem('blg_notif')==='on';
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();

function playNotifSound(type){
  try{
    // type: 'live' (urgent) or 'info' (gentle)
    const now=audioCtx.currentTime;
    if(audioCtx.state==='suspended')audioCtx.resume();
    if(type==='live'){
      // 3-tone ascending alert
      [440,554,659].forEach((freq,i)=>{
        const osc=audioCtx.createOscillator();
        const gain=audioCtx.createGain();
        osc.type='sine';osc.frequency.value=freq;
        gain.gain.setValueAtTime(0,now+i*0.15);
        gain.gain.linearRampToValueAtTime(0.3,now+i*0.15+0.05);
        gain.gain.linearRampToValueAtTime(0,now+i*0.15+0.3);
        osc.connect(gain);gain.connect(audioCtx.destination);
        osc.start(now+i*0.15);osc.stop(now+i*0.15+0.35);
      });
      // Second burst
      setTimeout(()=>{
        const t=audioCtx.currentTime;
        [554,659,880].forEach((freq,i)=>{
          const osc=audioCtx.createOscillator();
          const gain=audioCtx.createGain();
          osc.type='sine';osc.frequency.value=freq;
          gain.gain.setValueAtTime(0,t+i*0.12);
          gain.gain.linearRampToValueAtTime(0.25,t+i*0.12+0.04);
          gain.gain.linearRampToValueAtTime(0,t+i*0.12+0.25);
          osc.connect(gain);gain.connect(audioCtx.destination);
          osc.start(t+i*0.12);osc.stop(t+i*0.12+0.3);
        });
      },600);
    }else{
      // Single gentle chime
      const osc=audioCtx.createOscillator();
      const gain=audioCtx.createGain();
      osc.type='sine';osc.frequency.value=523;
      gain.gain.setValueAtTime(0,now);
      gain.gain.linearRampToValueAtTime(0.2,now+0.05);
      gain.gain.linearRampToValueAtTime(0,now+0.5);
      osc.connect(gain);gain.connect(audioCtx.destination);
      osc.start(now);osc.stop(now+0.6);
    }
  }catch(e){}
}

function sendBrowserNotif(title,body,icon){
  if(Notification.permission==='granted'){
    try{new Notification(title,{body,icon:icon||'',tag:'blg-'+Date.now(),requireInteraction:false})}catch(e){}
  }
}

let toastTimer=null;
function showToast(icon,title,desc,duration){
  // Remove existing
  document.querySelectorAll('.notif-toast').forEach(el=>el.remove());
  const d=document.createElement('div');
  d.className='notif-toast';
  d.innerHTML=`<span class="nt-icon">${icon}</span><div class="nt-body"><div class="nt-title">${title}</div><div class="nt-desc">${desc}</div></div><button class="nt-close" onclick="this.parentElement.classList.add('out');setTimeout(()=>this.parentElement.remove(),300)">‚úï</button>`;
  document.body.appendChild(d);
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{d.classList.add('out');setTimeout(()=>d.remove(),300)},duration||6000);
}

function notifyLiveStart(opp,event){
  if(!notifEnabled)return;
  playNotifSound('live');
  showToast('üî¥',`BLG Í≤ΩÍ∏∞ ÏãúÏûë!`,`${event} ¬∑ vs ${opp}`,10000);
  sendBrowserNotif('üî¥ BLG ÎùºÏù¥Î∏å!',`${event} ¬∑ vs ${opp}`);
}

function notifyLiveEnd(opp){
  if(!notifEnabled)return;
  playNotifSound('info');
  showToast('üèÅ','Í≤ΩÍ∏∞ Ï¢ÖÎ£å',`vs ${opp} ¬∑ VOD/ÏóêÏù¥Ï†ÑÌä∏/Í≤∞Í≥º ÏûêÎèô ÏàòÏßë Ï§ë...`,6000);
  sendBrowserNotif('üèÅ BLG Í≤ΩÍ∏∞ Ï¢ÖÎ£å',`vs ${opp} ¬∑ BÁ´ô VOD Í≥ß ÏóÖÎç∞Ïù¥Ìä∏`);
}

function notifyNewSchedule(event,date,opp){
  if(!notifEnabled)return;
  playNotifSound('info');
  showToast('üìÖ','ÏÉà ÏùºÏ†ï Î∞úÍ≤¨!',`${event} ¬∑ ${date} ¬∑ vs ${opp||'TBD'}`,8000);
  sendBrowserNotif('üìÖ BLG ÏÉà ÏùºÏ†ï',`${event} ¬∑ ${date}`);
}

function notifyNewVod(count){
  if(!notifEnabled)return;
  playNotifSound('info');
  showToast('üÖ±',`BÁ´ô VOD ${count}Í∞ú Ï∂îÍ∞Ä`,`Í≤ΩÍ∏∞ Ïπ¥ÎìúÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî`,6000);
}

function toggleNotif(){
  if(!notifEnabled){
    // Enable: request permission
    notifEnabled=true;
    localStorage.setItem('blg_notif','on');
    if('Notification' in window && Notification.permission==='default'){
      Notification.requestPermission();
    }
    // Play test sound
    playNotifSound('info');
    showToast('üîî','ÏïåÎ¶º ÏºúÏßê','ÎùºÏù¥Î∏å ÏãúÏûë ¬∑ ÏÉà ÏùºÏ†ï ¬∑ VOD ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º',4000);
  }else{
    notifEnabled=false;
    localStorage.setItem('blg_notif','off');
    showToast('üîï','ÏïåÎ¶º Í∫ºÏßê','',3000);
  }
  updateNotifBtn();
}

function updateNotifBtn(){
  const btn=document.getElementById('notifBtn');
  const ico=document.getElementById('notifIcon');
  if(notifEnabled){btn.classList.add('on');ico.textContent='üîî'}
  else{btn.classList.remove('on');ico.textContent='üîï'}
}
updateNotifBtn();

// ===== 1) LIVE MATCH DETECTION (Riot Esports API) =====
let currentLive=null;
let liveCheckCount=0;
const BILI_MID='2071691173';
const YT_LIVE_CN='https://www.youtube.com/@VALORANTEsportsCN/live';
const BILI_LIVE='https://live.bilibili.com/22637261';

async function checkLiveMatch(){
  liveCheckCount++;
  let found=null;
  // 0) Try Riot Esports API (official, direct, no CORS!)
  try{
    const events=await getRiotSchedule();
    const live=events.find(ev=>ev.state==='inProgress'&&ev.match?.teams?.some(t=>isBLGTeam(t)));
    if(live){
      const teams=live.match.teams;
      const isBLG0=isBLGTeam(teams[0]);
      found={team1:isBLG0?teams[0].name:teams[1].name, team2:isBLG0?teams[1].name:teams[0].name,
        score1:String(isBLG0?teams[0].result?.gameWins||0:teams[1].result?.gameWins||0),
        score2:String(isBLG0?teams[1].result?.gameWins||0:teams[0].result?.gameWins||0),
        round_info:live.blockName||'', tournament_name:live.league?.name||'VCT CN',
        match_page:'', _streams:{}};
    }
  }catch(e){}
  // 1) Try vlresports (no API key needed)
  try{
    const d=await proxyFetchJSON('https://vlr.orlandomm.net/api/v1/matches');
    if(d&&Array.isArray(d.data)){
      d.data.forEach(m=>{
        if(!m.teams||m.teams.length<2)return;
        const t1=(m.teams[0].name||'').toLowerCase(),t2=(m.teams[1].name||'').toLowerCase();
        if(t1.includes('bilibili')||t1.includes('blg')||t2.includes('bilibili')||t2.includes('blg')){
          const st=(m.status||'').toLowerCase();
          if(st!=='live'&&st!=='ongoing')return;
          const isBLG1=t1.includes('bilibili')||t1.includes('blg');
          found={team1:isBLG1?'Bilibili Gaming':(m.teams[0].name||'TBD'),team2:isBLG1?(m.teams[1].name||'TBD'):'Bilibili Gaming',
            score1:String(isBLG1?m.teams[0].score:m.teams[1].score)||'0',score2:String(isBLG1?m.teams[1].score:m.teams[0].score)||'0',
            round_info:'',tournament_name:m.event?.name||'VCT',match_page:m.id?`/${m.id}/`:'',_streams:{}};
        }
      });
    }
  }catch(e){}
  const prev=currentLive;currentLive=found||null;renderLiveBanner();
  if(!prev&&currentLive)notifyLiveStart(currentLive.team2||'TBD',currentLive.tournament_name||'VCT');
  if(prev&&!currentLive){notifyLiveEnd(prev.team2||'');
    // Í≤ΩÍ∏∞ Ï¢ÖÎ£å ‚Üí ÏûêÎèô ÌååÏù¥ÌîÑÎùºÏù∏: VOD + LP + VLR ÏóêÏù¥Ï†ÑÌä∏
    setTimeout(()=>checkNewBiliVods(),60000);setTimeout(()=>checkNewBiliVods(),300000);
    setTimeout(()=>liqAutoSync(),120000); // 2Î∂Ñ ÌõÑ LP Í≤∞Í≥º ÏàòÏßë
    setTimeout(()=>autoVlrSync(),180000); // 3Î∂Ñ ÌõÑ ÏóêÏù¥Ï†ÑÌä∏ ÏàòÏßë
    setTimeout(()=>{checkNewBiliVods();autoVlrSync()},600000); // 10Î∂Ñ ÌõÑ Ïû¨ÏãúÎèÑ
  }
}

function renderLiveBanner(){
  const el=document.getElementById('liveBanner');
  if(!currentLive){el.style.display='none';el.innerHTML='';return}
  const m=currentLive;
  const isBLG1=(m.team1||'').includes('Bilibili')||(m.team1||'').includes('BLG');
  const blgScore=isBLG1?m.score1:m.score2;
  const oppScore=isBLG1?m.score2:m.score1;
  const oppName=isBLG1?m.team2:m.team1;
  const oppTag=guessTag(oppName);
  const event=m.tournament_name||m.match_event||'VCT';
  const stage=m.round_info||m.match_series||'';
  const streams=m._streams||{};
  const ytUrl=streams.youtube||YT_LIVE_CN;
  const biliUrl=streams.bilibili||BILI_LIVE;
  const matchUrl=m.match_page?'https://www.vlr.gg'+m.match_page:'https://www.vlr.gg/team/12010/bilibili-gaming';

  // Extract YouTube channel/video for embed
  let ytEmbedUrl='';
  if(ytUrl.includes('/live')){
    // Channel live URL ‚Üí embed with channel
    const chMatch=ytUrl.match(/@([^/]+)/);
    ytEmbedUrl=ytUrl.replace('/live','').replace('www.youtube.com','www.youtube.com/embed/live_stream?channel=');
    // Fallback: use direct embed URL for VCT CN live
    ytEmbedUrl='https://www.youtube.com/embed/live_stream?channel=UCQ4huNOwMm-5kOBSHBBHahg&autoplay=1';
  } else if(ytUrl.includes('watch?v=')){
    const vid=ytUrl.match(/[?&]v=([^&]+)/);
    if(vid) ytEmbedUrl=`https://www.youtube.com/embed/${vid[1]}?autoplay=1`;
  } else if(ytUrl.includes('youtu.be/')){
    const vid=ytUrl.match(/youtu\.be\/([^?]+)/);
    if(vid) ytEmbedUrl=`https://www.youtube.com/embed/${vid[1]}?autoplay=1`;
  }
  if(!ytEmbedUrl) ytEmbedUrl='https://www.youtube.com/embed/live_stream?channel=UCQ4huNOwMm-5kOBSHBHahg&autoplay=1';

  el.style.display='block';
  el.innerHTML=`<div class="live-match-banner">
    <div class="live-top"><div class="live-dot-big"></div><span class="live-label">LIVE NOW</span><span class="live-event">${event} ¬∑ ${stage}</span></div>
    <div class="live-teams">
      <div class="live-team">${L('BLG','big')}<div><div class="live-team-name">BLG</div><div class="live-team-full">Bilibili Gaming</div></div></div>
      <div><div class="live-score-live">${blgScore} : ${oppScore}</div><div class="live-vs">${stage||'LIVE'}</div></div>
      <div class="live-team right"><div><div class="live-team-name">${oppTag}</div><div class="live-team-full">${oppName}</div></div>${L(oppTag,'big')}</div>
    </div>
    <div class="live-stream-wrap" id="liveStreamWrap" style="display:none">
      <iframe id="liveStreamFrame" src="" allow="autoplay; encrypted-media; fullscreen" style="width:100%;aspect-ratio:16/9;border:0;border-radius:10px;background:#000"></iframe>
    </div>
    <div class="live-links">
      <button onclick="toggleLiveStream('${ytEmbedUrl}')" class="live-link yt" style="border:none;cursor:pointer;font-family:inherit">üì∫ ÎùºÏù¥Î∏å ÏãúÏ≤≠</button>
      <a href="${biliUrl}" target="_blank" class="live-link bili">‚ñ∂ BÁ´ô ÎùºÏù¥Î∏å</a>
      <a href="${matchUrl}" target="_blank" class="live-link vlr">üìä VLR.gg</a>
    </div>
  </div>`;
}

function toggleLiveStream(embedUrl){
  const wrap=document.getElementById('liveStreamWrap');
  const frame=document.getElementById('liveStreamFrame');
  if(wrap.style.display==='none'){
    wrap.style.display='block';
    frame.src=embedUrl;
  } else {
    wrap.style.display='none';
    frame.src='';
  }
}

function guessTag(name){
  if(!name)return'?';
  const map={'EDward Gaming':'EDG','FunPlus Phoenix':'FPX','Trace Esports':'TE','Dragon Ranger Gaming':'DRG',
    'Xi Lai Gaming':'XLG','XLG Esports':'XLG','Wolves Esports':'WOL','All Gamers':'AG','JDG Esports':'JDG','JD Gaming':'JDG','Titan Esports Club':'TEC',
    'TYLOO':'TYL','Nova Esports':'NV','NOVA Esports':'NV','Paper Rex':'PRX','DRX':'DRX','Gen.G':'GEN','T1':'T1',
    'Team Liquid':'TL','Fnatic':'FNC','FNATIC':'FNC','Sentinels':'SEN','NRG Esports':'NRG','NRG':'NRG','G2 Esports':'G2',
    'Karmine Corp':'KC','LOUD':'LOUD','LEVIAT√ÅN':'LEV','Leviat√°n':'LEV','Leviatan':'LEV','Leviat\u00e1n':'LEV','LEVIATAN':'LEV',
    'Natus Vincere':'NAVI','Team Vitality':'VIT',
    'Cloud9':'C9','100 Thieves':'100T','Evil Geniuses':'EG','FURIA':'FURIA','MIBR':'MIBR',
    'Rex Regum Qeon':'RRQ','DetonatioN FocuseMe':'DFM','KR√ú Esports':'KR√ú',
    'LGD Gaming':'LGD','Royal Never Give Up':'RNG','Weibo Gaming':'WBG','Attacking Soul Esports':'ASE',
    'Nongshim Wolves Gaming':'NWG','Nighthunters Gaming':'NWG','Ninjas in Pyjamas':'NIP','Mysterious Esports':'ME','Monarch Esports':'ME','Top Esports':'TES','Bilibili Gaming':'BLG'};
  // Also check Riot team codes
  const codeMap={'XE':'XLG','WOL':'WOL','DRG':'DRG','FPX':'FPX','EDG':'EDG','TE':'TE','AG':'AG','JDG':'JDG','TEC':'TEC','TYL':'TYL','NV':'NV','LEV':'LEV','L':'LEV'};
  if(codeMap[name])return codeMap[name];
  // Partial match for accented/variant names
  const nameLc=name.toLowerCase();
  if(nameLc.includes('leviat'))return'LEV';
  if(nameLc.includes('wolves'))return'WOL';
  if(nameLc.includes('dragon ranger'))return'DRG';
  if(nameLc.includes('bilibili'))return'BLG';
  if(nameLc.includes('edward'))return'EDG';
  if(nameLc.includes('funplus'))return'FPX';
  if(nameLc.includes('paper rex'))return'PRX';
  if(nameLc.includes('karmine'))return'KC';
  if(nameLc.includes('natus vincere'))return'NAVI';
  return map[name]||name.split(' ').map(w=>w[0]).join('').toUpperCase().substring(0,3);
}

// ===== 2) AUTO BILIBILI VOD FETCH (Bilibili API) =====
let lastBiliCheck=0;
const newVodBvids=new Set();

async function checkNewBiliVods(){
  const now=Date.now();if(now-lastBiliCheck<60000)return;lastBiliCheck=now;
  let videos=[];
  // 1) Try Bilibili API via proxy
  try{
    const d=await proxyFetchJSON('https://api.bilibili.com/x/space/arc/search?mid=2071691173&ps=10&tid=0&pn=1&keyword=BLG&order=pubdate');
    if(d&&d.data&&d.data.list&&d.data.list.vlist){
      videos=d.data.list.vlist.map(v=>({bvid:v.bvid,title:v.title,date:new Date(v.created*1000).toISOString().substring(0,10)})).filter(v=>{
        const t=v.title||'';
        // Must contain BLG or ÂìîÂì©ÂìîÂì©
        if(!t.includes('BLG')&&!t.includes('ÂìîÂì©ÂìîÂì©'))return false;
        // Exclude LoL content
        if(t.includes('Ëã±ÈõÑËÅîÁõü')||t.includes('LOL')||t.includes('lol')||t.includes('LPL')||t.includes('ËÅîËµõ'))return false;
        return true;
      });
    }
  }catch(e){}
  if(!videos.length)return;
  let added=0;
  videos.forEach(v=>{
    const bv=v.bvid;if(!bv||bv.length<10)return;
    const title=v.title||'';if(!title.includes('BLG')&&!title.includes('ÂìîÂì©ÂìîÂì©'))return;
    if(Object.values(biliVodMap).includes(bv))return;
    const dateM=title.match(/(\d{1,2})Êúà(\d{1,2})Êó•/);
    if(dateM){
      const pubYear=v.date?v.date.substring(0,4):new Date().getFullYear();
      const mm=dateM[1].padStart(2,'0'),dd=dateM[2].padStart(2,'0'),dateStr=`${pubYear}-${mm}-${dd}`;
      const vsMatch=title.match(/VS\s*(\S+)/i);const oppRaw=vsMatch?vsMatch[1].replace(/[„Äê„Äë\s]/g,''):'';
      let oppTag='';for(const[tag,cn]of Object.entries(cnTeamNames)){if(oppRaw.includes(cn)||cn.includes(oppRaw)){oppTag=tag;break}}
      if(!oppTag)oppTag=oppRaw.substring(0,3).toUpperCase();
      if(oppTag&&dateStr){const k1=`BLG vs ${oppTag} ${dateStr}`,k2=`${oppTag} vs BLG ${dateStr}`;biliVodMap[k1]=bv;biliVodMap[k2]=bv;biliVodMap[bv]={tag:oppTag,date:dateStr};newVodBvids.add(bv);added++}
    }
  });
  if(added>0){saveVodCache();renderMatches();showVodNotification(added);notifyNewVod(added)}
}

function showVodNotification(count){
  const banner=document.getElementById('liveBanner');
  if(currentLive)return; // Don't overlay on live banner
  banner.style.display='block';
  banner.innerHTML=`<div style="background:rgba(0,161,214,.1);border:1px solid rgba(0,161,214,.25);border-radius:14px;padding:12px 20px;display:flex;align-items:center;gap:10px;max-width:700px;margin:0 auto">
    <span style="font-size:20px">üÖ±</span>
    <div><div style="font-size:13px;font-weight:700;color:#00a1d6">ÏÉàÎ°úÏö¥ BÁ´ô VOD ${count}Í∞ú Î∞úÍ≤¨!</div>
    <div style="font-size:11px;color:var(--dim)">Í≤ΩÍ∏∞ Ïπ¥ÎìúÏùò üÖ± BÁ´ô Î≤ÑÌäºÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§</div></div>
    <button onclick="this.parentElement.parentElement.style.display='none'" style="margin-left:auto;background:none;border:none;color:var(--dim);cursor:pointer;font-size:16px">‚úï</button>
  </div>`;
  setTimeout(()=>{if(!currentLive){banner.style.display='none';banner.innerHTML=''}},10000);
}

// ===== 3) AUTO TEAM LOGO =====
const logoCache={};

function fetchTeamLogo(tag){
  // Riot Esports API handles logo fetching (fetchRiotTeamLogos)
  // This is fallback for completely unknown teams
  if(logoCache[tag])return;
  logoCache[tag]=_tsvg(tag,_LOGO_COLORS[tag]||'#333');
  LOGOS[tag]=logoCache[tag];
}

// ===== LIQUIPEDIA MATCH DETAIL (ÏóêÏù¥Ï†ÑÌä∏¬∑Î∞¥ÌîΩ) =====
const LP_TOURN_MAP={
'FGC 2023: Act 1 Qualifier':'FGC/2023/Act_1/China',
'FGC 2023: Act 2 Qualifier':'FGC/2023/Act_2/China',
'FGC Invitational 2023: Act 1':'FGC/2023/Act_1/Invitational',
'FGC Invitational 2023: Act 2':'FGC/2023/Act_2/Invitational',
'VCT 2023: CN Champions Qualifier':'VCT/2023/Champions/Last_Chance_Qualifier/China',
'VALORANT Champions 2023 (LA)':'VCT/2023/Champions',
'VCT 2024: China Kickoff':'VCT/2024/China_League/Kickoff',
'FGC Invitational 2024':'FGC/2024/Invitational',
'VCT 2024: China Stage 1':'VCT/2024/China_League/Stage_1',
'SOOP Valorant League 2024':'SOOP_Valorant_League/Season_1',
'VCT 2024: China Stage 2':'VCT/2024/China_League/Stage_2',
'Radiant Asia Invitational 2024':'Radiant_Asia_Invitational/2024',
'VALORANT Champions 2024 (Seoul)':'VCT/2024/Champions',
'China Evolution Series: Act 1':'VALORANT_China_Evolution_Series/Act_1',
'China Evolution Series: Act 2':'VALORANT_China_Evolution_Series/Act_2',
'China Evolution Series: Act 3':'VALORANT_China_Evolution_Series/Act_3',
'VCT 2025: China Kickoff':'VCT/2025/China_League/Kickoff',
'VCT 2025: China Stage 1':'VCT/2025/China_League/Stage_1',
'VCT Masters Toronto 2025':'VCT/2025/Masters/Toronto',
'CN EVO 25: Act 2 X ACL':'VALORANT_China_Evolution_Series/2025/Act_2',
'VCT 2025: China Stage 2':'VCT/2025/China_League/Stage_2',
'CN EVO 25: Act 3':'VALORANT_China_Evolution_Series/2025/Act_3',
'VALORANT Champions 2025 (Paris)':'VCT/2025/Champions',
'Esports World Cup 2025':'Esports_World_Cup/2025',
'Shanghai Esports Masters 2025':'Shanghai_Esports_Masters/2025',
'CEFSCC 2025':'China_Esports_Festival_Super_Champions_Cup/2025',
'Radiant Intl. Invitational 2025':'VALORANT_Radiant_International_Invitational/2025',
'HERO Asian Champions League 2025':'HERO_Asian_Champions_League/2025',
'VCT 2026: China Kickoff':'VCT/2026/China_League/Kickoff',
};

const liqDetailCache={};// pagePath ‚Üí [{team1,team2,score,maps:[{mapName,score1,score2,t1agents,t2agents}],veto}]

const AGENT_ICONS_URL='https://valorant-api.com/v1/agents?isPlayableCharacter=true';
let agentIconMap=null;

async function loadAgentIcons(){
  if(agentIconMap)return;
  try{
    const r=await fetch(AGENT_ICONS_URL);const d=await r.json();
    agentIconMap={};
    (d.data||[]).forEach(a=>{
      const name=a.displayName.replace('/','');// KAY/O ‚Üí KAYO
      agentIconMap[name.toLowerCase()]=a.displayIcon;
      agentIconMap[a.displayName.toLowerCase()]=a.displayIcon;
    });
    console.log(`‚úÖ agentIconMap: ${Object.keys(agentIconMap).length}Í∞ú ÏóêÏù¥Ï†ÑÌä∏ Î°úÎìú`);
  }catch(e){agentIconMap={}}
}
loadAgentIcons();

function agentImg(name,sz=20){
  if(!agentIconMap||!name)return'';
  const url=agentIconMap[name.toLowerCase()]||agentIconMap[name.replace('/','').toLowerCase()];
  if(!url)return`<span class="ag-name">${name}</span>`;
  return`<img src="${url}" alt="${name}" title="${name}" style="width:${sz}px;height:${sz}px;border-radius:50%;vertical-align:middle">`;
}

async function liqFetchTournDetail(pagePath){
  if(liqDetailCache[pagePath])return liqDetailCache[pagePath];
  const d=await liqFetch({action:'parse',page:pagePath,prop:'text'});
  if(!d?.parse?.text?.['*'])return null;
  const doc=new DOMParser().parseFromString(d.parse.text['*'],'text/html');
  const all=liqParsePopups(doc);
  const blg=all.filter(m=>{
    const t=(m.team1+' '+m.team2+' '+(m._hl||[]).join(' ')).toLowerCase();
    return t.includes('bilibili')||t.includes('blg');
  });
  liqDetailCache[pagePath]=blg;
  return blg;
}

function liqParsePopups(doc){
  const matches=[];
  const MAPS=['Ascent','Bind','Breeze','Fracture','Haven','Icebox','Lotus','Pearl','Split','Sunset','Abyss','Corrode'];
  const AGENTS=['Jett','Raze','Phoenix','Reyna','Yoru','Neon','Iso','Waylay','Sova','Breach','Skye','KAY/O','Fade','Gekko','Tejo','Killjoy','Cypher','Sage','Chamber','Deadlock','Vyse','Brimstone','Omen','Viper','Astra','Harbor','Clove'];
  doc.querySelectorAll('.brkts-popup').forEach(popup=>{
    const m={team1:'',team2:'',score:'',maps:[],veto:[],_hl:[]};
    // Teams
    const opps=popup.querySelectorAll('.match-info-header-opponent');
    if(opps.length>=2){m.team1=opps[0].textContent.replace(/\s+/g,' ').trim();m.team2=opps[1].textContent.replace(/\s+/g,' ').trim()}
    popup.querySelectorAll('[data-highlightingclass]').forEach(el=>{const v=el.getAttribute('data-highlightingclass');if(v)m._hl.push(v.toLowerCase())});
    // Score
    const hdr=popup.querySelector('.match-info-header');
    if(hdr){const sm=hdr.textContent.replace(/\s+/g,' ').match(/(\d+)\s*[:\-‚Äì]\s*(\d+)/);if(sm)m.score=sm[1]+':'+sm[2]}
    // Date
    const de=popup.querySelector('.timer-object,[data-timestamp]');
    if(de)m.date=de.textContent?.trim()||'';
    // Maps
    popup.querySelectorAll('.brkts-popup-body-game').forEach(row=>{
      const g={mapName:'',score1:0,score2:0,t1agents:[],t2agents:[]};
      row.querySelectorAll('a').forEach(a=>{const t=(a.getAttribute('title')||a.textContent||'').trim();if(MAPS.some(mn=>t.includes(mn)))g.mapName=t});
      if(!g.mapName){const txt=row.textContent;MAPS.forEach(mn=>{if(txt.includes(mn))g.mapName=mn})}
      const nums=[];row.querySelectorAll('td,.brkts-popup-spaced').forEach(el=>{const n=parseInt(el.textContent?.trim());if(!isNaN(n)&&n>=0&&n<=30)nums.push(n)});
      const big=nums.filter(n=>n>=3);if(big.length>=2){g.score1=big[0];g.score2=big[1]}else if(nums.length>=2){g.score1=nums[0];g.score2=nums[1]}
      const agents=[];
      row.querySelectorAll('img').forEach(img=>{
        const c=((img.getAttribute('src')||'')+' '+(img.getAttribute('alt')||'')+' '+(img.getAttribute('title')||'')).toLowerCase();
        for(const a of AGENTS){if(c.includes(a.toLowerCase())){agents.push(a);break}}
      });
      g.t1agents=agents.slice(0,5);g.t2agents=agents.slice(5,10);
      if(g.mapName||agents.length>0||g.score1>0)m.maps.push(g);
    });
    // Veto
    const vt=popup.querySelector('.brkts-popup-mapveto table,table.wikitable-striped');
    if(vt)vt.querySelectorAll('tr').forEach(r=>{const c=r.querySelectorAll('td,th');if(c.length>=3){const a=c[1]?.textContent?.trim();if(/ban|pick|decider/i.test(a))m.veto.push({t1:c[0]?.textContent?.trim(),action:a,t2:c[2]?.textContent?.trim()})}});
    if(m.team1||m.team2||m.maps.length>0)matches.push(m);
  });
  return matches;
}

function liqMatchLookup(liqMatches,match){
  if(!liqMatches||!liqMatches.length)return null;
  // Match by opponent name + series score
  const oppLc=match.opp.toLowerCase();const tagLc=(match.tag||'').toLowerCase();
  const mScore=`${match.bs}:${match.os}`;const mScoreR=`${match.os}:${match.bs}`;
  for(const lm of liqMatches){
    const t1=lm.team1.toLowerCase(),t2=lm.team2.toLowerCase();
    const isBLG1=t1.includes('bilibili')||t1.includes('blg');
    const isBLG2=t2.includes('bilibili')||t2.includes('blg');
    const oppSide=isBLG1?t2:t1;
    if(!oppSide.includes(oppLc)&&!oppSide.includes(tagLc)&&!oppLc.includes(oppSide.split(' ')[0]))continue;
    // Check score
    const lScore=lm.score;
    if(isBLG1&&lScore===mScore)return{...lm,blgSide:1};
    if(isBLG2&&lScore===mScoreR)return{...lm,blgSide:2};
    // Loose: just opponent match
    if(isBLG1||isBLG2)return{...lm,blgSide:isBLG1?1:2};
  }
  return null;
}

// Global cache for per-match LP detail lookups
const liqMatchDetailCache={};// "y_ti_mi" ‚Üí liqMatch or null

// ===== VLR_AGENT_DATA ÏóêÏù¥Ï†ÑÌä∏ Îç∞Ïù¥ÌÑ∞ ÏûêÎèô Ï†ÅÏö© =====
function preloadAgents(){
  if(typeof VLR_AGENT_DATA==='undefined')return;
  let cnt=0;
  for(const[yr,tgs]of Object.entries(allData)){
    tgs.forEach((tg,ti)=>{
      tg.matches.forEach((m,mi)=>{
        const cacheKey=`${yr}_${ti}_${mi}`;
        const key=m.date+'_'+m.tag;
        const src=VLR_AGENT_DATA[key];
        if(!src||!src.d||!src.d.length)return;
        // VLR agent data ALWAYS takes priority (has accurate per-map agents)
        liqMatchDetailCache[cacheKey]={
          blgSide:1,
          maps:src.d.map(md=>({
            mapName:md.m,
            t1agents:md.b||[],
            t2agents:md.o||[],
            score1:md.bs||0,
            score2:md.os||0
          }))
        };
        cnt++;
      });
    });
  }
  console.log(`‚úÖ ÏóêÏù¥Ï†ÑÌä∏ ÌîÑÎ¶¨Î°úÎìú: ${cnt}Í≤ΩÍ∏∞`);
}

// ===== VLR.gg ÏûêÎèô ÏóêÏù¥Ï†ÑÌä∏ ÎèôÍ∏∞Ìôî =====
async function vlrSync(){
  const btn=document.getElementById('vlrSyncBtn');
  if(!btn)return;
  btn.disabled=true;btn.innerHTML='üì° ÎèôÍ∏∞Ìôî Ï§ë...';
  try{
    const resp=await fetch('/api/vlr-sync?limit=15');
    if(!resp.ok)throw new Error(`HTTP ${resp.status}`);
    const json=await resp.json();
    if(!json.ok||!json.data)throw new Error(json.error||'ÏùëÎãµ Ïò§Î•ò');
    
    // Merge with existing cache
    let newCnt=0;
    const vlrNew=json.data;
    // Save to localStorage for persistence
    const stored=JSON.parse(localStorage.getItem('vlr_sync_data')||'{}');
    Object.assign(stored,vlrNew);
    localStorage.setItem('vlr_sync_data',JSON.stringify(stored));
    localStorage.setItem('vlr_sync_ts',json.ts);
    
    // Apply to match detail cache
    for(const[yr,tgs]of Object.entries(allData)){
      tgs.forEach((tg,ti)=>{
        tg.matches.forEach((m,mi)=>{
          const cacheKey=`${yr}_${ti}_${mi}`;
          const key=m.date+'_'+m.tag;
          const src=stored[key]||vlrNew[key];
          if(!src||!src.d||!src.d.length)return;
          const hasAgents=src.d.some(md=>(md.b&&md.b.length>0)||(md.o&&md.o.length>0));
          const existing=liqMatchDetailCache[cacheKey];
          const existingHasAgents=existing?.maps?.some(mp=>(mp.t1agents&&mp.t1agents.length>0)||(mp.t2agents&&mp.t2agents.length>0));
          // Don't overwrite if existing has agents but new data doesn't
          if(existingHasAgents&&!hasAgents)return;
          liqMatchDetailCache[cacheKey]={
            blgSide:1,
            maps:src.d.map(md=>({
              mapName:md.m,
              t1agents:md.b||[],
              t2agents:md.o||[],
              score1:md.bs||0,
              score2:md.os||0
            }))
          };
          newCnt++;
        });
      });
    }
    
    btn.innerHTML=`‚úÖ ${newCnt}Í≤ΩÍ∏∞ ÎèôÍ∏∞Ìôî`;
    if(newCnt>0)renderAll();
    console.log(`üì° VLR ÎèôÍ∏∞Ìôî: ${json.count}Í∞ú ÏàòÏã†, ${newCnt}Í≤ΩÍ∏∞ ÏÉàÎ°ú Ï†ÅÏö©`);
    setTimeout(()=>{btn.innerHTML='üì° ÏóêÏù¥Ï†ÑÌä∏ ÎèôÍ∏∞Ìôî';btn.disabled=false},3000);
  }catch(e){
    console.error('VLR ÎèôÍ∏∞Ìôî Ïã§Ìå®:',e);
    btn.innerHTML='‚ùå ÎèôÍ∏∞Ìôî Ïã§Ìå®';
    setTimeout(()=>{btn.innerHTML='üì° ÏóêÏù¥Ï†ÑÌä∏ ÎèôÍ∏∞Ìôî';btn.disabled=false},3000);
  }
}

// localStorageÏóê Ï†ÄÏû•Îêú VLR ÎèôÍ∏∞Ìôî Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
function restoreVlrSync(){
  const stored=JSON.parse(localStorage.getItem('vlr_sync_data')||'{}');
  if(!Object.keys(stored).length)return;
  let cnt=0;
  for(const[yr,tgs]of Object.entries(allData)){
    tgs.forEach((tg,ti)=>{
      tg.matches.forEach((m,mi)=>{
        const cacheKey=`${yr}_${ti}_${mi}`;
        const key=m.date+'_'+m.tag;
        const src=stored[key];
        if(!src||!src.d||!src.d.length)return;
        const hasAgents=src.d.some(md=>(md.b&&md.b.length>0)||(md.o&&md.o.length>0));
        const existing=liqMatchDetailCache[cacheKey];
        const existingHasAgents=existing?.maps?.some(mp=>(mp.t1agents&&mp.t1agents.length>0)||(mp.t2agents&&mp.t2agents.length>0));
        // Don't overwrite if existing has agents but new data doesn't
        if(existingHasAgents&&!hasAgents)return;
        liqMatchDetailCache[cacheKey]={
          blgSide:1,
          maps:src.d.map(md=>({
            mapName:md.m,
            t1agents:md.b||[],
            t2agents:md.o||[],
            score1:md.bs||0,
            score2:md.os||0
          }))
        };
        cnt++;
      });
    });
  }
  if(cnt)console.log(`üì° VLR Ï∫êÏãú Î≥µÏõê: ${cnt}Í≤ΩÍ∏∞`);
}

async function loadLiqDetail(y,ti,mi){
  const key=`${y}_${ti}_${mi}`;
  const btnEl=document.getElementById(`liq-btn-${key}`);
  if(btnEl)btnEl.innerHTML='<span class="dot-load" style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 1s infinite;margin-right:4px"></span>Î°úÎî© Ï§ë...';
  const t=allData[String(y)][ti],m=t.matches[mi];
  const lpPage=LP_TOURN_MAP[t.tournament];
  if(!lpPage){if(btnEl)btnEl.textContent='‚ùì LP ÌéòÏù¥ÏßÄ Îß§Ìïë ÏóÜÏùå';return}
  const blgMatches=await liqFetchTournDetail(lpPage);
  if(!blgMatches){if(btnEl)btnEl.textContent='‚ùå Î°úÎìú Ïã§Ìå®';return}
  const found=liqMatchLookup(blgMatches,m);
  // Only overwrite if existing cache has no agent data or no maps
  const existing=liqMatchDetailCache[key];
  if(!existing||!existing.maps||!existing.maps.some(g=>(g.t1agents||[]).length>0)){
    liqMatchDetailCache[key]=found;
  } else if(found){
    // Merge: keep VLR agents, update other liq metadata
    liqMatchDetailCache[key].veto=found.veto||liqMatchDetailCache[key].veto;
  }
  // Re-render detail
  const wid=`w_${y}_${ti}_${mi}`;
  const panel=document.getElementById(wid)?.querySelector('.di');
  if(panel)panel.innerHTML=detHTML(m,t.tournament,t.intl);
}

// ===== LIQUIPEDIA AUTO SYNC (Results ‚Üí ÎåÄÌöå ‚Üí BLG Í≤ΩÍ∏∞ ÏûêÎèô Ï∂îÍ∞Ä) =====
let liqSyncStatus='idle';// idle|syncing|done|error
let liqSyncCount=0;

function updateSyncBadge(){
  const el=document.getElementById('syncBadge');if(!el)return;
  if(liqSyncStatus==='syncing')el.innerHTML=`<span class="sync-dot syncing"></span> LP ÎèôÍ∏∞Ìôî Ï§ë...`;
  else if(liqSyncStatus==='done')el.innerHTML=`<span class="sync-dot done"></span> ${liqSyncCount>0?liqSyncCount+'Í≤ΩÍ∏∞ Ï∂îÍ∞ÄÎê®':'ÏµúÏã† ÏÉÅÌÉú'}<button class="sync-export-btn" onclick="event.stopPropagation();showExportModal()" title="baselineData ÎÇ¥Î≥¥ÎÇ¥Í∏∞">üìã</button>`;
  else if(liqSyncStatus==='error')el.innerHTML=`<span class="sync-dot err"></span> ÎèôÍ∏∞Ìôî Ïã§Ìå®`;
  else el.innerHTML='';
}

async function liqAutoSync(){
  liqSyncStatus='syncing';updateSyncBadge();liqSyncCount=0;const liqSyncNew=[];
  try{
    // Step 1: Fetch Results page ‚Üí discover tournaments + LP page links
    const rd=await liqFetch({action:'parse',page:'Bilibili_Gaming/Results',prop:'text'});
    if(!rd?.parse?.text?.['*']){liqSyncStatus='error';updateSyncBadge();return}
    const doc=new DOMParser().parseFromString(rd.parse.text['*'],'text/html');
    const tournaments=[];
    doc.querySelectorAll('tr').forEach(row=>{
      const cells=row.querySelectorAll('td');if(cells.length<4)return;
      const date=cells[0]?.textContent?.trim()||'';
      const place=cells[1]?.textContent?.trim()||'';
      const eventCell=cells[4]||cells[3];
      const event=eventCell?.textContent?.trim()||'';
      if(!date||!event)return;
      const yr=date.substring(0,4);
      // Extract LP page path from <a href="/valorant/...">
      let lpPage=null;
      (eventCell||row).querySelectorAll('a[href]').forEach(a=>{
        const h=a.getAttribute('href')||'';
        if(h.startsWith('/valorant/')&&!h.includes('index.php')&&!h.includes('Category:')&&h.length>15){
          lpPage=decodeURIComponent(h.replace('/valorant/',''));
        }
      });
      // Fallback to manual map
      if(!lpPage){
        for(const[k,v]of Object.entries(LP_TOURN_MAP)){
          if(event.includes(k)||k.includes(event.substring(0,20))){lpPage=v;break}
        }
      }
      if(!lpPage){
        const ev=event.toLowerCase().replace(/[^a-z0-9]/g,'');
        for(const[k,v]of Object.entries(LP_TOURN_MAP)){
          const kn=k.toLowerCase().replace(/[^a-z0-9]/g,'');
          if(kn.includes(ev.substring(0,12))||ev.includes(kn.substring(0,12))){lpPage=v;break}
        }
      }
      tournaments.push({date,place,event,lpPage,yr});
    });
    console.log(`üì° LP AutoSync: ${tournaments.length}Í∞ú ÎåÄÌöå Î∞úÍ≤¨, ${tournaments.filter(t=>t.lpPage).length}Í∞ú LP Îß§Ìïë`);

    // Step 2: Determine which tournaments need fetching
    // Current year = always fetch, previous year = fetch if < 6 months old
    const now=new Date();const curYr=String(now.getFullYear());
    const sixMonthsAgo=new Date(now);sixMonthsAgo.setMonth(sixMonthsAgo.getMonth()-6);
    const sixStr=sixMonthsAgo.toISOString().substring(0,10);
    const toFetch=tournaments.filter(t=>t.lpPage&&(t.yr===curYr||t.date>=sixStr));
    const fetched=new Set();

    // Step 3: Fetch each tournament and merge BLG matches
    for(let i=0;i<toFetch.length;i++){
      const t=toFetch[i];
      if(fetched.has(t.lpPage))continue;
      fetched.add(t.lpPage);
      try{
        const blgMatches=await liqFetchTournDetail(t.lpPage);
        if(!blgMatches||!blgMatches.length)continue;
        // Merge into allData
        const yr=t.yr;
        if(!allData[yr])allData[yr]=[];
        // Tournament alias map for LP ‚Üí baselineData matching
        const TOURN_ALIAS={'china esports festival super champions cup':'CEFSCC',
          'valorant radiant international invitational':'Radiant Intl. Invitational',
          'radiant international invitational':'Radiant Intl. Invitational',
          'valorant champions tour':'VCT','shanghai esports masters':'Shanghai Esports Masters',
          'hero asian champions league':'HERO Asian Champions League',
          'esports world cup':'EWC','fgc valorant invitational':'FGC Invitational'};
        // Find or create tournament group
        let tg=allData[yr].find(g=>g.tournament===t.event);
        if(!tg){
          // Try alias match
          const evLc=t.event.toLowerCase();
          for(const[alias,base]of Object.entries(TOURN_ALIAS)){
            if(evLc.includes(alias)){tg=allData[yr].find(g=>g.tournament.includes(base));break}
          }
        }
        if(!tg){
          // Try fuzzy match
          const evLc=t.event.toLowerCase();
          tg=allData[yr].find(g=>g.tournament.toLowerCase().includes(evLc.substring(0,15))||evLc.includes(g.tournament.toLowerCase().substring(0,15)));
        }
        const isIntl=!!(t.event.match(/Champions|Masters|EWC|Esports World Cup|Radiant.*Invitational|SOOP|ACL|CEFSCC|HERO/i));
        if(!tg){tg={tournament:t.event,intl:isIntl,matches:[]};allData[yr].push(tg)}
        // Process each BLG match
        blgMatches.forEach(lm=>{
          const blgIsT1=(lm.team1||'').toLowerCase().includes('bilibili')||(lm.team1||'').toLowerCase().includes('blg');
          const oppName=blgIsT1?lm.team2:lm.team1;
          if(!oppName)return;
          const[s1,s2]=(lm.score||'0:0').split(':').map(Number);
          const bs=blgIsT1?s1:s2;const os=blgIsT1?s2:s1;
          const isWin=bs>os;
          // Parse date from LP popup
          let mDate='';
          if(lm.date){
            const dm=lm.date.match(/(\w+)\s+(\d+),\s+(\d{4})/);
            if(dm){const mo=['January','February','March','April','May','June','July','August','September','October','November','December'].indexOf(dm[1]);
              if(mo>=0)mDate=`${dm[3]}-${String(mo+1).padStart(2,'0')}-${dm[2].padStart(2,'0')}`}
          }
          // Build maps
          const side=blgIsT1?1:2;
          const maps=lm.maps.filter(g=>g.mapName||g.score1>0||g.t1agents.length>0).map(g=>({
            n:g.mapName||'?',
            b:side===1?g.score1:g.score2,
            o:side===1?g.score2:g.score1,
            r:(side===1?g.score1:g.score2)>(side===1?g.score2:g.score1)?'win':'loss',
          })).filter(g=>g.b>0||g.o>0);
          const fmt=maps.length>3?'Bo5':'Bo3';
          const oppTag=guessTag(oppName);
          // Check if match already exists (by date + opponent)
          const existsInTg=tg.matches.some(x=>{
            if(x.tag===oppTag||x.opp===oppName)return x.date===mDate||(!mDate);
            const xOppLc=x.opp.toLowerCase(),oppLc=oppName.toLowerCase();
            return(xOppLc.includes(oppLc.split(' ')[0])||oppLc.includes(xOppLc.split(' ')[0]))&&x.date===mDate;
          });
          // Also check other tournament groups in same year (tournament name mismatch)
          const existsInYear=allData[yr].some(g2=>g2.matches.some(x=>{
            if(x.date!==mDate)return false;
            return x.tag===oppTag||x.opp===oppName||x.opp.toLowerCase().includes(oppName.toLowerCase().split(' ')[0]);
          }));
          if(!existsInTg&&!existsInYear&&mDate&&bs+os>0){
            const newMatch={date:mDate,opp:oppName,tag:oppTag,stage:'',fmt,bs,os,r:isWin?'win':'loss',maps,_liq:true};
            tg.matches.push(newMatch);
            liqSyncCount++;
            liqSyncNew.push({yr,tournament:tg.tournament,intl:tg.intl||false,match:newMatch});
            console.log(`üì° +NEW: ${mDate} BLG vs ${oppName} ${bs}:${os} (${t.event})`);
          }
          // Also populate liqMatchDetailCache for agent display (only if VLR data doesn't exist)
          const matchKey=findMatchKey(yr,tg,oppName,oppTag,mDate);
          if(matchKey&&!liqMatchDetailCache[matchKey]){const blgSide2=blgIsT1?1:2;liqMatchDetailCache[matchKey]={...lm,blgSide:blgSide2}}
        });
      }catch(e){console.log(`üì° LP fetch fail: ${t.lpPage}`,e.message)}
      // Rate limit: 2.5s between requests
      if(i<toFetch.length-1)await new Promise(r=>setTimeout(r,2500));
    }
    // Step 4: Save to localStorage & re-render
    if(liqSyncNew.length>0)saveSyncedMatches(liqSyncNew);
    // Re-run preloadAgents to update cache keys after index shifts
    preloadAgents();restoreVlrSync();
    renderAll();
    liqSyncStatus='done';updateSyncBadge();
    console.log(`üì° LP AutoSync ÏôÑÎ£å: ${liqSyncCount}Í∞ú ÏÉà Í≤ΩÍ∏∞ Ï∂îÍ∞Ä`);
  }catch(e){
    console.error('LP AutoSync error:',e);
    liqSyncStatus='error';updateSyncBadge();
  }
}

function findMatchKey(yr,tg,oppName,oppTag,date){
  const tIdx=allData[yr]?.indexOf(tg);if(tIdx<0)return null;
  const mIdx=tg.matches.findIndex(x=>(x.tag===oppTag||x.opp===oppName)&&x.date===date);
  if(mIdx<0)return null;
  return`${yr}_${tIdx}_${mIdx}`;
}

// ===== LOCAL STATS: MAP WIN RATES + H2H =====
function calcMapStats(){
  const maps={};
  Object.values(allData).forEach(ya=>ya.forEach(t=>t.matches.forEach(m=>{
    if(!m.maps||!m.maps.length)return;
    m.maps.forEach(p=>{
      if(!p.n)return;
      if(!maps[p.n])maps[p.n]={w:0,l:0,rw:0,rl:0};
      const s=maps[p.n];
      if(p.r==='win'){s.w++;s.rw+=p.b;s.rl+=p.o}else{s.l++;s.rw+=p.b;s.rl+=p.o}
    });
  })));
  return Object.entries(maps).map(([n,s])=>({name:n,w:s.w,l:s.l,total:s.w+s.l,wr:s.w+s.l?Math.round(s.w/(s.w+s.l)*100):0,rw:s.rw,rl:s.rl})).sort((a,b)=>b.total-a.total);
}

function calcH2H(){
  const h2h={};
  Object.values(allData).forEach(ya=>ya.forEach(t=>t.matches.forEach(m=>{
    const tag=m.tag||m.opp;if(!tag)return;
    if(!h2h[tag])h2h[tag]={opp:m.opp,w:0,l:0,mw:0,ml:0};
    const s=h2h[tag];
    if(m.r==='win')s.w++;else s.l++;
    s.mw+=(m.bs||0);s.ml+=(m.os||0);
  })));
  return Object.entries(h2h).map(([tag,s])=>({tag,opp:s.opp,w:s.w,l:s.l,total:s.w+s.l,mw:s.mw,ml:s.ml})).sort((a,b)=>b.total-a.total);
}

function calcYearMapStats(year){
  const maps={};
  (allData[year]||[]).forEach(t=>t.matches.forEach(m=>{
    if(!m.maps||!m.maps.length)return;
    m.maps.forEach(p=>{
      if(!p.n)return;
      if(!maps[p.n])maps[p.n]={w:0,l:0};
      if(p.r==='win')maps[p.n].w++;else maps[p.n].l++;
    });
  }));
  return Object.entries(maps).map(([n,s])=>({name:n,w:s.w,l:s.l,total:s.w+s.l,wr:s.w+s.l?Math.round(s.w/(s.w+s.l)*100):0})).sort((a,b)=>b.total-a.total);
}

function renderStatsView(){
  const el=document.getElementById('statsView');
  const allStats=cs('all');
  const mapStats=calcMapStats();
  const h2hStats=calcH2H();
  const yrs=Object.keys(allData).sort((a,b)=>b-a);
  let h='';

  // Overall summary
  h+=`<div class="stats-section"><div class="stats-section-title">üìà Ï†ÑÏ≤¥ ÌÜµÏÇ∞ ÏÑ±Ï†Å</div>
  <div class="stat-grid">
    <div class="stat-card"><div class="sv bc">${allStats.total}</div><div class="sl">Ï¥ù Í≤ΩÍ∏∞</div></div>
    <div class="stat-card"><div class="sv wc">${allStats.w}</div><div class="sl">ÏäπÎ¶¨</div></div>
    <div class="stat-card"><div class="sv lc">${allStats.l}</div><div class="sl">Ìå®Î∞∞</div></div>
    <div class="stat-card"><div class="sv" style="color:${allStats.wr>=50?'var(--win)':'var(--loss)'}">${allStats.wr}%</div><div class="sl">ÏäπÎ•†</div></div>
    <div class="stat-card"><div class="sv" style="color:var(--txt)">${allStats.mw}<span style="color:var(--dimmer)">:</span>${allStats.ml}</div><div class="sl">Îßµ Ïä§ÏΩîÏñ¥</div></div>
  </div></div>`;

  // Year-by-year breakdown
  h+=`<div class="stats-section"><div class="stats-section-title">üìÖ Ïó∞ÎèÑÎ≥Ñ ÏÑ±Ï†Å</div>
  <div class="stat-grid">`;
  yrs.forEach(y=>{const s=cys(y);const wr=s.total?Math.round(s.w/s.total*100):0;
    h+=`<div class="stat-card"><div class="sv" style="color:var(--cyan)">${y}</div><div class="sl" style="font-size:12px;color:var(--txt);margin-top:4px"><span style="color:var(--win)">${s.w}W</span> / <span style="color:var(--loss)">${s.l}L</span> ¬∑ ${wr}%</div></div>`;
  });
  h+=`</div></div>`;

  // Map stats
  h+=`<div class="stats-section"><div class="stats-section-title">üó∫Ô∏è ÎßµÎ≥Ñ ÏäπÎ•† (Ï†ÑÏ≤¥)</div>`;
  if(mapStats.length===0){
    h+=`<div style="color:var(--dim);font-size:12px;padding:10px">Îßµ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÍ∏∞Îßå ÏßëÍ≥ÑÎê©ÎãàÎã§</div>`;
  }else{
    mapStats.forEach(m=>{
      const c=m.wr>=60?'var(--win)':m.wr>=45?'var(--cyan)':'var(--loss)';
      h+=`<div class="map-bar-wrap"><div class="map-bar-label"><span class="mn">${m.name}</span><span class="mr">${m.w}W ${m.l}L ¬∑ <b style="color:${c}">${m.wr}%</b> ¬∑ ${m.total}Îßµ</span></div><div class="map-bar"><div class="map-bar-fill" style="width:${m.wr}%;background:${c}"></div></div></div>`;
    });
  }
  h+=`</div>`;

  // Year-specific map stats
  yrs.forEach(y=>{
    const ym=calcYearMapStats(y);
    if(!ym.length)return;
    h+=`<div class="stats-section"><div class="stats-section-title">üó∫Ô∏è ${y} ÎßµÎ≥Ñ ÏäπÎ•†</div>`;
    ym.forEach(m=>{
      const c=m.wr>=60?'var(--win)':m.wr>=45?'var(--cyan)':'var(--loss)';
      h+=`<div class="map-bar-wrap"><div class="map-bar-label"><span class="mn">${m.name}</span><span class="mr">${m.w}W ${m.l}L ¬∑ <b style="color:${c}">${m.wr}%</b></span></div><div class="map-bar"><div class="map-bar-fill" style="width:${m.wr}%;background:${c}"></div></div></div>`;
    });
    h+=`</div>`;
  });

  // H2H
  h+=`<div class="stats-section"><div class="stats-section-title">ü§ù ÏÉÅÎåÄ Ï†ÑÏ†Å (Head-to-Head)</div>`;
  h2hStats.forEach(s=>{
    const wr=s.total?Math.round(s.w/s.total*100):0;
    h+=`<div class="h2h-row">${L(s.tag,'sm')}<div class="h2h-team"><span class="tm">${DT(s.tag)}</span></div><div class="h2h-record"><span style="color:var(--win)">${s.w}</span><span style="color:var(--dimmer)">-</span><span style="color:var(--loss)">${s.l}</span></div><div class="h2h-bar"><div class="hw" style="width:${wr}%"></div><div class="hl" style="width:${100-wr}%"></div></div><span style="font-size:11px;color:var(--dim);min-width:35px;text-align:right">${wr}%</span></div>`;
  });
  h+=`</div>`;

  el.innerHTML=h;
}

// ===== ROSTER (Liquipedia API, 1x at load) =====
let rosterData=null;
let rosterYear=String(new Date().getFullYear());
const ROSTER_CACHE={
  "2026":{event:"VCT 2026",players:[
    {name:"whz",real:"Wang Haozhe",role:"Duelist",flag:"üá®üá≥"},
    {name:"Knight",real:"Liu Yuxiang",role:"Initiator",flag:"üá®üá≥"},
    {name:"nephh",real:"Marcus Tan Kai Wen",role:"Duelist",flag:"üá∏üá¨"},
    {name:"rushia",real:"Wang Xiaojie",role:"Sentinel",flag:"üá®üá≥"},
    {name:"bud",real:"Yang Renyu",role:"Flex",flag:"üá®üá≥"},
  ],coach:{name:"Muggle",real:"Tang Shijun",flag:"üá®üá≥"}},
  "2025":{event:"VCT 2025",players:[
    {name:"nephh",real:"Marcus Tan Kai Wen",role:"Duelist",flag:"üá∏üá¨"},
    {name:"whzy",real:"Wang Haozhe",role:"Duelist",flag:"üá®üá≥"},
    {name:"Knight",real:"Liu Yuxiang",role:"Initiator",flag:"üá®üá≥"},
    {name:"Levius",real:"Lu Yinzhong",role:"Controller",flag:"üá®üá≥"},
    {name:"rushia",real:"Wang Xiaojie",role:"Sentinel",flag:"üá®üá≥"},
    {name:"Biank",real:"Zhong Jianfei",role:"Sub",flag:"üá®üá≥",sub:true},
  ],coach:{name:"bail",real:"Lee Sung-jae",flag:"üá∞üá∑"}},
  "2024":{event:"VCT 2024",players:[
    {name:"whzy",real:"Wang Haozhe",role:"Duelist",flag:"üá®üá≥"},
    {name:"Knight",real:"Liu Yuxiang",role:"Initiator",flag:"üá®üá≥"},
    {name:"Levius",real:"Lu Yinzhong",role:"Controller",flag:"üá®üá≥"},
    {name:"rushia",real:"Wang Xiaojie",role:"Sentinel",flag:"üá®üá≥"},
    {name:"nephh",real:"Marcus Tan Kai Wen",role:"Flex",flag:"üá∏üá¨"},
  ],coach:{name:"bail",real:"Lee Sung-jae",flag:"üá∞üá∑"}},
  "2023":{event:"VCT 2023",players:[
    {name:"whzy",real:"Wang Haozhe",role:"Duelist",flag:"üá®üá≥"},
    {name:"Knight",real:"Liu Yuxiang",role:"Initiator",flag:"üá®üá≥"},
    {name:"rin",real:"Li Lewei",role:"Sentinel",flag:"üá®üá≥"},
    {name:"Biank",real:"Zhong Jianfei",role:"Controller",flag:"üá®üá≥"},
    {name:"yosemite",real:"Wang Lei",role:"Flex",flag:"üá®üá≥"},
  ],coach:{name:"JeXeN",real:"Wang Linxiao",flag:"üá®üá≥"}},
};

async function fetchRoster(){
  const CUR_YEAR=String(new Date().getFullYear());
  renderRosterView();
  // 1) Try Liquipedia API first (free, no key needed)
  try{
    const liqRoster=await liqFetchRoster();
    if(liqRoster&&liqRoster.players.length>0){
      const existing=ROSTER_CACHE[CUR_YEAR];
      const updatedPlayers=liqRoster.players.map(lp=>{
        // Match with existing hardcoded data for role info
        const match=existing?.players?.find(ep=>ep.name.toLowerCase()===lp.name.toLowerCase()||ep.name.toLowerCase()===lp.name.replace(/z$/,'zy').toLowerCase());
        return{
          name:lp.name,
          real:lp.real||match?.real||'',
          role:match?.role||'',
          flag:lp.flag||match?.flag||'üá®üá≥',
          sub:lp.sub||false,
          captain:lp.captain||false
        };
      });
      // Find head coach from staff
      const hc=liqRoster.staff.find(s=>s.staffRole==='Head Coach')||liqRoster.staff[0];
      const existCoach=existing?.coach;
      const updatedCoach=hc?{
        name:hc.name,
        real:hc.real||existCoach?.real||'',
        flag:hc.flag||existCoach?.flag||'üá®üá≥'
      }:existCoach;
      if(updatedPlayers.length>0){
        ROSTER_CACHE[CUR_YEAR]={...ROSTER_CACHE[CUR_YEAR],event:ROSTER_CACHE[CUR_YEAR]?.event||`VCT ${CUR_YEAR}`,
          players:updatedPlayers,coach:updatedCoach,_liq:true};
        console.log('‚úÖ Liquipedia roster loaded:',updatedPlayers.map(p=>p.name).join(', '));
        renderRosterView();
      }
    }
  }catch(e){console.log('Liquipedia roster fetch failed:',e)}
}

// ===== LIQUIPEDIA MEDIAWIKI API (Î¨¥Î£å, ÌÇ§ Î∂àÌïÑÏöî) =====
const LIQ_API='https://liquipedia.net/valorant/api.php';
const LIQ_PX=[
  OWN_PROXY,
  u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
];
let liqProxy=null;

let liqOppStats=null;

async function liqFetch(params){
  params.format='json';
  const url=`${LIQ_API}?${new URLSearchParams(params)}`;
  const tries=liqProxy?[liqProxy,...LIQ_PX.filter(p=>p!==liqProxy)]:LIQ_PX;
  for(const px of tries){
    try{
      const r=await fetch(px(url),{headers:{'Accept':'application/json'},signal:AbortSignal.timeout(15000)});
      if(r.ok){
        const txt=await r.text();
        try{const d=JSON.parse(txt);if(d.parse){liqProxy=px;return d;}}catch(e){console.log('liqFetch JSON parse fail:',txt.substring(0,100))}
      }else{console.log('liqFetch HTTP',r.status,'from proxy',px.toString().substring(0,40))}
    }catch(e){console.log('liqFetch proxy fail:',e.message);continue}
  }
  return null;
}

function liqIsNoise(n){
  if(!n||n.length<2||n.length>30)return true;
  if(/^\[\d+\]$/.test(n)||/^\d+$/.test(n)||/^[SABC]-Tier$/i.test(n))return true;
  if('edit,View,talk,history,hide,show,Navigation,Bilibili Gaming,Online,Offline,TBD,TBA,N/A,vs,Roster'.split(',').includes(n))return true;
  if(/^(January|February|March|April|May|June|July|August|September|October|November|December)/i.test(n))return true;
  if(/^[\d\s\-:,\.\(\)]+$/.test(n))return true;
  return false;
}

async function liqFetchRoster(){
  const sd=await liqFetch({action:'parse',page:'Bilibili_Gaming',prop:'sections'});
  if(!sd?.parse)return null;
  const ss=sd.parse.sections||[];
  let pi=null,oi=null,z='';
  for(const s of ss){if(s.line==='Player Roster')z='p';if(s.line==='Organization')z='o';if(s.line==='Active'&&z==='p'&&!pi)pi=s.index;if(s.line==='Active'&&z==='o'&&!oi)oi=s.index;}

  await new Promise(r=>setTimeout(r,2500));
  const pd=await liqFetch({action:'parse',page:'Bilibili_Gaming',prop:'text',section:pi||'4'});
  const ph=pd?.parse?.text?.['*']||'';if(!ph)return null;
  const r=liqParseRoster(ph);
  let sf=[];
  if(oi){await new Promise(r2=>setTimeout(r2,2500));
    const od=await liqFetch({action:'parse',page:'Bilibili_Gaming',prop:'text',section:oi});
    if(od?.parse?.text?.['*']){const or=liqParseRoster(od.parse.text['*']);sf=[...or.players,...or.staff];}
  }
  return{players:r.players,staff:[...r.staff,...sf]};
}

function liqParseRoster(html){
  const doc=new DOMParser().parseFromString(html,'text/html'),p=[],s=[],seen=new Set();
  const FLAG_MAP={'China':'üá®üá≥','South Korea':'üá∞üá∑','Singapore':'üá∏üá¨','Japan':'üáØüáµ','United States':'üá∫üá∏','Canada':'üá®üá¶','Indonesia':'üáÆüá©','Thailand':'üáπüá≠','Vietnam':'üáªüá≥','Philippines':'üáµüá≠','Malaysia':'üá≤üáæ','Taiwan':'üáπüáº','Hong Kong':'üá≠üá∞','Macau':'üá≤üá¥','Russia':'üá∑üá∫','Brazil':'üáßüá∑','Australia':'üá¶üá∫','Sweden':'üá∏üá™','Denmark':'üá©üá∞','Finland':'üá´üáÆ','Turkey':'üáπüá∑','France':'üá´üá∑','Germany':'üá©üá™','United Kingdom':'üá¨üáß','Mongolia':'üá≤üá≥','Myanmar':'üá≤üá≤','India':'üáÆüá≥','Pakistan':'üáµüá∞','Chile':'üá®üá±','Argentina':'üá¶üá∑','Mexico':'üá≤üáΩ','Peru':'üáµüá™','Colombia':'üá®üá¥','Latvia':'üá±üáª','Ukraine':'üá∫üá¶','Poland':'üáµüá±','Spain':'üá™üá∏','Portugal':'üáµüáπ','Netherlands':'üá≥üá±','Belgium':'üáßüá™','Czech Republic':'üá®üáø','Israel':'üáÆüá±','Morocco':'üá≤üá¶','Egypt':'üá™üá¨','Saudi Arabia':'üá∏üá¶','Jordan':'üáØüá¥'};
  doc.querySelectorAll('table tr').forEach(row=>{
    const cells=Array.from(row.querySelectorAll('td'));if(cells.length<2)return;
    // Find player/staff link
    let name='',href='',country='',real='',role='';
    for(const cell of cells){
      cell.querySelectorAll('a[href*="/valorant/"]').forEach(a=>{
        const h=a.getAttribute('href')||'',n=a.textContent.trim();
        if(!n||liqIsNoise(n)||h.includes('Bilibili_Gaming')||h.includes('Category:'))return;
        if(!name){name=n;href=h;}
      });
    }
    if(!name||seen.has(name))return;seen.add(name);
    // Extract flag from img alt/title
    row.querySelectorAll('img').forEach(img=>{
      const src=(img.getAttribute('src')||'').toLowerCase();
      const alt=img.getAttribute('alt')||'';
      if(src.includes('_hd.png')||src.includes('flag')){
        const parent=img.closest('a');
        const title=parent?.getAttribute('title')||alt||'';
        if(title&&FLAG_MAP[title])country=title;
      }
    });
    // Extract real name from cells containing parentheses pattern or plain text after ID
    for(const cell of cells){
      const txt=cell.textContent.trim();
      // "(Wang Haozhe)  Wang Haozhe" pattern or just "Wang Haozhe"
      const pm=txt.match(/\(([A-Za-z\s\-]+)\)/);
      if(pm&&pm[1].length>3&&!pm[1].match(/Captain|Substitute|Coach|Manager|Streamer|Analyst|Leader/i)){
        real=pm[1].trim();break;
      }
    }
    // Extract role from row text
    const rt=row.textContent.toLowerCase();
    const isStaff=rt.includes('coach')||rt.includes('manager')||rt.includes('analyst')||rt.includes('team leader')||rt.includes('streamer');
    let staffRole='';
    if(rt.includes('head coach'))staffRole='Head Coach';
    else if(rt.includes('coach'))staffRole='Coach';
    else if(rt.includes('manager'))staffRole='Manager';
    else if(rt.includes('team leader'))staffRole='Team Leader';
    else if(rt.includes('streamer'))staffRole='Streamer';
    else if(rt.includes('analyst'))staffRole='Analyst';
    // Check for Captain/Sub markers
    const isCaptain=rt.includes('captain');
    const isSub=rt.includes('substitute')||rt.includes('(sub)');
    const flag=FLAG_MAP[country]||'üá®üá≥';
    const entry={name,real,country,flag};
    if(isStaff){entry.staffRole=staffRole;s.push(entry);}
    else{entry.captain=isCaptain;entry.sub=isSub;p.push(entry);}
  });
  return{players:p,staff:s};
}

// ===== LIQUIPEDIA MATCH HISTORY (Opponent Stats) =====
async function liqFetchOppStats(){
  const d=await liqFetch({action:'parse',page:'Bilibili_Gaming/Matches',prop:'text'});
  if(!d?.parse?.text?.['*'])return null;
  const html=d.parse.text['*'];
  return liqParseMatches(html);
}

function liqParseMatches(html){
  const doc=new DOMParser().parseFromString(html,'text/html'),ms=[];
  doc.querySelectorAll('tr').forEach(row=>{
    const cells=Array.from(row.querySelectorAll('td'));if(cells.length<3)return;
    let sc='',win=false,st='',si=-1;
    for(let i=0;i<cells.length;i++){const t=cells[i].textContent.replace(/\s+/g,' ').trim();let m=t.match(/^(\d)\s*:\s*(\d)$/);if(m){sc=m[1]+':'+m[2];win=+m[1]>+m[2];si=i;st='bo';break;}m=t.match(/^(\d{1,2})\s*-\s*(\d{1,2})$/);if(m){sc=m[1]+'-'+m[2];win=+m[1]>+m[2];si=i;st='round';break;}}
    if(si===-1){for(let i=0;i<cells.length;i++){const m=cells[i].textContent.replace(/\s+/g,' ').trim().match(/(\d)\s*:\s*(\d)/);if(m){sc=m[1]+':'+m[2];win=+m[1]>+m[2];si=i;st='bo';break;}}}
    if(!sc)return;
    const isT=a=>{const n=a.textContent.trim();if(!n||liqIsNoise(n)||n.length>20||n.match(/VCT|Champions|Stage|Kickoff|Masters|Invitational|EVO|Series|CEF|EWC|Radiant|Super|Group|Playoff|Week|Day|Tournament|ACL|Shanghai/i)||n.match(/Bilibili|BLG/i))return false;return n.length>=2&&n.length<=15;};
    let op='';
    for(let i=si+1;i<cells.length&&!op;i++)for(const a of cells[i].querySelectorAll('a'))if(isT(a)){op=a.textContent.trim();break;}
    if(!op)for(let i=si-1;i>=0&&!op;i--)for(const a of cells[i].querySelectorAll('a'))if(isT(a)){op=a.textContent.trim();break;}
    if(op&&st==='bo')ms.push({opponent:op,isWin:win});
  });
  // Aggregate
  const os={};
  ms.forEach(m=>{if(!os[m.opponent])os[m.opponent]={w:0,l:0};if(m.isWin)os[m.opponent].w++;else os[m.opponent].l++;});
  return{matches:ms,oppStats:os,total:ms.length,wins:ms.filter(m=>m.isWin).length};
}


function renderRosterView(){
  const el=document.getElementById('rosterView');
  const yrs=Object.keys(ROSTER_CACHE).sort((a,b)=>b-a);
  let h=`<div class="roster-year-tabs">`;
  yrs.forEach(y=>{h+=`<button class="roster-year-btn ${y===rosterYear?'active':''}" onclick="rosterYear='${y}';renderRosterView()">${y}</button>`});
  h+=`</div>`;

  const data=ROSTER_CACHE[rosterYear];
  if(!data){h+=`<div style="text-align:center;color:var(--dim);padding:40px">Î°úÏä§ÌÑ∞ Ï†ïÎ≥¥ ÏóÜÏùå</div>`;el.innerHTML=h;return}

  h+=`<div class="roster-card"><div class="roster-header">${L('BLG','lg')}<div><div class="rh-year">${rosterYear}${data._liq?'<span class="liq-badge">üì° Liquipedia</span>':''}</div><div class="rh-event">${data.event||''}</div></div></div>`;
  h+=`<div class="roster-grid">`;
  (data.players||[]).forEach(p=>{
    h+=`<div class="player-card ${p.sub?'sub':''}"><div class="p-flag">${p.flag||'üá®üá≥'}</div><div class="p-role">${p.role||''}${p.sub?' ¬∑ SUB':''}</div><div class="p-name">${p.name}</div><div class="p-real">${p.real||''}</div></div>`;
  });
  if(data.coach){
    h+=`<div class="player-card coach"><div class="p-flag">${data.coach.flag||'üá®üá≥'}</div><div class="p-role">COACH</div><div class="p-name">${data.coach.name}</div><div class="p-real">${data.coach.real||''}</div></div>`;
  }
  h+=`</div>`;

  // Transfer timeline
  h+=renderTransferTimeline(rosterYear);

  h+=`</div>`;
  el.innerHTML=h;
}

// ===== TRANSFER HISTORY =====
let transferData=[];
let transferFilterYear='all';
const TRANSFER_BASELINE=[
// 2026
{date:'2026-01-13',player:'Biank',type:'promote',detail:'ÏÑúÎ∏å ‚Üí ÏûÑÏãú Ïä§ÌÉÄÌÑ∞ (Knight ÏûÖÏõê)',from:'BLG'},
{date:'2026-01-06',player:'Muggle',type:'join',detail:'Ïï†ÎÑêÎ¶¨Ïä§Ìä∏ Ìï©Î•ò',from:''},
// 2025
{date:'2025-10-20',player:'whzy',type:'role',detail:'whzy ‚Üí whz (ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω)',from:'BLG'},
{date:'2025-09-10',player:'Biank',type:'join',detail:'ÏÑúÎ∏å ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2025-01-15',player:'nephh',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò (üá∏üá¨)',from:'Paper Rex'},
{date:'2025-01-10',player:'bud',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2025-01-10',player:'yosemite',type:'leave',detail:'ÌåÄ Ïù¥ÌÉà',from:'BLG'},
{date:'2025-01-10',player:'rin',type:'leave',detail:'ÌåÄ Ïù¥ÌÉà',from:'BLG'},
// 2024
{date:'2024-10-01',player:'JeXeN',type:'leave',detail:'ÏΩîÏπò Í≥ÑÏïΩ Ï¢ÖÎ£å',from:'BLG'},
{date:'2024-10-01',player:'bail',type:'join',detail:'ÏΩîÏπò Ìï©Î•ò (üá∞üá∑)',from:''},
{date:'2024-05-20',player:'yosemite',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2024-01-15',player:'rushia',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2024-01-15',player:'rin',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2024-01-10',player:'Levius',type:'leave',detail:'ÌåÄ Ïù¥ÌÉà',from:'BLG'},
// 2023
{date:'2023-06-01',player:'Knight',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2023-06-01',player:'whzy',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2023-06-01',player:'Levius',type:'join',detail:'ÏÑ†Ïàò Ìï©Î•ò',from:''},
{date:'2023-06-01',player:'JeXeN',type:'join',detail:'ÏΩîÏπò Ìï©Î•ò',from:''},
{date:'2023-05-01',player:'BLG VALORANT',type:'join',detail:'ÌåÄ Ï∞ΩÎã®',from:'Bilibili Gaming'},
];

async function fetchTransfers(){
  transferData=[...TRANSFER_BASELINE];
  // Try Liquipedia for latest transfers
  try{
    const sd=await liqFetch({action:'parse',page:'Bilibili_Gaming',prop:'sections'});
    if(!sd?.parse)return;
    const ss=sd.parse.sections||[];
    let tfIdx=null;
    for(const s of ss){
      if(s.line&&(s.line.includes('Roster Changes')||s.line.includes('Player Roster Changes')||s.line==='Transfers')){
        tfIdx=s.index;break;
      }
    }
    if(!tfIdx)return;
    await new Promise(r=>setTimeout(r,2500));
    const td=await liqFetch({action:'parse',page:'Bilibili_Gaming',prop:'text',section:tfIdx});
    if(!td?.parse?.text?.['*'])return;
    const parsed=liqParseTransfers(td.parse.text['*']);
    if(parsed.length>0){
      // Merge: add any Liquipedia entries not in baseline
      const baseKeys=new Set(transferData.map(t=>`${t.date}_${t.player}_${t.type}`));
      let added=0;
      parsed.forEach(p=>{
        const key=`${p.date}_${p.player}_${p.type}`;
        if(!baseKeys.has(key)){transferData.push(p);added++;}
      });
      if(added>0)console.log(`‚úÖ Liquipedia transfers: ${added}Í∞ú Ï∂îÍ∞Ä`);
    }
  }catch(e){console.log('Transfer fetch failed:',e)}
  // Sort by date desc
  transferData.sort((a,b)=>b.date.localeCompare(a.date));
  renderRosterView();
}

function liqParseTransfers(html){
  const doc=new DOMParser().parseFromString(html,'text/html');
  const results=[];
  const rows=doc.querySelectorAll('.divRow, .roster-change-row, table tr');
  rows.forEach(row=>{
    const cells=row.querySelectorAll('.divCell, td');
    if(cells.length<2)return;
    let date='',player='',type='',detail='',from='';
    // Try to extract date
    const allText=row.textContent;
    const dateMatch=allText.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(dateMatch)date=dateMatch[0];
    else{
      const dateMatch2=allText.match(/(\w+ \d{1,2}, \d{4})/);
      if(dateMatch2){
        try{const d=new Date(dateMatch2[1]);if(!isNaN(d))date=d.toISOString().substring(0,10);}catch(e){}
      }
    }
    if(!date)return;
    // Extract player names from links
    const links=row.querySelectorAll('a[href*="/valorant/"]');
    links.forEach(a=>{
      const n=a.textContent.trim(),h=a.getAttribute('href')||'';
      if(n&&!liqIsNoise(n)&&!h.includes('Bilibili_Gaming')&&!h.includes('Category:')&&n.length<=20){
        if(!player)player=n;
      }
    });
    if(!player)return;
    // Determine type from text
    const lt=allText.toLowerCase();
    if(lt.includes('joins')||lt.includes('join')||lt.includes('signs')||lt.includes('sign')||lt.includes('added')||lt.includes('Ìï©Î•ò'))type='join';
    else if(lt.includes('leaves')||lt.includes('left')||lt.includes('released')||lt.includes('departed')||lt.includes('Ïù¥ÌÉà')||lt.includes('benched'))type='leave';
    else if(lt.includes('promoted')||lt.includes('moved to active')||lt.includes('ÏäπÍ≤©'))type='promote';
    else if(lt.includes('role change')||lt.includes('moved to')||lt.includes('Î≥ÄÍ≤Ω'))type='role';
    else type=lt.includes('inactive')||lt.includes('bench')?'leave':'join';
    // Extract detail
    if(lt.includes('coach'))detail=(type==='join'?'ÏΩîÏπò Ìï©Î•ò':'ÏΩîÏπò Ïù¥ÌÉà');
    else if(lt.includes('analyst'))detail=(type==='join'?'Ïï†ÎÑêÎ¶¨Ïä§Ìä∏ Ìï©Î•ò':'Ïï†ÎÑêÎ¶¨Ïä§Ìä∏ Ïù¥ÌÉà');
    else if(lt.includes('manager'))detail=(type==='join'?'Îß§ÎãàÏ†Ä Ìï©Î•ò':'Îß§ÎãàÏ†Ä Ïù¥ÌÉà');
    else if(lt.includes('substitute')||lt.includes('sub'))detail=(type==='join'?'ÏÑúÎ∏å ÏÑ†Ïàò Ìï©Î•ò':'ÏÑúÎ∏å Ìï¥Ï†ú');
    else detail=(type==='join'?'ÏÑ†Ïàò Ìï©Î•ò':type==='leave'?'ÌåÄ Ïù¥ÌÉà':type==='promote'?'Ïä§ÌÉÄÌÑ∞ ÏäπÍ≤©':'Ïó≠Ìï† Î≥ÄÍ≤Ω');
    // Check for "from TEAM" pattern
    const fromMatch=allText.match(/from\s+([A-Za-z0-9\s]+?)(?:\s*\(|\s*$|\s*,)/i);
    if(fromMatch&&fromMatch[1].trim()!=='Bilibili Gaming')from=fromMatch[1].trim();
    results.push({date,player,type,detail,from});
  });
  return results;
}

function renderTransferTimeline(year){
  if(!transferData.length)return'<div class="tf-section"><div class="tf-header"><div class="tf-title">Ïù¥Ï†Å Í∏∞Î°ù</div></div><div class="tf-empty">üì° Ïù¥Ï†Å Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...</div></div>';
  const filtered=year==='all'||transferFilterYear==='all'?transferData:transferData.filter(t=>t.date.startsWith(year));
  // Get available years
  const tfYears=[...new Set(transferData.map(t=>t.date.substring(0,4)))].sort((a,b)=>b-a);
  const activeFilter=transferFilterYear==='all'?year:transferFilterYear;

  let h=`<div class="tf-section"><div class="tf-header"><div class="tf-title">Ïù¥Ï†Å Í∏∞Î°ù <span class="tf-badge">${transferData.length}Í±¥</span></div>`;
  h+=`<div class="tf-year-filter">`;
  tfYears.forEach(y=>{h+=`<button class="tf-year-btn ${y===activeFilter?'active':''}" onclick="transferFilterYear='${y}';renderRosterView()">${y}</button>`});
  h+=`<button class="tf-year-btn ${activeFilter==='all'?'active':''}" onclick="transferFilterYear='all';renderRosterView()">Ï†ÑÏ≤¥</button>`;
  h+=`</div></div>`;

  const show=activeFilter==='all'?transferData:transferData.filter(t=>t.date.startsWith(activeFilter));
  if(!show.length){h+=`<div class="tf-empty">Ìï¥Îãπ Ïó∞ÎèÑ Ïù¥Ï†Å Í∏∞Î°ù ÏóÜÏùå</div></div>`;return h;}

  h+=`<div class="tf-timeline">`;
  let lastMonth='';
  show.forEach(t=>{
    const m=t.date.substring(0,7);
    if(m!==lastMonth){
      const[yy,mm]=m.split('-');
      h+=`<div style="font-size:11px;color:var(--dimmer);font-family:'JetBrains Mono',monospace;margin:${lastMonth?'14px':'0'} 0 6px 4px">${yy}.${mm}</div>`;
      lastMonth=m;
    }
    const icon=t.type==='join'?'‚ûï':t.type==='leave'?'‚ûñ':t.type==='promote'?'‚¨ÜÔ∏è':'üîÑ';
    const typeLabel=t.type==='join'?'Ìï©Î•ò':t.type==='leave'?'Ïù¥ÌÉà':t.type==='promote'?'ÏäπÍ≤©':'Î≥ÄÍ≤Ω';
    h+=`<div class="tf-item ${t.type}">`;
    h+=`<div class="tf-date">${t.date}</div>`;
    h+=`<div class="tf-content">`;
    h+=`<span class="tf-type ${t.type}">${icon} ${typeLabel}</span>`;
    h+=`<span class="tf-player">${t.player}</span>`;
    h+=`<span class="tf-detail">${t.detail}</span>`;
    if(t.from&&t.type==='join')h+=`<span class="tf-from">‚Üê ${t.from}</span>`;
    h+=`</div></div>`;
  });
  h+=`</div></div>`;
  return h;
}

// ===== STANDINGS (vlresports, every 10min) =====
// ===== STANDINGS: HISTORICAL PLACEMENTS + LIVE 2026 =====
let standingsData=null;
let standingsUpdated='';
const PLACEMENTS={
  "2026":[
    {event:"VCT 2026: China Kickoff",place:"4th",type:"CN",note:"AG¬∑XLG¬∑EDG ÏßÑÏ∂ú, Knight ÏûÖÏõêÏúºÎ°ú Biank Ìà¨ÏûÖ",prize:""},
    {event:"VCT 2026: China Stage 1",place:"ÏßÑÌñâ ÏòàÏ†ï",type:"CN",note:"Group Alpha ¬∑ 3Ïõî 31Ïùº~",prize:"",live:true},
  ],
  "2025":[
    {event:"VCT 2025: China Kickoff",place:"3rd",type:"CN",note:"EDGÏóê 0-3 Ìå®, Masters Bangkok ÏßÑÏ∂ú Ïã§Ìå®",prize:""},
    {event:"China Evolution Series Act 1",place:"3rd",type:"CN",note:"",prize:""},
    {event:"VCT 2025: China Stage 1",place:"2nd",type:"CN",note:"Í≤∞Ïäπ XLGÏóê 1-3 Ìå®, Masters Toronto ÏßÑÏ∂ú",prize:""},
    {event:"VALORANT Masters Toronto",place:"9th-10th",type:"INTL",note:"TL 2-0 Ïäπ, SEN¬∑WolvesÏóê Ìå®",prize:"$25,000"},
    {event:"China Evo Series Act 2 x ACL",place:"9th-12th",type:"CN",note:"",prize:""},
    {event:"HERO Esports ACL",place:"4th",type:"INTL",note:"",prize:"$10,000"},
    {event:"Esports World Cup 2025",place:"9th-12th",type:"INTL",note:"G2 2-1 Ïäπ, PRX¬∑KCÏóê Ìå®",prize:"$25,000"},
    {event:"VCT 2025: China Stage 2",place:"1st üèÜ",type:"CN",note:"Í≤∞Ïäπ DRG 3-1 Ïäπ, whzy MVP",prize:""},
    {event:"China Evo Series Act 3",place:"9th-12th",type:"CN",note:"",prize:""},
    {event:"VALORANT Champions 2025",place:"13th-16th",type:"INTL",note:"MIBR 0-2, RRQ 1-2 Ìå®",prize:"$20,000"},
    {event:"China Esports Festival Super Cup",place:"3rd",type:"INTL",note:"",prize:"$7,067"},
    {event:"Shanghai Esports Masters",place:"3rd-4th",type:"CN",note:"",prize:""},
    {event:"Radiant Intl Invitational",place:"6th",type:"INTL",note:"Bo1 Í∑∏Î£π 0-4",prize:""},
  ],
  "2024":[
    {event:"VCT 2024: China Kickoff",place:"5th",type:"CN",note:"Masters Madrid ÏßÑÏ∂ú Ïã§Ìå®",prize:""},
    {event:"VCT 2024: China Stage 1",place:"7th-8th",type:"CN",note:"Ï†ïÍ∑úÏãúÏ¶å 2W-4L",prize:""},
    {event:"VCT 2024: China Stage 2",place:"4th",type:"CN",note:"Ï†ïÍ∑úÏãúÏ¶å 4W-3L, Champions ÏßÑÏ∂ú",prize:""},
    {event:"VALORANT Champions 2024",place:"13th-16th",type:"INTL",note:"FNC 0-2, KR√ú 0-2 (0Îßµ Ïäπ)",prize:"$20,000"},
    {event:"FGC Invitational 2024",place:"1st üèÜ",type:"CN",note:"Í≤∞Ïäπ Wolves 3-1 Ïäπ, Ï≤´ Ïö∞Ïäπ!",prize:""},
    {event:"Radiant Asia Invitational",place:"7th-8th",type:"INTL",note:"",prize:""},
    {event:"SOOP VALORANT League",place:"7th-8th",type:"INTL",note:"",prize:"$5,000"},
  ],
  "2023":[
    {event:"FGC Invitational Act 1",place:"9th-10th",type:"CN",note:"Ï≤´ ÎåÄÌöå, Ï°∞Î≥Ñ ÌÉàÎùΩ",prize:""},
    {event:"FGC Invitational Act 2",place:"2nd",type:"CN",note:"Í≤∞Ïäπ EDGÏóê 0-3 Ìå®",prize:""},
    {event:"VCT China Champions CQ",place:"2nd",type:"CN",note:"Í≤∞Ïäπ EDGÏóê 1-3 Ìå®, Champions ÏßÑÏ∂ú",prize:""},
    {event:"VALORANT Champions 2023",place:"7th-8th",type:"INTL",note:"NRG 2Ïó∞Ïäπ, DRXÏóê 0-2 Ìå® (Ïó≠ÎåÄ ÏµúÍ≥† Íµ≠Ï†ú ÏÑ±Ï†Å)",prize:"$50,000"},
    {event:"China Evolution Series Act 1",place:"5th-6th",type:"CN",note:"",prize:"$1,673"},
    {event:"China Evolution Series Act 2",place:"5th-6th",type:"CN",note:"",prize:"$1,640"},
    {event:"China Evolution Series Act 3",place:"9th-12th",type:"CN",note:"",prize:"$776"},
  ]
};

function placeColor(p){
  if(p.includes('1st'))return'var(--cyan)';
  if(p.includes('2nd'))return'#FFD700';
  if(p.includes('3rd'))return'#CD7F32';
  if(p.includes('4th')||p.includes('5th'))return'var(--win)';
  if(p.includes('ÏßÑÌñâ'))return'var(--cyan)';
  return'var(--dim)';
}
function placeIcon(p){
  if(p.includes('1st'))return'üèÜ';
  if(p.includes('2nd'))return'ü•à';
  if(p.includes('3rd'))return'ü•â';
  if(p.includes('ÏßÑÌñâ'))return'‚è≥';
  return'';
}

async function fetchStandings(){
  const CUR_YEAR=String(new Date().getFullYear());
  if(!PLACEMENTS[CUR_YEAR])PLACEMENTS[CUR_YEAR]=[];
  // Rankings: vlresports doesn't have rankings endpoint, use hardcoded PLACEMENTS
  renderStandingsView();
}

function renderStandingsView(){
  const el=document.getElementById('standingsView');
  const yrs=Object.keys(PLACEMENTS).sort((a,b)=>b-a);
  let h=`<div class="standings-wrap">`;

  // BLG ranking badge
  if(standingsData&&standingsData.blgRank){
    const wr=standingsData.blgRank.world;const cr=standingsData.blgRank.china;
    h+=`<div style="display:flex;gap:8px;justify-content:center;margin-bottom:14px">`;
    if(wr)h+=`<div class="stat-card" style="flex:0 0 auto;padding:10px 20px"><div class="sv" style="color:var(--cyan)">#${wr}</div><div class="sl">ÏÑ∏Í≥Ñ Îû≠ÌÇπ</div></div>`;
    if(cr)h+=`<div class="stat-card" style="flex:0 0 auto;padding:10px 20px"><div class="sv" style="color:var(--cyan)">#${cr}</div><div class="sl">Ï§ëÍµ≠ Îû≠ÌÇπ</div></div>`;
    h+=`</div>`;
  }

  // Year tabs
  h+=`<div class="roster-year-tabs" style="margin-bottom:16px">`;
  yrs.forEach(y=>{h+=`<button class="roster-year-btn ${y===yrs[0]?'active':''}" onclick="filterStandingsYear('${y}',this)">${y}</button>`});
  h+=`<button class="roster-year-btn" onclick="filterStandingsYear('all',this)">Ï†ÑÏ≤¥</button></div>`;

  // Placement cards per year
  yrs.forEach(y=>{
    const placements=PLACEMENTS[y]||[];
    const cnCount=placements.filter(p=>p.type==='CN').length;
    const intlCount=placements.filter(p=>p.type==='INTL').length;
    const trophies=placements.filter(p=>p.place.includes('1st')).length;
    const top3=placements.filter(p=>p.place.match(/1st|2nd|3rd/)).length;

    h+=`<div class="standings-card standings-year-card" data-year="${y}">`;
    h+=`<div class="standings-title"><span>${y}</span><span style="font-size:11px;color:var(--dim);font-weight:400;margin-left:auto">${placements.length}Í∞ú ÎåÄÌöå ¬∑ CN ${cnCount} ¬∑ Íµ≠Ï†ú ${intlCount}${trophies?' ¬∑ üèÜ'+trophies:''}${top3>trophies?' ¬∑ üèÖTop3 '+top3:''}</span></div>`;
    h+=`<table class="standings-table"><thead><tr><th style="width:40%">ÎåÄÌöå</th><th style="width:18%">ÏàúÏúÑ</th><th>Ïú†Ìòï</th><th>ÎπÑÍ≥†</th></tr></thead><tbody>`;

    placements.forEach(p=>{
      const ic=placeIcon(p.place);
      const clr=placeColor(p.place);
      const typeTag=p.type==='INTL'?'<span style="color:#FFD700;font-size:10px;font-weight:700">üåç Íµ≠Ï†ú</span>':'<span style="color:var(--dim);font-size:10px">üá®üá≥ CN</span>';
      h+=`<tr${p.live?' style="background:rgba(0,212,255,.08)"':''}>`;
      h+=`<td style="font-size:12px;font-weight:600">${p.event}</td>`;
      h+=`<td style="color:${clr};font-weight:800;font-family:'Orbitron',sans-serif;font-size:13px">${ic} ${p.place}</td>`;
      h+=`<td>${typeTag}</td>`;
      h+=`<td style="font-size:11px;color:var(--dim)">${p.note}${p.prize?' ¬∑ <b style="color:var(--win)">'+p.prize+'</b>':''}</td>`;
      h+=`</tr>`;
    });
    h+=`</tbody></table></div>`;
  });

  // Overall summary
  const allP=Object.values(PLACEMENTS).flat();
  const totalPrize=allP.reduce((s,p)=>{const m=(p.prize||'').match(/\$([\d,]+)/);return s+(m?parseInt(m[1].replace(/,/g,'')):0)},0);
  h+=`<div style="text-align:center;margin:16px 0 8px">`;
  h+=`<span class="stat-card" style="display:inline-block;padding:8px 16px;margin:0 4px"><span class="sv" style="font-size:16px;color:var(--cyan)">${allP.length}</span><span class="sl"> Ï¥ù ÎåÄÌöå</span></span>`;
  h+=`<span class="stat-card" style="display:inline-block;padding:8px 16px;margin:0 4px"><span class="sv" style="font-size:16px;color:#FFD700">${allP.filter(p=>p.place.includes('1st')).length}üèÜ</span><span class="sl"> Ïö∞Ïäπ</span></span>`;
  h+=`<span class="stat-card" style="display:inline-block;padding:8px 16px;margin:0 4px"><span class="sv" style="font-size:16px;color:var(--win)">$${totalPrize.toLocaleString()}</span><span class="sl"> Ï¥ù ÏÉÅÍ∏à</span></span>`;
  h+=`</div>`;

  if(standingsUpdated)h+=`<div class="standings-updated">ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${standingsUpdated}</div>`;
  h+=`</div>`;
  el.innerHTML=h;
}

function filterStandingsYear(yr,btn){
  document.querySelectorAll('.standings-wrap .roster-year-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.standings-year-card').forEach(c=>{
    if(yr==='all')c.style.display='';
    else c.style.display=c.dataset.year===yr?'':'none';
  });
}

// ===== AUTO UPCOMING SCHEDULE UPDATE =====
async function fetchUpcomingSchedule(){
  let matches=[];
  // 0) Try Riot Esports API (official!)
  try{
    const events=await getRiotSchedule();
    const upcoming=events.filter(ev=>ev.state==='unstarted'&&ev.match?.teams?.some(t=>isBLGTeam(t)));
    upcoming.forEach(ev=>{
      const teams=ev.match.teams;
      const isBLG0=isBLGTeam(teams[0]);
      const oppTeam=isBLG0?teams[1]:teams[0];
      const date=ev.startTime?.substring(0,10)||'';
      const time=ev.startTime?new Date(ev.startTime).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
      matches.push({event:ev.league?.name||'VCT CN',stage:ev.blockName||'',date,
        dateLabel:date?`${parseInt(date.substring(5,7))}Ïõî ${parseInt(date.substring(8,10))}Ïùº`:'TBD',
        format:`Bo${ev.match.strategy?.count||3}`,opponent:oppTeam.name,oppTag:oppTeam.code?guessTag(oppTeam.code):guessTag(oppTeam.name),
        time:time?time+' KST':''});
    });
  }catch(e){}
  // 1) Try vlresports
  try{
    const d=await proxyFetchJSON('https://vlr.orlandomm.net/api/v1/matches');
    if(d&&Array.isArray(d.data)){
      d.data.forEach(m=>{
        if(!m.teams||m.teams.length<2)return;
        const t1=(m.teams[0].name||'').toLowerCase(),t2=(m.teams[1].name||'').toLowerCase();
        if(t1.includes('bilibili')||t1.includes('blg')||t2.includes('bilibili')||t2.includes('blg')){
          const st=(m.status||'').toLowerCase();
          if(st==='live'||st==='ongoing')return; // skip live
          const opp=t1.includes('bilibili')||t1.includes('blg')?m.teams[1].name:m.teams[0].name;
          matches.push({event:m.event?.name||'VCT',stage:'',date:m.createdAt?.substring(0,10)||'',dateLabel:m.eta||m.createdAt?.substring(0,10)||'',format:'Bo3',opponent:opp,oppTag:guessTag(opp)});
        }
      });
    }
  }catch(e){}
  if(!matches.length)return;
  let newCount=0;
  matches.forEach(m=>{
    const existing=upcomingData.find(u=>u.date===m.date&&u.event===m.event);
    if(!existing){
      newCount++;
      notifyNewSchedule(m.event,m.dateLabel||m.date,m.opponent);
      upcomingData.unshift({event:m.event,stage:m.stage||'',date:m.date,dateLabel:m.dateLabel||m.date,format:m.format||'Bo3',
        opponents:m.opponent?[m.opponent]:[],note:m.time?`${m.time} ÏãúÏûë`:'',confirmed:true,
        groupTeams:m.oppTag?[{name:'BLG',self:true},{name:m.oppTag,self:false}]:[]});
    }
  });
  upcomingData.sort((a,b)=>a.date.localeCompare(b.date));
  if(newCount)renderUpcoming();
}

// ===== PAGE NAVIGATION =====
function switchPage(pg){document.querySelectorAll('.pn-btn').forEach(b=>b.classList.toggle('active',b.dataset.page===pg));document.querySelectorAll('.page-view').forEach(v=>v.classList.toggle('active',v.id==='view-'+pg))}

// ===== SKINS: STATIC DATA =====
let blgSkinData=[];
let skinSyncStatus='idle';
const SKIN_META={
'2024':{price:'1,880 VP',priceDiscount:null,contents:['Classic Ïä§ÌÇ®','Í±¥ Î≤ÑÎîî'],cnRank:'CN 2ÏúÑ',added:'2024-05-14'},
'2025':{price:'2,320 VP',priceDiscount:'1,650 VP (Ïû¨Íµ¨Îß§)',contents:['Classic Ïä§ÌÇ®','Ïï†ÎãàÎ©îÏù¥ÏÖò ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú','Ïä§ÌîÑÎ†àÏù¥','Í±¥ Î≤ÑÎîî'],cnRank:'CN 2ÏúÑ',added:'2025-01-08'},
'2026':{price:'2,320 VP',priceDiscount:'1,650 VP (Ïû¨Íµ¨Îß§)',contents:['Classic Ïä§ÌÇ®','Ïï†ÎãàÎ©îÏù¥ÏÖò ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú','Ïä§ÌîÑÎ†àÏù¥','Í±¥ Î≤ÑÎîî'],cnRank:'TBD',added:'2026-01-13'}
};
function getSkinMeta(yr){return SKIN_META[yr]||{price:'2,320 VP',priceDiscount:'1,650 VP (Ïû¨Íµ¨Îß§)',contents:['Classic Ïä§ÌÇ®','ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú','Ïä§ÌîÑÎ†àÏù¥','Í±¥ Î≤ÑÎîî'],cnRank:'TBD',added:yr+'-01'}}

// Player Card variants (animated, small, wide, large)
const CARD_VARIANTS={
'2026':[
  {label:'Ïï†ÎãàÎ©îÏù¥ÏÖò',img:'https://static.wikia.nocookie.net/valorant/images/c/c4/VCT26_x_BLG_Card_animated.gif/revision/latest?cb=20260110183254',type:'gif'},
  {label:'Small',img:'https://static.wikia.nocookie.net/valorant/images/5/5c/VCT26_x_BLG_Card_Small.png/revision/latest?cb=20260106172256',type:'png'},
  {label:'Wide',img:'https://static.wikia.nocookie.net/valorant/images/2/2f/VCT26_x_BLG_Card_Wide.png/revision/latest?cb=20260106172257',type:'png'},
  {label:'Large',img:'https://static.wikia.nocookie.net/valorant/images/1/1f/VCT26_x_BLG_Card_Large.png/revision/latest?cb=20260106172255',type:'png'}
],
'2025':[
  {label:'Ïï†ÎãàÎ©îÏù¥ÏÖò',img:'https://static.wikia.nocookie.net/valorant/images/f/fe/VCT25_x_BLG_Card_animated.gif/revision/latest?cb=20250125050918',type:'gif'},
  {label:'Small',img:'https://static.wikia.nocookie.net/valorant/images/1/15/VCT25_x_BLG_Card_Small.png/revision/latest?cb=20250107192917',type:'png'},
  {label:'Wide',img:'https://static.wikia.nocookie.net/valorant/images/a/a7/VCT25_x_BLG_Card_Wide.png/revision/latest?cb=20250107193107',type:'png'},
  {label:'Large',img:'https://static.wikia.nocookie.net/valorant/images/b/bd/VCT25_x_BLG_Card_Large.png/revision/latest?cb=20250107193011',type:'png'}
],
'2024':[
  {label:'Large',img:'https://static.wikia.nocookie.net/valorant/images/7/79/VCT_x_BLG_Card_Large.png/revision/latest?cb=20240514190744',type:'png'}
]
};
// Classic skin variants by year
const CLASSIC_VARIANTS={
'2026':{img:'https://media.valorant-api.com/bundles/b8d4f311-4928-a160-cb43-329f7dd9cdbb/displayicon.png'},
'2025':{img:'https://media.valorant-api.com/bundles/da157e17-4a4f-3620-6122-2b8c7850c1b4/displayicon.png'},
'2024':{img:'https://media.valorant-api.com/bundles/440c7d5d-4581-8a56-4966-d98385dd50f0/displayicon.png'}
};
// Level data per year (populated by fetchValApiSkins)
const CLASSIC_LEVELS={};
function openClassicPopup(year){
  const overlay=document.getElementById('vodOverlay');
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  const matchLabel=document.getElementById('vodMatchLabel');
  const ytLink=document.getElementById('vodYtLink');
  const biliLink=document.getElementById('vodBiliLink');
  title.textContent=`VCT${year==='2024'?'':year.substring(2)} x BLG Classic`;
  ytLink.style.display='none';biliLink.style.display='none';
  const existing=document.getElementById('biliParts');if(existing)existing.remove();
  const levels=CLASSIC_LEVELS[year]||[];
  const cv=CLASSIC_VARIANTS[year];
  if(!levels.length&&cv){
    // Fallback: no level data yet, show image only
    matchLabel.textContent='Ïù¥ÎØ∏ÏßÄ';
    body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#0a0a12;padding:16px;box-sizing:border-box"><img id="classicPreview" src="${pImg(cv.img)}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px"></div>`;
    overlay.classList.add('active');document.body.style.overflow='hidden';
    return;
  }
  // Determine which levels to show: 2024=0,1,2  2025+=1,2
  const startLv=year==='2024'?0:1;
  const showLevels=levels.filter(l=>l.lv>=startLv);
  if(!showLevels.length&&cv){
    matchLabel.textContent='Ïù¥ÎØ∏ÏßÄ';
    body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#0a0a12;padding:16px;box-sizing:border-box"><img id="classicPreview" src="${pImg(cv.img)}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px"></div>`;
    overlay.classList.add('active');document.body.style.overflow='hidden';
    return;
  }
  const first=showLevels[0];
  matchLabel.textContent=`Î†àÎ≤® ${startLv}~${showLevels[showLevels.length-1].lv}`;
  // Show video if available, else image
  if(first.video){
    body.innerHTML=`<video id="classicPreview" src="${first.video}" autoplay loop playsinline controls style="width:100%;height:100%;object-fit:contain;background:#0a0a12"></video>`;
  }else{
    body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#0a0a12;padding:16px;box-sizing:border-box"><img id="classicPreview" src="${first.icon}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px"></div>`;
  }
  overlay.classList.add('active');document.body.style.overflow='hidden';
  // Level switcher buttons
  let h=`<div class="bili-parts" id="biliParts"><div class="bili-parts-label">üî´ Ïä§ÌÇ® Î†àÎ≤®</div><div class="bili-parts-list">`;
  showLevels.forEach((lv,i)=>{
    const active=i===0?'active':'';
    const lvLabel=lv.lv===0?'Í∏∞Î≥∏':lv.type||`Lv${lv.lv}`;
    h+=`<button class="bili-part-btn ${active}" onclick="switchClassicLevel(${i},'${year}')">Lv${lv.lv} ${lvLabel}${lv.video?' üé¨':''}</button>`;
  });
  h+=`</div></div>`;
  body.parentElement.insertBefore(createEl(h),body.nextSibling);
}
function switchClassicLevel(idx,year){
  const startLv=year==='2024'?0:1;
  const levels=(CLASSIC_LEVELS[year]||[]).filter(l=>l.lv>=startLv);
  const lv=levels[idx];if(!lv)return;
  const body=document.getElementById('vodBody');
  if(lv.video){
    body.innerHTML=`<video id="classicPreview" src="${lv.video}" autoplay loop playsinline controls style="width:100%;height:100%;object-fit:contain;background:#0a0a12"></video>`;
  }else{
    body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#0a0a12;padding:16px;box-sizing:border-box"><img id="classicPreview" src="${lv.icon}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px"></div>`;
  }
  document.querySelectorAll('.bili-part-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.bili-part-btn')[idx]?.classList.add('active');
}
function openCardPopup(year){
  const variants=CARD_VARIANTS[year];if(!variants||!variants.length)return;
  const overlay=document.getElementById('vodOverlay');
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  const matchLabel=document.getElementById('vodMatchLabel');
  const ytLink=document.getElementById('vodYtLink');
  const biliLink=document.getElementById('vodBiliLink');
  title.textContent=`VCT${year.substring(2)} x BLG ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú`;
  matchLabel.textContent=`${variants.length}Í∞ú Î≤ÑÏ†Ñ`;
  ytLink.style.display='none';biliLink.style.display='none';
  // Remove any existing part selector
  const existing=document.getElementById('biliParts');if(existing)existing.remove();
  // Show first variant (animated if available)
  const first=variants[0];
  body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#0a0a12;padding:16px;box-sizing:border-box"><img id="cardPreview" src="${pImg(first.img)}" alt="${first.label}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px"></div>`;
  overlay.classList.add('active');document.body.style.overflow='hidden';
  // Add variant buttons if >1
  if(variants.length>1){
    let h=`<div class="bili-parts" id="biliParts"><div class="bili-parts-label">üÉè Ïπ¥Îìú Î≤ÑÏ†Ñ</div><div class="bili-parts-list">`;
    variants.forEach((v,i)=>{
      const pUrl=pImg(v.img);
      h+=`<button class="bili-part-btn ${i===0?'active':''}" onclick="document.getElementById('cardPreview').src='${pUrl}';document.querySelectorAll('.bili-part-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active')">${v.label}${v.type==='gif'?' üé¨':''}</button>`;
    });
    h+=`</div></div>`;
    body.parentElement.insertBefore(createEl(h),body.nextSibling);
  }
}

const STATIC_SKINS=[
{year:'2026',name:'VCT26 x BLG ÌÅ¥ÎûòÏãù',
img:'https://media.valorant-api.com/bundles/b8d4f311-4928-a160-cb43-329f7dd9cdbb/displayicon.png',
bundleImg:'https://media.valorant-api.com/bundles/b8d4f311-4928-a160-cb43-329f7dd9cdbb/displayicon.png',
items:[
{label:'üî´ Classic Ïä§ÌÇ®',img:'https://media.valorant-api.com/bundles/b8d4f311-4928-a160-cb43-329f7dd9cdbb/displayicon.png'},
{label:'üÉè ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú',img:'https://media.valorant-api.com/bundles/b8d4f311-4928-a160-cb43-329f7dd9cdbb/displayicon.png'},
{label:'üí® Ïä§ÌîÑÎ†àÏù¥',img:'https://media.valorant-api.com/sprays/6e864615-4018-d187-9c77-4faef06cd752/fulltransparenticon.png'},
{label:'üîó Í±¥ Î≤ÑÎîî',img:'https://media.valorant-api.com/buddies/2dc4e4c0-491e-43c8-f51b-f69f6ff16e37/displayicon.png'}
],link:'https://valorant.fandom.com/wiki/VCT_x_BLG_Capsule'},
{year:'2025',name:'VCT25 x BLG ÌÅ¥ÎûòÏãù',
img:'https://media.valorant-api.com/bundles/da157e17-4a4f-3620-6122-2b8c7850c1b4/displayicon.png',
bundleImg:'https://media.valorant-api.com/bundles/da157e17-4a4f-3620-6122-2b8c7850c1b4/displayicon.png',
items:[
{label:'üî´ Classic Ïä§ÌÇ®',img:'https://media.valorant-api.com/bundles/da157e17-4a4f-3620-6122-2b8c7850c1b4/displayicon.png'},
{label:'üÉè ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú',img:'https://media.valorant-api.com/bundles/da157e17-4a4f-3620-6122-2b8c7850c1b4/displayicon.png'},
{label:'üí® Ïä§ÌîÑÎ†àÏù¥',img:'https://media.valorant-api.com/sprays/6e864615-4018-d187-9c77-4faef06cd752/fulltransparenticon.png'},
{label:'üîó Í±¥ Î≤ÑÎîî',img:'https://media.valorant-api.com/buddies/2dc4e4c0-491e-43c8-f51b-f69f6ff16e37/displayicon.png'}
],link:'https://valorant.fandom.com/wiki/VCT_x_BLG_Capsule'},
{year:'2024',name:'VCT x BLG ÌÅ¥ÎûòÏãù',
img:'https://media.valorant-api.com/bundles/440c7d5d-4581-8a56-4966-d98385dd50f0/displayicon.png',
bundleImg:'https://media.valorant-api.com/bundles/440c7d5d-4581-8a56-4966-d98385dd50f0/displayicon.png',
items:[
{label:'üî´ Classic Ïä§ÌÇ®',img:'https://media.valorant-api.com/bundles/440c7d5d-4581-8a56-4966-d98385dd50f0/displayicon.png'},
{label:'üîó Í±¥ Î≤ÑÎîî',img:'https://media.valorant-api.com/buddies/2dc4e4c0-491e-43c8-f51b-f69f6ff16e37/displayicon.png'}
],link:'https://valorant.fandom.com/wiki/VCT_x_BLG_Capsule'}
];

async function fetchSkinData(){
  blgSkinData=[...STATIC_SKINS]; // fallback
  skinSyncStatus='static';
  renderSkins();

  // Auto-detect new skins from Fandom Wiki API
  try{
    const FANDOM='https://valorant.fandom.com/api.php';
    const urlMap={};
    const tsMap={}; // filename‚Üítimestamp for release date

    // Method 1: Get images from VCT_x_BLG_Capsule page
    const pgData=await proxyFetchJSON(`${FANDOM}?action=query&titles=VCT_x_BLG_Capsule&prop=images&imlimit=100&format=json`);
    let blgImgs=[];
    if(pgData?.query?.pages){
      const pages=Object.values(pgData.query.pages);
      if(pages[0]?.images) blgImgs=pages[0].images.map(i=>i.title).filter(t=>t.includes('BLG'));
    }

    // Method 2: Also search allimages for VCT*BLG (catches future skins not yet on the page)
    await new Promise(r=>setTimeout(r,500));
    const curYr=String(new Date().getFullYear()).substring(2); // "26","27"...
    const prefixes=['VCT_x_BLG','VCT'+curYr+'_x_BLG','Bundle_VCT'+curYr+'_x_BLG'];
    for(const pfx of prefixes){
      const aiData=await proxyFetchJSON(`${FANDOM}?action=query&list=allimages&aiprefix=${encodeURIComponent(pfx)}&ailimit=20&format=json`);
      if(aiData?.query?.allimages){
        aiData.query.allimages.forEach(img=>{
          const title='File:'+img.name;
          if(title.includes('BLG')&&!blgImgs.includes(title)){blgImgs.push(title);urlMap[img.name]=img.url;}
          if(img.timestamp)tsMap[img.name]=img.timestamp;
        });
      }
      await new Promise(r=>setTimeout(r,300));
    }
    // Also check next year
    const nextYr=String(Number(curYr)+1);
    const aiNext=await proxyFetchJSON(`${FANDOM}?action=query&list=allimages&aiprefix=VCT${nextYr}_x_BLG&ailimit=20&format=json`);
    if(aiNext?.query?.allimages){
      aiNext.query.allimages.forEach(img=>{
        const title='File:'+img.name;
        if(!blgImgs.includes(title)){blgImgs.push(title);urlMap[img.name]=img.url;}
          if(img.timestamp)tsMap[img.name]=img.timestamp;
      });
    }

    if(!blgImgs.length)return;

    // Get actual URLs for page-sourced images (allimages already have URLs)
    const needUrls=blgImgs.filter(t=>{const fn=t.replace('File:','');return!urlMap[fn]});
    for(let i=0;i<needUrls.length;i+=50){
      const batch=needUrls.slice(i,i+50).join('|');
      await new Promise(r=>setTimeout(r,500));
      const imgData=await proxyFetchJSON(`${FANDOM}?action=query&titles=${encodeURIComponent(batch)}&prop=imageinfo&iiprop=url|timestamp&format=json`);
      if(!imgData?.query?.pages)continue;
      Object.values(imgData.query.pages).forEach(p=>{
        if(p.imageinfo&&p.imageinfo[0]?.url){
          const fn=p.title.replace('File:','');
          urlMap[fn]=p.imageinfo[0].url;
          if(p.imageinfo[0].timestamp)tsMap[fn]=p.imageinfo[0].timestamp;
        }
      });
    }

    console.log(`üì° Fandom Wiki: ${Object.keys(urlMap).length}Í∞ú BLG Ïù¥ÎØ∏ÏßÄ Î∞úÍ≤¨`);

    // Group by year
    const yearGroups={};
    const existingYears=new Set(STATIC_SKINS.map(s=>s.year));

    Object.entries(urlMap).forEach(([fname,url])=>{
      let year=null;
      const yrMatch=fname.match(/VCT(\d{2})_x_BLG/i);
      if(yrMatch) year='20'+yrMatch[1];
      else if(fname.match(/^(VCT|Bundle_VCT)_x_BLG/i)) year='2024';
      if(!year)return;

      if(!yearGroups[year])yearGroups[year]={classic:null,bundle:null,card:null,cards:[],spray:null,buddy:null,banner:null,earliest:null};
      const fl=fname.toLowerCase();
      // Track earliest upload timestamp per year
      const ts=tsMap[fname];
      if(ts&&(!yearGroups[year].earliest||ts<yearGroups[year].earliest))yearGroups[year].earliest=ts;
      if(fl.includes('bundle'))yearGroups[year].bundle=url;
      else if(fl.includes('card')){
        // Collect all card variants
        if(fl.includes('animated'))yearGroups[year].cards.push({label:'Ïï†ÎãàÎ©îÏù¥ÏÖò',img:url,type:'gif'});
        else if(fl.includes('small'))yearGroups[year].cards.push({label:'Small',img:url,type:'png'});
        else if(fl.includes('wide'))yearGroups[year].cards.push({label:'Wide',img:url,type:'png'});
        else if(fl.includes('large')){yearGroups[year].cards.push({label:'Large',img:url,type:'png'});yearGroups[year].card=url;}
        else yearGroups[year].card=url;
        if(!yearGroups[year].card)yearGroups[year].card=url;
      }
      else if(fl.includes('spray'))yearGroups[year].spray=url;
      else if(fl.includes('buddy'))yearGroups[year].buddy=url;
      else if(fl.includes('banner'))yearGroups[year].banner=url;
      else if(fl.includes('classic'))yearGroups[year].classic=url;
    });

    // Build new entries for years not in STATIC_SKINS
    let newCount=0;
    Object.entries(yearGroups).forEach(([yr,imgs])=>{
      if(existingYears.has(yr))return;
      if(!imgs.classic)return;

      const prefix=yr==='2024'?'VCT':'VCT'+yr.substring(2);
      const entry={
        year:yr,
        name:`${prefix} x BLG ÌÅ¥ÎûòÏãù`,
        img:imgs.classic,
        bundleImg:imgs.bundle||imgs.classic,
        items:[{label:'üî´ Classic Ïä§ÌÇ®',img:imgs.classic}],
        link:'https://valorant.fandom.com/wiki/VCT_x_BLG_Capsule',
        _auto:true
      };
      if(imgs.card)entry.items.push({label:'üÉè ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú',img:imgs.card});
      if(imgs.spray)entry.items.push({label:'üí® Ïä§ÌîÑÎ†àÏù¥',img:imgs.spray});
      if(imgs.buddy)entry.items.push({label:'üîó Í±¥ Î≤ÑÎîî',img:imgs.buddy});
      if(imgs.banner)entry.items.push({label:'üè≥Ô∏è Î∞∞ÎÑà',img:imgs.banner});

      blgSkinData.push(entry);
      // Auto-populate SKIN_META with detected date
      if(imgs.earliest&&!SKIN_META[yr]){
        SKIN_META[yr]={price:'2,320 VP',priceDiscount:'1,650 VP (Ïû¨Íµ¨Îß§)',contents:entry.items.map(i=>i.label.replace(/^.\s*/,'')),cnRank:'TBD',added:imgs.earliest.substring(0,10)};
      }
      newCount++;
      console.log(`‚úÖ Ïã†Í∑ú Ïä§ÌÇ® ÏûêÎèô Í∞êÏßÄ: ${yr} (${entry.items.length}Í∞ú ÏïÑÏù¥ÌÖú)`);
    });

    // Update existing entries with fresh URLs
    blgSkinData.forEach(s=>{
      const g=yearGroups[s.year];
      if(!g)return;
      if(g.classic)s.img=g.classic;
      if(g.bundle)s.bundleImg=g.bundle;
      // Update SKIN_META added date from Fandom timestamp (only if no manual date exists)
      if(g.earliest&&!SKIN_META[s.year])SKIN_META[s.year]={price:'2,320 VP',priceDiscount:'1,650 VP (Ïû¨Íµ¨Îß§)',contents:s.items.map(i=>i.label.replace(/^.\s*/,'')),cnRank:'TBD',added:g.earliest.substring(0,10)};
      // Update item URLs too
      s.items.forEach(item=>{
        const ll=item.label.toLowerCase();
        if(ll.includes('classic')&&g.classic)item.img=g.classic;
        else if(ll.includes('Ïπ¥Îìú')&&g.card)item.img=g.card;
        else if(ll.includes('Ïä§ÌîÑÎ†àÏù¥')&&g.spray)item.img=g.spray;
        else if(ll.includes('Î≤ÑÎîî')&&g.buddy)item.img=g.buddy;
      });
    });

    skinSyncStatus=newCount>0?'auto':'synced';

    // Auto-populate CARD_VARIANTS from detected card images
    Object.entries(yearGroups).forEach(([yr,g])=>{
      if(!g.cards||!g.cards.length)return;
      // Sort: animated first, then Small, Wide, Large
      const order={'Ïï†ÎãàÎ©îÏù¥ÏÖò':0,'Small':1,'Wide':2,'Large':3};
      g.cards.sort((a,b)=>(order[a.label]??9)-(order[b.label]??9));
      if(!CARD_VARIANTS[yr]||g.cards.length>CARD_VARIANTS[yr].length){
        CARD_VARIANTS[yr]=g.cards;
        console.log(`üÉè Ïπ¥Îìú Î≥ÄÌòï ÏûêÎèô Í∞êÏßÄ: ${yr} (${g.cards.length}Ï¢Ö)`);
      }
    });

    // Auto-populate CLASSIC_VARIANTS from detected classic images
    Object.entries(yearGroups).forEach(([yr,g])=>{
      if(g.classic&&!CLASSIC_VARIANTS[yr]){
        CLASSIC_VARIANTS[yr]={img:g.classic};
        console.log(`üî´ ÌÅ¥ÎûòÏãù Ïä§ÌÇ® ÏûêÎèô Í∞êÏßÄ: ${yr}`);
      }
    });

    renderSkins();
  }catch(e){console.log('Skin auto-detect failed:',e.message)}
}

function toggleSkinCard(id){const card=document.getElementById(id);if(!card)return;const wasOpen=card.classList.contains('open');document.querySelectorAll('.skin-card.open').forEach(c=>{if(c.id!==id)c.classList.remove('open')});card.classList.toggle('open')}

function renderSkins(){const wrap=document.getElementById('skinsWrap');
const sorted=[...blgSkinData].sort((a,b)=>parseInt(b.year)-parseInt(a.year));
const maxYear=sorted.length?parseInt(sorted[0].year):0;
let syncHTML='';
if(skinSyncStatus==='auto')syncHTML=`<div class="skins-sync"><span class="ss-dot done" style="background:var(--cyan)"></span>${blgSkinData.length}Í∞ú Ï∫°Ïäê ¬∑ üì° Fandom Wiki ÏûêÎèô Í∞êÏßÄ</div>`;
else if(skinSyncStatus==='synced')syncHTML=`<div class="skins-sync"><span class="ss-dot done"></span>${blgSkinData.length}Í∞ú Ï∫°Ïäê ¬∑ Fandom Wiki ‚úì</div>`;
else if(skinSyncStatus==='static')syncHTML=`<div class="skins-sync"><span class="ss-dot done"></span>${blgSkinData.length}Í∞ú Ï∫°Ïäê ¬∑ Fandom Wiki</div>`;
else syncHTML='';

let h=`<div class="skins-title">BLG TEAM CLASSIC SKINS</div><div class="skins-sub">Îß§ÎÖÑ Î∞úÎß§ÎêòÎäî VCT ÌåÄ Ï∫°Ïäê ‚Äî Classic Ïä§ÌÇ® Ïª¨Î†âÏÖò</div>${syncHTML}<div class="skins-grid">`;
sorted.forEach(s=>{
const isCurrent=parseInt(s.year)===maxYear;
const cid='skincard_'+s.year;
const meta=getSkinMeta(s.year);
h+=`<div class="skin-card ${isCurrent?'latest':''}" id="${cid}">
<div class="skin-header" onclick="toggleSkinCard('${cid}')">
<div class="skin-year">${s.year}</div>
<div class="skin-hright">
<span class="skin-badge ${isCurrent?'current':'past'}">${isCurrent?'ON SALE':'ARCHIVED'}</span>
<span class="skin-arrow">‚ñº</span>
</div></div>
<div class="skin-preview">
<div class="skin-img-wrap"><img src="${pImg(s.bundleImg||s.img)}" alt="${s.name}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=item-placeholder>Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</div>'"></div>
<div class="skin-info">
<div class="skin-name">${s.name}</div>
<div class="skin-detail">${meta.contents.map(c=>'¬∑ '+c).join('<br>')}</div>
<div class="skin-tags">
<span class="sk-tag price">üí∞ ${meta.price}</span>
${meta.priceDiscount?`<span class="sk-tag price">üîÅ ${meta.priceDiscount}</span>`:''}
${meta.cnRank?`<span class="sk-tag rank">üèÜ ${meta.cnRank}</span>`:''}
<span class="sk-tag contents">üìÖ ${meta.added}</span>
</div></div></div>
<div class="skin-expand"><div class="skin-detail-inner">
<div class="item-label">üì¶ Ï∫°Ïäê Íµ¨ÏÑ±Ìíà</div>
<div class="items-grid">${s.items.map(it=>{
const isCard=it.label.includes('Ïπ¥Îìú');
const isClassic=it.label.includes('Classic')||it.label.includes('ÌÅ¥ÎûòÏãù');
const cardClick=isCard&&CARD_VARIANTS[s.year]?` onclick="openCardPopup('${s.year}')" style="cursor:pointer" title="ÌÅ¥Î¶≠ÌïòÎ©¥ Ïπ¥Îìú Î≤ÑÏ†Ñ Î≥¥Í∏∞"`:'';
const classicClick=isClassic&&CLASSIC_VARIANTS[s.year]?` onclick="openClassicPopup('${s.year}')" style="cursor:pointer" title="ÌÅ¥Î¶≠ÌïòÎ©¥ Ïä§ÌÇ® Î†àÎ≤® Î≥¥Í∏∞"`:'';
const cellClick=cardClick||classicClick;
const badge=isCard&&CARD_VARIANTS[s.year]?' üîç':isClassic&&CLASSIC_VARIANTS[s.year]?' üîç':'';
return`<div class="item-cell"${cellClick}>
<div class="item-img-box"><img src="${pImg(it.img)}" alt="${it.label}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=item-placeholder>Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</div>'"></div>
<div class="item-name">${it.label}${badge}</div></div>`}).join('')}</div>
<a href="${s.link}" target="_blank" class="skin-link">üîó Valorant WikiÏóêÏÑú ÏûêÏÑ∏Ìûà Î≥¥Í∏∞ ‚Üí</a>
</div></div></div>`;
});
h+='</div>';wrap.innerHTML=h}

// ===== LIVE FETCH =====
async function fetchLiveData(){const dot=document.getElementById('liveDot'),txt=document.getElementById('liveText'),btn=document.getElementById('refreshBtn'),ico=document.getElementById('refreshIcon');dot.className='live-dot loading';txt.textContent='ÏµúÏã† Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏÉâ Ï§ë...';btn.disabled=true;ico.innerHTML='<span class="spin-i">‚Üª</span>';
let syncCount=0;
// 0) Try Riot Esports API (official data!)
try{
  const events=await getRiotSchedule(true);
  const blgMatches=events.filter(ev=>ev.state==='completed'&&ev.match?.teams?.some(t=>isBLGTeam(t)));
  blgMatches.forEach(ev=>{
    const teams=ev.match.teams;
    const isBLG0=isBLGTeam(teams[0]);
    const blgTeam=isBLG0?teams[0]:teams[1];
    const oppTeam=isBLG0?teams[1]:teams[0];
    const bs=blgTeam.result?.gameWins||0;
    const os=oppTeam.result?.gameWins||0;
    const date=ev.startTime?.substring(0,10)||'';
    const yr=date.substring(0,4);
    if(!yr)return;
    const oppTag=oppTeam.code?guessTag(oppTeam.code):guessTag(oppTeam.name);
    const tn=`VCT 2025: China ${ev.tournament?.split?.name||'Stage 1'}`;
    if(!allData[yr])allData[yr]=[];
    let tg=allData[yr].find(t=>t.tournament.includes('China')&&t.tournament.includes(yr.substring(2)));
    if(!tg){tg={tournament:tn,intl:false,matches:[]};allData[yr].unshift(tg)}
    const ex=tg.matches.some(x=>x.date===date&&x.tag===oppTag)||
      Object.values(allData).flat().some(t=>t.matches.some(x=>x.date===date&&(x.tag===oppTag||x.opp===oppTeam.name||x.opp.includes(oppTeam.name?.split(' ')[0]||'???'))));
    if(!ex){tg.matches.push({date,opp:oppTeam.name,tag:oppTag,stage:ev.blockName||'',fmt:`Bo${ev.match.strategy?.count||3}`,bs,os,r:bs>os?'win':'loss',maps:[]});syncCount++}
  });
}catch(e){}
// 1) Try vlresports for recent results
try{
  const d=await proxyFetchJSON('https://vlr.orlandomm.net/api/v1/results');
  if(d&&Array.isArray(d.data)){
    d.data.forEach(m=>{
      if(!m.teams||m.teams.length<2)return;
      const t1=(m.teams[0].name||'').toLowerCase(),t2=(m.teams[1].name||'').toLowerCase();
      if(t1.includes('bilibili')||t1.includes('blg')||t2.includes('bilibili')||t2.includes('blg')){
        const isBLG1=t1.includes('bilibili')||t1.includes('blg');
        const opp=isBLG1?m.teams[1].name:m.teams[0].name;const oppTag=guessTag(opp);
        const bs=parseInt(isBLG1?m.teams[0].score:m.teams[1].score)||0;
        const os=parseInt(isBLG1?m.teams[1].score:m.teams[0].score)||0;
        const yr=m.createdAt?m.createdAt.substring(0,4):String(new Date().getFullYear());
        const tn=m.event?.name||'VCT';
        if(!allData[yr])allData[yr]=[];
        let tg=allData[yr].find(t=>t.tournament===tn);
        if(!tg){tg={tournament:tn,intl:false,matches:[]};allData[yr].unshift(tg)}
        const dt=m.createdAt?m.createdAt.substring(0,10):'';
        const ex=tg.matches.some(x=>x.date===dt&&x.tag===oppTag)||
          Object.values(allData).flat().some(t=>t.matches.some(x=>x.date===dt&&(x.tag===oppTag||x.opp===opp)));
        if(!ex){tg.matches.push({date:dt,opp,tag:oppTag,stage:'',fmt:'Bo3',bs,os,r:bs>os?'win':'loss',maps:[]});syncCount++}
      }
    });
  }
}catch(e){}
dot.className='live-dot';txt.textContent=`ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${new Date().toLocaleTimeString('ko-KR')} ¬∑ ${syncCount>0?syncCount+'Í∞ú ÎèôÍ∏∞Ìôî':'Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©'}`;preloadAgents();restoreVlrSync();renderAll();
btn.disabled=false;ico.innerHTML='‚Üª'}

preloadAgents();
restoreVlrSync();
restoreVodCache();
renderAll();
fetchLiveData().then(()=>setInterval(fetchLiveData,5*60*1000));
fetchSkinData();

// Valorant-API.comÏóêÏÑú BLG Ïä§ÌÇ®/Î≤ÑÎîî/Ïä§ÌîÑÎ†àÏù¥ displayIcon Í∞ÄÏ†∏Ïò§Í∏∞ (CORS OK, ÌîÑÎ°ùÏãú Î∂àÌïÑÏöî)
// === Valorant API Ïä§ÌÇ® Îç∞Ïù¥ÌÑ∞ (localStorage Ï∫êÏãú) ===
const VAL_API_CACHE_KEY='blg_val_api_cache';
function applyValApiCache(cache){
  // Classic skins + levels
  if(cache.skins){
    Object.entries(cache.skins).forEach(([year,data])=>{
      CLASSIC_VARIANTS[year]={img:data.icon};
      if(data.levels)CLASSIC_LEVELS[year]=data.levels;
      blgSkinData.forEach(s=>{
        if(s.year!==year)return;
        s.items.forEach(it=>{if(it.label.includes('Classic')||it.label.includes('ÌÅ¥ÎûòÏãù'))it.img=data.icon});
      });
    });
  }
  // Cards
  if(cache.cards){
    Object.entries(cache.cards).forEach(([year,variants])=>{
      CARD_VARIANTS[year]=variants;
      const mainImg=variants.find(v=>v.label==='Large')?.img||variants[0]?.img;
      if(mainImg)blgSkinData.forEach(s=>{
        if(s.year!==year)return;
        s.items.forEach(it=>{if(it.label.includes('Ïπ¥Îìú'))it.img=mainImg});
      });
    });
  }
  // Sprays
  if(cache.sprays){
    Object.entries(cache.sprays).forEach(([year,icon])=>{
      blgSkinData.forEach(s=>{
        if(s.year!==year)return;
        s.items.forEach(it=>{if(it.label.includes('Ïä§ÌîÑÎ†àÏù¥'))it.img=icon});
      });
    });
  }
  // Bundles
  if(cache.bundles){
    Object.entries(cache.bundles).forEach(([year,icon])=>{
      blgSkinData.forEach(s=>{if(s.year===year)s.bundleImg=icon});
    });
  }
  renderSkins();
}
// Load from cache immediately
try{
  const cached=JSON.parse(localStorage.getItem(VAL_API_CACHE_KEY));
  if(cached){
    applyValApiCache(cached);
    console.log('üíæ Valorant API Ï∫êÏãú Î°úÎìú:',Object.keys(cached.skins||{}).length,'Ïä§ÌÇ®,',Object.keys(cached.cards||{}).length,'Ïπ¥Îìú');
  }
}catch(e){}
async function fetchValApiSkins(){
  const newCache={skins:{},cards:{},sprays:{},bundles:{}};
  try{
    // Fetch skins
    const r=await fetch('https://valorant-api.com/v1/weapons/skins');
    const d=await r.json();
    if(!d?.data)return;
    const blgSkins=d.data.filter(s=>{
      const n=(s.displayName||'').toLowerCase();
      return n.includes('blg')||n.includes('bilibili');
    });
    console.log(`üî´ Valorant API: ${blgSkins.length}Í∞ú BLG Ïä§ÌÇ® Î∞úÍ≤¨:`,blgSkins.map(s=>s.displayName));
    blgSkins.forEach(skin=>{
      let year=null;
      const yrM=skin.displayName.match(/VCT\s*(\d{2,4})\s*x\s*BLG/i);
      if(yrM){const y=yrM[1];year=y.length===4?y:'20'+y;}
      else if(/VCT\s*x\s*BLG/i.test(skin.displayName))year='2024';
      if(!year)return;
      const icon=skin.levels?.[0]?.displayIcon||skin.displayIcon;
      if(!icon)return;
      CLASSIC_VARIANTS[year]={img:icon};
      const levels=skin.levels?skin.levels.map((l,i)=>{
        let type='';
        if(l.levelItem){
          const t=l.levelItem.split('::')[1]||'';
          if(t==='SoundEffects')type='ÏÇ¨Ïö¥Îìú';
          else if(t==='KillBanner')type='ÌÇ¨Î∞∞ÎÑà';
          else if(t==='Animation')type='Ïï†ÎãàÎ©îÏù¥ÏÖò';
          else type=t;
        }
        return{lv:i,icon:l.displayIcon||icon,video:l.streamedVideo||null,type};
      }):[];
      if(levels.length)CLASSIC_LEVELS[year]=levels;
      newCache.skins[year]={icon,levels};
      blgSkinData.forEach(s=>{
        if(s.year!==year)return;
        s.items.forEach(it=>{if(it.label.includes('Classic')||it.label.includes('ÌÅ¥ÎûòÏãù'))it.img=icon});
      });
    });
    // Fetch cards
    await new Promise(r=>setTimeout(r,300));
    const cr=await fetch('https://valorant-api.com/v1/playercards');
    const cd=await cr.json();
    if(cd?.data){
      const blgCards=cd.data.filter(c=>(c.displayName||'').toLowerCase().includes('blg'));
      console.log(`üÉè Valorant API: ${blgCards.length}Í∞ú BLG Ïπ¥Îìú Î∞úÍ≤¨`);
      blgCards.forEach(card=>{
        let year=null;
        const yrM=card.displayName.match(/VCT\s*(\d{2,4})\s*x\s*BLG/i);
        if(yrM){const y=yrM[1];year=y.length===4?y:'20'+y;}
        else if(/VCT\s*x\s*BLG/i.test(card.displayName))year='2024';
        if(!year)return;
        const variants=[];
        if(card.animationGif)variants.push({label:'Ïï†ÎãàÎ©îÏù¥ÏÖò',img:card.animationGif,type:'gif'});
        if(card.smallArt)variants.push({label:'Small',img:card.smallArt,type:'png'});
        if(card.wideArt)variants.push({label:'Wide',img:card.wideArt,type:'png'});
        if(card.largeArt)variants.push({label:'Large',img:card.largeArt,type:'png'});
        if(variants.length){CARD_VARIANTS[year]=variants;newCache.cards[year]=variants;}
        const mainImg=card.largeArt||card.displayIcon;
        if(mainImg)blgSkinData.forEach(s=>{
          if(s.year!==year)return;
          s.items.forEach(it=>{if(it.label.includes('Ïπ¥Îìú'))it.img=mainImg});
        });
      });
    }
    // Fetch sprays
    await new Promise(r=>setTimeout(r,300));
    const sr=await fetch('https://valorant-api.com/v1/sprays');
    const sd=await sr.json();
    if(sd?.data){
      const blgSprays=sd.data.filter(s=>(s.displayName||'').toLowerCase().includes('blg'));
      blgSprays.forEach(spray=>{
        let year=null;
        const yrM=spray.displayName.match(/VCT\s*(\d{2,4})\s*x\s*BLG/i);
        if(yrM){const y=yrM[1];year=y.length===4?y:'20'+y;}
        else if(/VCT\s*x\s*BLG/i.test(spray.displayName))year='2024';
        if(!year)return;
        const icon=spray.fullTransparentIcon||spray.displayIcon;
        if(icon){
          newCache.sprays[year]=icon;
          blgSkinData.forEach(s=>{
            if(s.year!==year)return;
            s.items.forEach(it=>{if(it.label.includes('Ïä§ÌîÑÎ†àÏù¥'))it.img=icon});
          });
        }
      });
    }
    // Fetch bundles
    await new Promise(r=>setTimeout(r,300));
    const br=await fetch('https://valorant-api.com/v1/bundles');
    const bd=await br.json();
    if(bd?.data){
      const BUNDLE_YEAR_MAP={
        '440c7d5d-4581-8a56-4966-d98385dd50f0':'2024',
        'da157e17-4a4f-3620-6122-2b8c7850c1b4':'2025',
        'b8d4f311-4928-a160-cb43-329f7dd9cdbb':'2026'
      };
      const blgBundles=bd.data.filter(b=>(b.displayName||'').toLowerCase().includes('blg'));
      console.log(`üì¶ Valorant API: ${blgBundles.length}Í∞ú BLG Î≤àÎì§ Î∞úÍ≤¨`);
      blgBundles.forEach(bundle=>{
        if(!bundle.displayIcon)return;
        let year=BUNDLE_YEAR_MAP[bundle.uuid];
        if(!year){
          const yrM=bundle.displayName.match(/VCT(\d{2})\s*x\s*BLG/i);
          if(yrM)year='20'+yrM[1];
          else{
            const maxYr=Math.max(...blgSkinData.map(s=>parseInt(s.year)||0));
            year=String(maxYr>0?maxYr+1:new Date().getFullYear());
          }
          console.log(`üì¶ ÏÉà BLG Î≤àÎì§ Í∞êÏßÄ: ${bundle.uuid} ‚Üí ${year}`);
        }
        newCache.bundles[year]=bundle.displayIcon;
        blgSkinData.forEach(s=>{if(s.year===year)s.bundleImg=bundle.displayIcon});
      });
    }
    // Save to localStorage
    try{localStorage.setItem(VAL_API_CACHE_KEY,JSON.stringify(newCache));
      console.log('üíæ Valorant API Ï∫êÏãú Ï†ÄÏû• ÏôÑÎ£å');
    }catch(e){}
    renderSkins();
    console.log('‚úÖ Valorant API Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
  }catch(e){console.log('Valorant API skin fetch failed:',e.message)}
}
setTimeout(fetchValApiSkins,5000); // Fandom sync ÌõÑÏóê Ïã§Ìñâ
// Live match detection: check every 60s (Riot Esports API)
checkLiveMatch();setInterval(checkLiveMatch,60000);
// Bilibili VOD auto-check: once at load + every 10min
setTimeout(checkNewBiliVods,5000);setInterval(checkNewBiliVods,10*60*1000);
// Roster: fetch once at load (with cache fallback)
setTimeout(fetchRoster,2000);
// Transfers: fetch from Liquipedia (delayed to respect rate limit)
setTimeout(fetchTransfers,8000);

// Standings: fetch at load + every 10min
setTimeout(fetchStandings,4000);setInterval(fetchStandings,10*60*1000);
// Upcoming schedule: fetch at load + every 10min
setTimeout(fetchUpcomingSchedule,6000);setInterval(fetchUpcomingSchedule,10*60*1000);

// === ÏûêÎèô ÌååÏù¥ÌîÑÎùºÏù∏: LP sync ‚Üí VLR agent sync ‚Üí VOD Îß§Ïπ≠ ===
setTimeout(async()=>{
  await liqAutoSync();
  setTimeout(fetchLiquipediaLogosDeferred,5000);
  // ÏûêÎèô VLR ÏóêÏù¥Ï†ÑÌä∏ ÎèôÍ∏∞Ìôî (LP sync ÌõÑ)
  setTimeout(autoVlrSync,3000);
},12000);
// VLR ÏûêÎèô ÎèôÍ∏∞Ìôî: 10Î∂ÑÎßàÎã§
setInterval(autoVlrSync,10*60*1000);

// === ÏûêÎèô VLR ÏóêÏù¥Ï†ÑÌä∏ ÎèôÍ∏∞Ìôî (Î¨¥Ïùå) ===
async function autoVlrSync(){
  try{
    const resp=await fetch('/api/vlr-sync?limit=15');
    if(!resp.ok)return;
    const json=await resp.json();
    if(!json.ok||!json.data)return;
    const vlrNew=json.data;
    const stored=JSON.parse(localStorage.getItem('vlr_sync_data')||'{}');
    const oldCount=Object.keys(stored).length;
    Object.assign(stored,vlrNew);
    localStorage.setItem('vlr_sync_data',JSON.stringify(stored));
    localStorage.setItem('vlr_sync_ts',json.ts);
    // Apply to match detail cache
    let newCnt=0;
    for(const[yr,tgs]of Object.entries(allData)){
      tgs.forEach((tg,ti)=>{
        tg.matches.forEach((m,mi)=>{
          const cacheKey=`${yr}_${ti}_${mi}`;
          const key=m.date+'_'+m.tag;
          const src=stored[key]||vlrNew[key];
          if(!src||!src.d||!src.d.length)return;
          const hasAgents=src.d.some(md=>(md.b&&md.b.length>0)||(md.o&&md.o.length>0));
          const existing=liqMatchDetailCache[cacheKey];
          const existingHasAgents=existing?.maps?.some(mp=>(mp.t1agents&&mp.t1agents.length>0)||(mp.t2agents&&mp.t2agents.length>0));
          if(existingHasAgents&&!hasAgents)return;
          liqMatchDetailCache[cacheKey]={
            blgSide:1,
            maps:src.d.map(md=>({mapName:md.m,t1agents:md.b||[],t2agents:md.o||[],score1:md.bs||0,score2:md.os||0}))
          };
          newCnt++;
        });
      });
    }
    const newDataCount=Object.keys(stored).length-oldCount;
    if(newCnt>0||newDataCount>0){
      renderAll();
      console.log(`ü§ñ VLR ÏûêÎèô ÎèôÍ∏∞Ìôî: ${newDataCount}Í∞ú Ïã†Í∑ú, ${newCnt}Í≤ΩÍ∏∞ Ï†ÅÏö©`);
      // Update sync badge
      const badge=document.getElementById('syncBadge');
      if(badge)badge.textContent=`VLR ${new Date().toLocaleTimeString('ko',{hour:'2-digit',minute:'2-digit'})}`;
    }
  }catch(e){}
}

// === ÏÉà Ïó∞ÎèÑ Ïä§ÌÇ® ÏûêÎèô Í∞êÏßÄ ===
function autoDetectNewSkinYears(){
  try{
    const cache=JSON.parse(localStorage.getItem(VAL_API_CACHE_KEY));
    if(!cache||!cache.skins)return;
    const existingYears=new Set(blgSkinData.map(s=>s.year));
    Object.keys(cache.skins).forEach(year=>{
      if(existingYears.has(year))return;
      // New year detected! Auto-add entry
      console.log(`üÜï ÏÉà Ïä§ÌÇ® Ïó∞ÎèÑ Í∞êÏßÄ: ${year} ‚Äî ÏûêÎèô Ï∂îÍ∞Ä`);
      const meta=getSkinMeta(year);
      const newEntry={
        year,
        name:`VCT${year.substring(2)} x BLG ÌÅ¥ÎûòÏãù`,
        img:cache.bundles?.[year]||cache.skins[year].icon||'',
        bundleImg:cache.bundles?.[year]||'',
        items:[
          {label:'üî´ Classic Ïä§ÌÇ®',img:cache.skins[year].icon||''},
          {label:'üÉè ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú',img:(cache.cards?.[year]&&cache.cards[year].length?cache.cards[year][cache.cards[year].length-1].img:'')},
          {label:'üí® Ïä§ÌîÑÎ†àÏù¥',img:cache.sprays?.[year]||''},
          {label:'üîó Í±¥ Î≤ÑÎîî',img:''}
        ]
      };
      blgSkinData.unshift(newEntry);
      renderSkins();
      showToast('üÜï ÏÉàÎ°úÏö¥ Ïä§ÌÇ®',`${year}ÎÖÑ BLG Ïä§ÌÇ®Ïù¥ ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
    });
  }catch(e){}
}
// fetchValApiSkins ÏôÑÎ£å ÌõÑ Ïã§Ìñâ
const _origFetchVal=fetchValApiSkins;
fetchValApiSkins=async function(){await _origFetchVal();autoDetectNewSkinYears();};
</script>

<!-- VOD MODAL -->
<div class="vod-overlay" id="vodOverlay" onclick="if(event.target===this)closeVod()">
  <div class="vod-modal">
    <div class="vod-modal-header">
      <div class="vod-modal-title"><span class="vod-icon">üì∫</span><span id="vodTitle">VOD</span></div>
      <button class="vod-close" onclick="closeVod()">‚úï</button>
    </div>
    <div class="vod-body" id="vodBody">
      <div class="vod-loading" id="vodLoading">
        <div class="vod-spinner"></div>
        <span>VOD Í≤ÄÏÉâ Ï§ë...</span>
      </div>
    </div>
    <div class="vod-match-info">
      <span class="vod-match-label" id="vodMatchLabel"></span>
      <div class="vod-links">
        <a href="#" target="_blank" class="vod-yt-link" id="vodYtLink" style="display:none">‚ñ∂ YouTube</a>
        <a href="#" target="_blank" class="vod-bili-link" id="vodBiliLink" style="display:none">‚ñ∂ Bilibili</a>
      </div>
    </div>
  </div>
</div>

<script>
// ===== VOD PLAYER (YouTube + Bilibili) =====
const vodCache={};
let currentVodPlatform='yt'; // 'yt' or 'bili'

function openVod(queryEnc, label, directBvid){
  const overlay=document.getElementById('vodOverlay');
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  const matchLabel=document.getElementById('vodMatchLabel');
  const ytLink=document.getElementById('vodYtLink');
  const biliLink=document.getElementById('vodBiliLink');

  title.textContent='VOD Í≤ÄÏÉâ Ï§ë...';
  matchLabel.textContent=label;
  ytLink.style.display='none';
  biliLink.style.display='none';
  body.innerHTML=`<div class="vod-loading"><div class="vod-spinner"></div><span>YouTube + BilibiliÏóêÏÑú VOD Í≤ÄÏÉâ Ï§ë...</span></div>`;
  overlay.classList.add('active');
  document.body.style.overflow='hidden';

  const query=decodeURIComponent(queryEnc);

  // If direct bilibili BV ID provided, show it immediately
  if(directBvid){
    const result={bvid:directBvid, biliTitle:label};
    // Still try to find YouTube via API, but show Bilibili immediately
    vodCache[query]=result;
    showVodResult(result, query);
    // Also search for YouTube in background
    searchVod(query).then(apiResult=>{
      if(apiResult && apiResult.videoId){
        result.videoId=apiResult.videoId;
        result.videoTitle=apiResult.videoTitle;
        vodCache[query]=result;
        const ytLink2=document.getElementById('vodYtLink');
        ytLink2.href=`https://www.youtube.com/watch?v=${result.videoId}`;
        ytLink2.style.display='flex';
      }
    }).catch(()=>{});
    return;
  }

  if(vodCache[query]){
    showVodResult(vodCache[query], query);
    return;
  }

  searchVod(query).then(result=>{
    if(result && (result.videoId || result.bvid)){
      vodCache[query]=result;
      showVodResult(result, query);
    } else {
      showVodFallback(query);
    }
  }).catch(()=>showVodFallback(query));
}

function showVodResult(result, query){
  const ytLink=document.getElementById('vodYtLink');
  const biliLink=document.getElementById('vodBiliLink');

  if(result.videoId){
    ytLink.href=`https://www.youtube.com/watch?v=${result.videoId}`;
    ytLink.style.display='flex';
  }
  if(result.bvid){
    biliLink.href=`https://www.bilibili.com/video/${result.bvid}`;
    biliLink.style.display='flex';
  }

  // Default: prefer Bilibili for VOD replays
  if(result.bvid){
    embedBilibili(result.bvid, result.biliTitle||query);
  } else if(result.videoId){
    embedYoutube(result.videoId, result.videoTitle||query);
  }
}

function embedYoutube(videoId, videoTitle){
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  currentVodPlatform='yt';
  title.textContent=videoTitle||'VOD';
  body.innerHTML=`<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" allow="autoplay; encrypted-media; picture-in-picture"></iframe>`;
}

function embedBilibili(bvid, biliTitle){
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  currentVodPlatform='bili';
  title.textContent=biliTitle||'VOD (Bilibili)';
  
  // First show player with p=1, then fetch part list
  body.innerHTML=`<iframe id="biliFrame" src="https://player.bilibili.com/player.html?bvid=${bvid}&page=1&autoplay=1&high_quality=1&quality=127&danmaku=0" allow="autoplay; fullscreen" scrolling="no" frameborder="0" style="width:100%;height:100%;border:0"></iframe>`;
  
  // Fetch video info to get part count
  fetchBiliParts(bvid);
}

async function fetchBiliParts(bvid){
  try{
    const d=await proxyFetchJSON(`https://api.bilibili.com/x/web-interface/view?bvid=${bvid}`);
    if(!d||!d.data||!d.data.pages||d.data.pages.length<=1)return;
    
    let pages=d.data.pages;
    const isMulti=multiPartBvids.has(bvid);
    let showPages=pages;
    
    // Multi-part (FGC ÏòàÏÑ†): BLG ÌååÌä∏Îßå ÌïÑÌÑ∞
    if(isMulti){
      showPages=pages.filter(p=>{
        const t=(p.part||'').toLowerCase();
        return t.includes('blg')||t.includes('bilibili')||t.includes('ÂìîÂì©ÂìîÂì©');
      });
      if(!showPages.length) showPages=pages;
      // Auto-switch to first BLG part
      if(showPages.length>0 && showPages[0].page!==1){
        const frame=document.getElementById('biliFrame');
        if(frame) frame.src=`https://player.bilibili.com/player.html?bvid=${bvid}&page=${showPages[0].page}&autoplay=1&high_quality=1&quality=127&danmaku=0`;
      }
    }
    
    const body=document.getElementById('vodBody');
    
    // Add part selector below the iframe
    let partHtml=`<div class="bili-parts" id="biliParts">`;
    partHtml+=`<div class="bili-parts-label">${isMulti?`üéÆ BLG Í≤ΩÍ∏∞ (${showPages.length}/${pages.length}ÌååÌä∏)`:`üìã ÌååÌä∏ ÏÑ†ÌÉù (${pages.length}Í∞ú)`}</div>`;
    partHtml+=`<div class="bili-parts-list">`;
    showPages.forEach((p,i)=>{
      const active=i===0?'active':'';
      const dur=p.duration?`${Math.floor(p.duration/60)}:${String(p.duration%60).padStart(2,'0')}`:'';
      partHtml+=`<button class="bili-part-btn ${active}" onclick="switchBiliPart('${bvid}',${p.page},this)" title="${p.part||''}">${p.part||`Part ${p.page}`}${dur?' ¬∑ '+dur:''}</button>`;
    });
    partHtml+=`</div>`;
    partHtml+=`<div style="display:flex;justify-content:center;padding:6px 0 0"><a href="https://www.bilibili.com/video/${bvid}" target="_blank" rel="noopener" style="font-size:11px;color:#00a1d6;text-decoration:none">üÖ± BÁ´ôÏóêÏÑú Ïó¥Í∏∞ (ÎåìÍ∏Ä/ÌÉÑÎßâ)</a></div>`;
    partHtml+=`</div>`;
    
    // Insert after vod-body (inside vod-modal, below the player)
    const existing=document.getElementById('biliParts');
    if(existing) existing.remove();
    body.parentElement.insertBefore(createEl(partHtml), body.nextSibling);
  }catch(e){}
}

function createEl(html){
  const div=document.createElement('div');
  div.innerHTML=html;
  return div.firstElementChild;
}

function switchBiliPart(bvid, page, btn){
  const frame=document.getElementById('biliFrame');
  if(frame) frame.src=`https://player.bilibili.com/player.html?bvid=${bvid}&page=${page}&autoplay=1&high_quality=1&quality=127&danmaku=0`;
  // Update active button
  document.querySelectorAll('.bili-part-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

function openSoopVod(date,tag){
  const vod=findSoopVod(tag,date);if(!vod)return;
  const overlay=document.getElementById('vodOverlay');
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  const matchLabel=document.getElementById('vodMatchLabel');
  const ytLink=document.getElementById('vodYtLink');
  const biliLink=document.getElementById('vodBiliLink');
  title.textContent='SOOP VOD';
  matchLabel.textContent=`BLG vs ${DT(tag)} ¬∑ ${date}`;
  ytLink.style.display='none';biliLink.style.display='none';
  overlay.classList.add('active');document.body.style.overflow='hidden';
  // Remove any existing part selector
  const existing=document.getElementById('biliParts');if(existing)existing.remove();
  if(vod.maps){
    // Multiple map VODs (e.g., DRX)
    body.innerHTML=`<iframe id="soopFrame" src="${vod.maps[0].url}" allow="autoplay; fullscreen" style="width:100%;height:100%;border:0"></iframe>`;
    let h=`<div class="bili-parts" id="biliParts"><div class="bili-parts-label">üü£ SOOP VOD (ÎßµÎ≥Ñ)</div><div class="bili-parts-list">`;
    vod.maps.forEach((m,i)=>{
      h+=`<button class="bili-part-btn ${i===0?'active':''}" onclick="document.getElementById('soopFrame').src='${m.url}';document.querySelectorAll('.bili-part-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active')" style="border-color:rgba(148,103,255,.3)">${m.label}</button>`;
    });
    h+=`</div><div style="display:flex;justify-content:center;padding:6px 0 0"><a href="${vod.maps[0].url}" target="_blank" rel="noopener" style="font-size:11px;color:#9467ff;text-decoration:none">üü£ SOOPÏóêÏÑú Ïó¥Í∏∞</a></div></div>`;
    body.parentElement.insertBefore(createEl(h),body.nextSibling);
  } else if(vod.url){
    // Single VOD with timestamps
    body.innerHTML=`<iframe id="soopFrame" src="${vod.url}" allow="autoplay; fullscreen" style="width:100%;height:100%;border:0"></iframe>`;
    let h=`<div class="bili-parts" id="biliParts"><div class="bili-parts-label">üü£ SOOP VOD${vod.note?' ‚Äî '+vod.note:''}</div><div style="display:flex;justify-content:center;padding:6px 0 0"><a href="${vod.url}" target="_blank" rel="noopener" style="font-size:11px;color:#9467ff;text-decoration:none">üü£ SOOPÏóêÏÑú Ïó¥Í∏∞</a></div></div>`;
    body.parentElement.insertBefore(createEl(h),body.nextSibling);
  }
}

async function searchVod(query){
  try{
    const teamM=query.match(/BLG\s*vs\s*(\S+)/i);
    const dateM=query.match(/(\d{4}-\d{2}-\d{2})/);
    const opp=teamM?teamM[1]:'';
    const dt=dateM?dateM[1]:'';
    // Use channel search only (web search returns 412)
    const keywords=[
      `BLG ${opp}`,
      `BLG vs ${opp}`,
      opp?`ÂìîÂì©ÂìîÂì© ${opp}`:null,
    ].filter(Boolean);
    let result={videoId:null,videoTitle:null,bvid:null,biliTitle:null};
    for(const kw of keywords){
      if(result.bvid)break;
      try{
        const d=await proxyFetchJSON(`https://api.bilibili.com/x/space/arc/search?mid=2071691173&ps=5&keyword=${encodeURIComponent(kw)}&order=pubdate`);
        if(d&&d.data&&d.data.list&&d.data.list.vlist){
          const vid=d.data.list.vlist.find(v=>{
            const t=v.title||'';
            if(t.includes('Ëã±ÈõÑËÅîÁõü')||t.includes('LOL')||t.includes('LPL')||t.includes('ËÅîËµõ'))return false;
            // Match by date if available
            if(dt){
              const mm=dt.substring(5,7).replace(/^0/,''),dd=dt.substring(8,10).replace(/^0/,'');
              if(t.includes(mm+'Êúà')&&t.includes(dd+'Êó•'))return true;
            }
            return t.includes('BLG')||t.includes('ÂìîÂì©ÂìîÂì©');
          });
          if(vid){result.bvid=vid.bvid;result.biliTitle=vid.title;}
        }
      }catch(e){}
    }
    if(result.bvid)return result;
    return null;
  }catch(e){
    console.error('VOD search error:',e);
    return null;
  }
}

function showVodFallback(query){
  const body=document.getElementById('vodBody');
  const title=document.getElementById('vodTitle');
  const ytLink=document.getElementById('vodYtLink');
  const biliLink=document.getElementById('vodBiliLink');
  const ytSearch=`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
  // Extract team/date for better Bilibili search
  const matchTeam=(query.match(/BLG vs (\w+)/)||[])[1]||'';
  const matchDate=(query.match(/(\d{4}-\d{2}-\d{2})/)||[])[1]||'';
  const biliQ=matchTeam&&matchDate?getBiliSearchUrl(matchTeam,matchDate,''):`https://search.bilibili.com/all?keyword=${encodeURIComponent('Êó†ÁïèÂ•ëÁ∫¶ BLG Êó†ÁïèÂ•ëÁ∫¶Ëµõ‰∫ã')}`;

  title.textContent='VODÎ•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§';
  body.innerHTML=`<div class="vod-loading"><div class="vod-error">
    <p style="margin-bottom:16px;color:#8585a8">ÏûêÎèô Í≤ÄÏÉâÏúºÎ°ú VODÎ•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.</p>
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <a href="${ytSearch}" target="_blank" style="color:#ff6b6b;font-size:13px;padding:8px 16px;border:1px solid rgba(255,0,0,.2);border-radius:8px;text-decoration:none;background:rgba(255,0,0,.05)">‚ñ∂ YouTubeÏóêÏÑú Í≤ÄÏÉâ</a>
      <a href="${biliQ}" target="_blank" style="color:#00a1d6;font-size:13px;padding:8px 16px;border:1px solid rgba(0,161,214,.2);border-radius:8px;text-decoration:none;background:rgba(0,161,214,.05)">‚ñ∂ BilibiliÏóêÏÑú Í≤ÄÏÉâ</a>
    </div>
  </div></div>`;
  ytLink.href=ytSearch;
  ytLink.style.display='flex';
  biliLink.href=biliQ;
  biliLink.style.display='flex';
}

function closeVod(){
  const overlay=document.getElementById('vodOverlay');
  const body=document.getElementById('vodBody');
  overlay.classList.remove('active');
  document.body.style.overflow='';
  body.innerHTML='';
  const parts=document.getElementById('biliParts');
  if(parts) parts.remove();
}

// ESC key to close
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeVod();const p=document.querySelector('.map-agents-popup');if(p)p.remove()}});
document.addEventListener('click',e=>{if(!e.target.closest('.mp')&&!e.target.closest('.map-agents-popup')){const p=document.querySelector('.map-agents-popup');if(p)p.remove()}});
</script>
</body>
</html>
