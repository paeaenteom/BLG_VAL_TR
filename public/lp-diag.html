<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>LP API ì§„ë‹¨</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0e1015;color:#e0e0e0;font-family:monospace;padding:20px;max-width:1400px;margin:0 auto}
h1{color:#4d8bff;margin-bottom:10px;font-size:18px}
.btn{background:#4d8bff;color:#fff;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;margin:4px}
.log{background:#1a1d24;padding:10px;border-radius:6px;margin:10px 0;white-space:pre-wrap;font-size:12px;max-height:600px;overflow:auto;line-height:1.6}
.ok{color:#4caf50}.err{color:#f44336}.warn{color:#ff9800}.info{color:#4d8bff}
textarea{width:100%;height:300px;background:#1a1d24;color:#e0e0e0;border:1px solid #333;font-size:11px;padding:8px;margin:6px 0}
</style>
</head>
<body>
<h1>ğŸ” Liquipedia API ì§„ë‹¨ ë„êµ¬</h1>
<p>APIê°€ ì‹¤ì œë¡œ ë­˜ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤</p>

<div style="margin:10px 0">
  <button class="btn" onclick="diagnose('VCT/2026/China_League/Kickoff')">VCT 2026 Kickoff ì§„ë‹¨</button>
  <button class="btn" onclick="diagnose('VCT/2025/China_League/Stage_2')">VCT 2025 Stage 2 ì§„ë‹¨</button>
  <button class="btn" onclick="diagnose('Champions/2023')">Champions 2023 ì§„ë‹¨</button>
  <button class="btn" onclick="diagnoseCustom()">ì»¤ìŠ¤í…€ í˜ì´ì§€</button>
  <input id="customPage" placeholder="í˜ì´ì§€ëª… (ì˜ˆ: VCT/2024/China_League/Stage_1/Group_Stage)" style="padding:6px;width:400px;background:#1a1d24;color:#e0e0e0;border:1px solid #333">
</div>

<div class="log" id="logBox">ì§„ë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘...</div>
<h3 style="margin-top:10px">Raw HTML (ì²˜ìŒ 5000ì)</h3>
<textarea id="rawHtml" readonly></textarea>
<h3>Agent ì´ë¯¸ì§€ íŒ¨í„´ ê²€ìƒ‰ ê²°ê³¼</h3>
<textarea id="agentResults" readonly></textarea>

<script>
const LIQ_API='https://liquipedia.net/valorant/api.php';
const logBox=document.getElementById('logBox');
const rawHtml=document.getElementById('rawHtml');
const agentResults=document.getElementById('agentResults');

function log(msg, cls=''){
  const d=document.createElement('div');
  if(cls)d.className=cls;
  d.textContent=msg;
  logBox.appendChild(d);
  logBox.scrollTop=logBox.scrollHeight;
}

function diagnoseCustom(){
  const p=document.getElementById('customPage').value.trim();
  if(p)diagnose(p);
}

async function diagnose(page){
  logBox.innerHTML='';
  rawHtml.value='';
  agentResults.value='';

  log(`ğŸ“¡ Fetching: ${page}`, 'info');
  
  try{
    const params=new URLSearchParams({action:'parse',page:page,prop:'text',format:'json',origin:'*'});
    const url=`${LIQ_API}?${params}`;
    log(`URL: ${url}`, '');
    
    const r=await fetch(url,{signal:AbortSignal.timeout(30000)});
    log(`HTTP Status: ${r.status}`, r.ok?'ok':'err');
    
    if(!r.ok){
      const txt=await r.text();
      log(`Error body: ${txt.slice(0,500)}`, 'err');
      return;
    }
    
    const data=await r.json();
    
    if(data.error){
      log(`API Error: ${JSON.stringify(data.error)}`, 'err');
      return;
    }
    
    if(!data.parse?.text?.['*']){
      log('âŒ data.parse.text["*"] ì—†ìŒ!', 'err');
      log(`Keys: ${JSON.stringify(Object.keys(data))}`, 'warn');
      if(data.parse) log(`parse keys: ${JSON.stringify(Object.keys(data.parse))}`, 'warn');
      return;
    }
    
    const html=data.parse.text['*'];
    log(`âœ… HTML ë°›ìŒ: ${html.length}ì`, 'ok');
    rawHtml.value=html.slice(0,5000);
    
    // ===== êµ¬ì¡° ë¶„ì„ =====
    log('','');
    log('â•â•â• HTML êµ¬ì¡° ë¶„ì„ â•â•â•', 'info');
    
    // 1. brkts-popup ì²´í¬
    const popupMatches=(html.match(/brkts-popup/g)||[]);
    log(`"brkts-popup" ë°œê²¬ íšŸìˆ˜: ${popupMatches.length}`, popupMatches.length>0?'ok':'err');
    
    const popupHeaderOpp=(html.match(/brkts-popup-header-opponent/g)||[]);
    log(`"brkts-popup-header-opponent": ${popupHeaderOpp.length}`, popupHeaderOpp.length>0?'ok':'warn');
    
    const popupBodyGame=(html.match(/brkts-popup-body-game/g)||[]);
    log(`"brkts-popup-body-game": ${popupBodyGame.length}`, popupBodyGame.length>0?'ok':'warn');
    
    // 2. VALORANT_Icon ì´ë¯¸ì§€ ì²´í¬
    const valIcons=(html.match(/VALORANT_Icon/gi)||[]);
    log(`"VALORANT_Icon" ì´ë¯¸ì§€: ${valIcons.length}`, valIcons.length>0?'ok':'err');
    
    // 3. êµ¬ì²´ì  ì—ì´ì „íŠ¸ ì´ë¯¸ì§€ íŒ¨í„´
    const agentImgs=[...html.matchAll(/<img[^>]*?src="([^"]*?VALORANT_Icon[^"]*?)"/gi)];
    log(`ì—ì´ì „íŠ¸ <img> íƒœê·¸: ${agentImgs.length}`, agentImgs.length>0?'ok':'err');
    
    if(agentImgs.length>0){
      const uniqueAgents=new Set();
      const lines=[];
      agentImgs.forEach(m=>{
        const src=m[1];
        const agentMatch=src.match(/\/([^/]+?)_(?:\d+\.\d+_)?VALORANT_Icon/i);
        if(agentMatch)uniqueAgents.add(agentMatch[1]);
        lines.push(src);
      });
      agentResults.value=`ê³ ìœ  ì—ì´ì „íŠ¸: ${[...uniqueAgents].join(', ')}\n\n--- ì´ë¯¸ì§€ URL ëª©ë¡ (ì²˜ìŒ 50ê°œ) ---\n${lines.slice(0,50).join('\n')}`;
      log(`ê³ ìœ  ì—ì´ì „íŠ¸: ${[...uniqueAgents].join(', ')}`, 'ok');
    }
    
    // 4. BLG ê´€ë ¨ ì²´í¬
    const blgCount=(html.match(/Bilibili.Gaming|BLG|bilibili/gi)||[]).length;
    log(`BLG ë©˜ì…˜: ${blgCount}`, blgCount>0?'ok':'warn');
    
    // 5. data-timestamp ì²´í¬
    const timestamps=(html.match(/data-timestamp/g)||[]);
    log(`data-timestamp: ${timestamps.length}`, timestamps.length>0?'ok':'warn');
    
    // 6. timer-object ì²´í¬
    const timers=(html.match(/timer-object/g)||[]);
    log(`timer-object: ${timers.length}`, timers.length>0?'ok':'warn');
    
    // 7. MVP ì²´í¬
    const mvps=(html.match(/MVP/g)||[]);
    log(`"MVP" ë©˜ì…˜: ${mvps.length}`, mvps.length>0?'ok':'warn');
    
    // 8. Map name ì²´í¬
    const maps=['Ascent','Bind','Breeze','Fracture','Haven','Icebox','Lotus','Pearl','Split','Sunset','Abyss','Corrode'];
    maps.forEach(m=>{
      const cnt=(html.match(new RegExp(`>${m}<|title="${m}"`, 'gi')||[])).length;
      if(cnt>0)log(`  ë§µ "${m}": ${cnt}íšŒ`, 'ok');
    });
    
    // 9. DOMParserë¡œ íŒŒì‹± ì‹œë„
    log('','');
    log('â•â•â• DOMParser íŒŒì‹± í…ŒìŠ¤íŠ¸ â•â•â•', 'info');
    
    const doc=new DOMParser().parseFromString(html,'text/html');
    
    const popups=doc.querySelectorAll('.brkts-popup');
    log(`DOMParser .brkts-popup: ${popups.length}`, popups.length>0?'ok':'err');
    
    if(popups.length>0){
      // ì²«ë²ˆì§¸ íŒì—… ë¶„ì„
      const p0=popups[0];
      log(`  ì²«ë²ˆì§¸ popup outerHTML ê¸¸ì´: ${p0.outerHTML.length}`, '');
      log(`  ì²«ë²ˆì§¸ popup textContent: "${p0.textContent.slice(0,200)}"`, '');
      
      const opps=p0.querySelectorAll('.brkts-popup-header-opponent');
      log(`  .brkts-popup-header-opponent: ${opps.length}`, opps.length>=2?'ok':'err');
      if(opps.length>=2){
        log(`    team1: "${opps[0].textContent.trim()}"`, '');
        log(`    team2: "${opps[1].textContent.trim()}"`, '');
      }
      
      const games=p0.querySelectorAll('.brkts-popup-body-game');
      log(`  .brkts-popup-body-game: ${games.length}`, games.length>0?'ok':'err');
      
      if(games.length>0){
        const g0=games[0];
        const imgs=g0.querySelectorAll('img');
        log(`    ì²«ë²ˆì§¸ game img ê°œìˆ˜: ${imgs.length}`, imgs.length>0?'ok':'err');
        imgs.forEach((img,i)=>{
          if(i<12){
            const src=img.getAttribute('src')||'';
            const alt=img.getAttribute('alt')||'';
            const title=img.getAttribute('title')||'';
            log(`      img[${i}]: src="${src.slice(-60)}" alt="${alt}" title="${title}"`, '');
          }
        });
      }
      
      // BLG ë§¤ì¹˜ ì°¾ê¸°
      let blgPopups=0;
      popups.forEach(p=>{
        if(/bilibili|blg/i.test(p.textContent))blgPopups++;
      });
      log(`  BLGê°€ í¬í•¨ëœ popup: ${blgPopups}`, blgPopups>0?'ok':'err');
    }
    
    // 10. ëª¨ë“  img íƒœê·¸ì—ì„œ ì—ì´ì „íŠ¸ ì•„ì´ì½˜ ì°¾ê¸°
    const allImgs=doc.querySelectorAll('img');
    let agentImgCount=0;
    allImgs.forEach(img=>{
      const src=(img.getAttribute('src')||'').toLowerCase();
      if(src.includes('valorant_icon'))agentImgCount++;
    });
    log(`DOMParser ì „ì²´ img ì¤‘ VALORANT_Icon: ${agentImgCount}`, agentImgCount>0?'ok':'err');
    
    log('','');
    log('â•â•â• ì§„ë‹¨ ì™„ë£Œ â•â•â•', 'info');
    
  }catch(e){
    log(`âŒ ì˜¤ë¥˜: ${e.message}`, 'err');
  }
}
</script>
</body>
</html>
